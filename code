# -*- coding: utf-8 -*-
import pandas as pd
import re
from datetime import datetime
import os
import unicodedata
from difflib import SequenceMatcher
# Importar las utilidades de 'openpyxl' para aplicar estilos
from openpyxl.styles import Alignment, Border, Side, Font, PatternFill
from openpyxl.utils import get_column_letter
import tkinter as tk
from tkinter import filedialog, messagebox
import tkinter.ttk as ttk # Para el selector de modelos
try:
    import ollama
except ImportError:
    ollama = None # Si no está instalado, definimos la variable como None para que no falle con NameError


# Se elimina la importación de xlsxwriter para evitar el error de ModuleNotFoundError

def analizar_temporalidad(texto):
    """
    Analiza la descripción de los hechos para determinar si la conducta
    está ocurriendo o ya ocurrió.
    
    Args:
        texto (str): Descripción de los hechos.
    
    Returns:
        str: "Ocurriendo", "Ya Ocurrió" o "Indeterminado".
    """
    texto_minusculas = texto.lower()
    
    palabras_ocurriendo = ['esta ocurriendo', 'está sucediendo', 'actualmente', 'a la fecha', 'persiste']
    palabras_ya_ocurrio = ['ocurrió', 'sucedió', 'pasó', 'en el pasado', 'realizó']

    if any(palabra in texto_minusculas for palabra in palabras_ocurriendo):
        return 'Ocurriendo'
    if any(palabra in texto_minusculas for palabra in palabras_ya_ocurrio):
        return 'Ya Ocurrió'
    
    return 'Indeterminado'

def aplicar_formato_excel(writer):
    """
    Aplica formato profesional a todas las hojas del archivo Excel generado.
    
    Args:
        writer (pd.ExcelWriter): El objeto ExcelWriter que contiene el libro.
    """
    
    wb = writer.book

    # --- 1. Definición de Estilos ---
    
    # Estilos de Borde
    borde_delgado = Side(border_style="thin", color="000000")
    borde_grueso = Side(border_style="thick", color="000000")
    
    borde_completo = Border(
        left=borde_delgado, 
        right=borde_delgado, 
        top=borde_delgado, 
        bottom=borde_delgado
    )
    borde_titulo_grueso = Border(
        left=borde_delgado, 
        right=borde_delgado, 
        top=borde_delgado, 
        bottom=borde_delgado,
        outline=borde_grueso # Borde exterior grueso
    )

    # Estilos de Alineación (Ajustar texto y centrado vertical es global)
    # Alineación horizontal: Centrado
    alineacion_centro_ajuste = Alignment(
        horizontal='center', 
        vertical='center', 
        wrap_text=True
    )
    # Alineación horizontal: Izquierda
    alineacion_izq_ajuste = Alignment(
        horizontal='left', 
        vertical='center', 
        wrap_text=True
    )

    # --- 2. Definición de Formatos de Hoja Específicos ---
    
    # Formato para la hoja "Resultados" (Columnas A-W)
    formato_resultados = {
        'A': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'B': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'C': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'D': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'E': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'F': {'ancho': 30.00, 'alineacion': alineacion_izq_ajuste},
        'G': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'H': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'I': {'ancho': 35.00, 'alineacion': alineacion_izq_ajuste},
        'J': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'K': {'ancho': 13.15, 'alineacion': alineacion_centro_ajuste},
        'L': {'ancho': 30.00, 'alineacion': alineacion_centro_ajuste},
        'M': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'N': {'ancho': 10.00, 'alineacion': alineacion_centro_ajuste},
        'O': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'P': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'Q': {'ancho': 27.00, 'alineacion': alineacion_centro_ajuste},
        'R': {'ancho': 37.00, 'alineacion': alineacion_centro_ajuste},
        'S': {'ancho': 37.00, 'alineacion': alineacion_centro_ajuste},
        'T': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'U': {'ancho': 34.00, 'alineacion': alineacion_centro_ajuste},
        'V': {'ancho': 50.00, 'alineacion': alineacion_izq_ajuste},
        'W': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'X': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'Y': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'Z': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'AA': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'AB': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
    }

    # Formato para la hoja "Priorización" (Columnas A-W)
    formato_priorización = {
        'A': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'B': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'C': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'D': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'E': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'F': {'ancho': 30.00, 'alineacion': alineacion_izq_ajuste},
        'G': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'H': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'I': {'ancho': 35.00, 'alineacion': alineacion_izq_ajuste},
        'J': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'K': {'ancho': 13.15, 'alineacion': alineacion_centro_ajuste},
        'L': {'ancho': 30.00, 'alineacion': alineacion_centro_ajuste},
        'M': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'N': {'ancho': 10.00, 'alineacion': alineacion_centro_ajuste},
        'O': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'P': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'Q': {'ancho': 27.00, 'alineacion': alineacion_centro_ajuste},
        'R': {'ancho': 37.00, 'alineacion': alineacion_centro_ajuste},
        'S': {'ancho': 37.00, 'alineacion': alineacion_centro_ajuste},
        'T': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'U': {'ancho': 34.00, 'alineacion': alineacion_centro_ajuste},
        'V': {'ancho': 50.00, 'alineacion': alineacion_izq_ajuste},
        'W': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'X': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'Y': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'Z': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'AA': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'AB': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
    }

    # Formato para la hoja "Investigación" (Columnas A-K)
    formato_investigacion = {
        'A': {'ancho': 23.00, 'alineacion': alineacion_centro_ajuste},
        'B': {'ancho': 29.00, 'alineacion': alineacion_centro_ajuste},
        'C': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'D': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'E': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'F': {'ancho': 80.00, 'alineacion': alineacion_izq_ajuste},
        'G': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'H': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'I': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'J': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'K': {'ancho': 26.15, 'alineacion': alineacion_centro_ajuste},
    }

    # --- 3. Aplicar Formato a CADA Hoja ---
    
    for hoja_nombre in wb.sheetnames:
        ws = wb[hoja_nombre]
        
        # Reglas Generales para todas las hojas
        ws.sheet_view.showGridLines = False  # Ocultar líneas de cuadrícula
        ws.freeze_panes = 'B2'             # Inmovilizar paneles en B2

        # Determinar el rango de datos
        max_fila = ws.max_row
        max_col_letra = get_column_letter(ws.max_column)
        rango_datos = f"A1:{max_col_letra}{max_fila}"

        # Aplicar formato de celda
        for fila in ws[rango_datos]:
            for celda in fila:
                # Aplicar bordes completos a todas las celdas con datos
                celda.border = borde_completo
                
                # Por defecto, aplicar alineación genérica (centro-ajuste)
                alineacion_actual = alineacion_centro_ajuste

                # Aplicar formato específico de "Resultados"
                if hoja_nombre in ['Resultados', 'Priorización']:
                    col_letra = get_column_letter(celda.column)
                    if col_letra in formato_resultados:
                        alineacion_actual = formato_resultados[col_letra]['alineacion']
                
                # Aplicar formato específico de "Investigación"
                if hoja_nombre == 'Investigación':
                    col_letra = get_column_letter(celda.column)
                    if col_letra in formato_investigacion:
                        # Usar la alineación específica de la columna
                        alineacion_actual = formato_investigacion[col_letra]['alineacion']
                
                # Asegurar alineación y ajuste de texto, esencial para el salto de línea (\n)
                celda.alignment = Alignment(
                    horizontal=alineacion_actual.horizontal, 
                    vertical='top', # Usar top para que las líneas inicien arriba
                    wrap_text=True
                )

        # Aplicar formato de anchos de columna
        if hoja_nombre == 'Resultados':
            for col_letra, formato in formato_resultados.items():
                ws.column_dimensions[col_letra].width = formato['ancho']

        if hoja_nombre == 'Priorización':
            for col_letra, formato in formato_resultados.items():
                ws.column_dimensions[col_letra].width = formato['ancho']
        
        if hoja_nombre == 'Investigación':
            for col_letra, formato in formato_investigacion.items():
                ws.column_dimensions[col_letra].width = formato['ancho']

        # Aplicar formato a la fila de Títulos (Fila 1)
        for celda in ws['1']:
            celda.border = borde_titulo_grueso
            # Asegurar que los títulos también estén centrados y ajustados
            celda.alignment = Alignment(
                horizontal='center', 
                vertical='center', 
                wrap_text=True
            )


def normalizar_texto(texto):
    """
    Normaliza el texto quitando acentos y convirtiéndolo a minúsculas.
    """
    if isinstance(texto, str):
        texto = texto.lower()
        texto = unicodedata.normalize('NFKD', texto).encode('ascii', 'ignore').decode('utf-8')
        texto = re.sub(r'[^a-z0-9\s]', '', texto)
        return texto
    return ""

def lematizar_artesanal(texto):
    """
    Paso 1: Convierte variaciones de palabras clave a su RAÍZ (Lema) conceptual.
    Esto permite que el algoritmo entienda que 'compró', 'adquirió' y 'comprando'
    significan lo mismo: 'COMPRA'.
    """
    # Diccionario de lemas: { 'RAIZ_CONCEPTUAL': ['variacion1', 'variacion2', ...] }
    # Ordenar las variaciones de más larga a más corta es buena práctica en regex
    # para evitar reemplazos parciales indeseados.
    diccionario_lemas = {
        'FACTURA': ['facturacion', 'facturas', 'factura', 'facture', 'facturo', 'facturando', 'facturado', 'expide', 'emite', 'entregar recibo', 'dar recibo'],
        'COMPRA': ['adquisicion', 'adquiere', 'adquirio', 'adquiriendo', 'compras', 'compro', 'compre', 'comprando', 'comprado'],
        'VENDE': ['comercializa', 'comercio', 'ventas', 'vende', 'vendio', 'vendiendo', 'vendido'],
        'DECLARA': ['declaracion', 'declaraciones', 'declaro', 'declara', 'declarando', 'declarado', 'presenta', 'presento', 'presentar'],
        'PAGA': ['consigna', 'consignar', 'consignado', 'cancelar', 'cancela', 'cancelado', 'pagos', 'pago', 'pagado', 'pagando'],
        'CONTRABANDO': ['ilegal', 'clandestino', 'contrabando'],
        'OMISO': ['omiso', 'omision', 'omitio', 'no presento', 'no declaro', 'sin declarar', 'nunca declaro'],
        'IVA': ['impuesto sobre las ventas', 'valor agregado', 'iva'],
        'RENTA': ['impuesto de renta', 'renta'],
        'INGRESOS': ['entradas de dinero', 'plata', 'ingresos', 'ganancias', 'dinero recibido'],
        'EXTRANJERO': ['fuera del pais', 'internacional', 'exterior', 'extranjero'],
        'EXOGENA': ['medios magneticos', 'informacion exogena', 'reporte de informacion', 'exogena'],
        'RUT': ['registro unico tributario', 'rut'],
        'ACTIVOS': ['bienes', 'propiedades', 'activos', 'patrimonio'],
        'PASIVOS': ['deudas', 'obligaciones', 'pasivos', 'prestamos'],
        'FICTICIO': ['simulado', 'irreal', 'fachada', 'ficticio', 'falso', 'falsa'],
        'RETENCION': ['retefuente', 'retencion en la fuente', 'retencion'],
        'TIMBRE': ['impuesto de timbre', 'timbre']
    }
    
    # El texto ya debe venir normalizado (minúsculas, sin tildes) de la función previa
    texto_procesado = texto 
    
    for raiz, variaciones in diccionario_lemas.items():
        # Creamos una expresión regular que busque cualquiera de las variaciones
        # \b asegura que sean palabras completas (evita reemplazar 'comprado' dentro de 'comprador')
        lista_regex = [re.escape(v) for v in variaciones]
        patron = r'\b(' + '|'.join(lista_regex) + r')\b'
        
        # Reemplazamos cualquier variación encontrada por la RAIZ
        texto_procesado = re.sub(patron, raiz, texto_procesado)
            
    return texto_procesado

def detectar_negacion_cercana(texto, termino, ventana=3):
    """
    Paso 2: Verifica si una palabra o frase está negada por su contexto inmediato (Windowing).
    Busca si existe una palabra negativa (no, nunca, sin...) en las 'ventana' posiciones
    anteriores al hallazgo del término.
    
    Args:
        texto (str): Texto completo donde buscar (ya lematizado).
        termino (str): La palabra clave o frase que se encontró.
        ventana (int): Cuántas palabras hacia atrás mirar.
    
    Returns:
        bool: True si está negada, False si es una afirmación positiva.
    """
    palabras_negacion = {'no', 'nunca', 'jamas', 'tampoco', 'sin', 'ni', 'ningun', 'ninguna', 'falso', 'niega'}
    
    # Tokenizamos (separamos por espacios) para poder contar posiciones
    tokens_texto = texto.split()
    tokens_termino = termino.split()
    
    if not tokens_termino: 
        return False
    
    primera_palabra_clave = tokens_termino[0]
    len_termino = len(tokens_termino)
    
    # Buscamos índices donde aparece la primera palabra del término
    indices = [i for i, x in enumerate(tokens_texto) if x == primera_palabra_clave]
    
    for i in indices:
        # Verificar si lo que sigue coincide con el término completo (para frases multi-palabra)
        # Esto evita confusiones si el término es "factura electronica" y solo encontramos "factura"
        if tokens_texto[i:i+len_termino] == tokens_termino:
            
            # Si el término mismo empieza con negación (ej: "no factura"), NO aplicamos la lógica
            # porque la negación es parte constitutiva de la regla, no una anulación.
            if primera_palabra_clave in palabras_negacion:
                return False
                
            # Definir el rango de la ventana hacia atrás
            inicio_ventana = max(0, i - ventana)
            ventana_previa = tokens_texto[inicio_ventana:i]
            
            # Verificar si alguna palabra de negación está en la ventana previa
            if any(neg in ventana_previa for neg in palabras_negacion):
                return True # ¡Está negada! (Ej: "NO" [ventana] "compra")
                
    return False

def calcular_densidad_dominio(texto):
    """
    Paso 6: Calcula qué "Dominio" (Tributario, Aduanero, Cambiario) es preponderante
    en el texto basándose en la frecuencia de vocabulario técnico exclusivo.
    
    Args:
        texto (str): Texto lematizado de los hechos.
        
    Returns:
        str: El nombre del dominio dominante ('Tributario', 'Aduanero', 'Cambiario') o None.
    """
    # Vocabulario exclusivo por dominio (palabras clave que definen el tema)
    vocabulario_dominios = {
        'Aduanero': [
            'MERCANCIA', 'APREHENSION', 'POLICIA FISCAL', 'POLFA', 'IMPORTACION', 'EXPORTACION', 
            'ARANCEL', 'LEVANTE', 'ZONA FRANCA', 'DEPOSITO ADUANERO', 'MANIFIESTO', 'CARGA', 
            'CONTENEDOR', 'PUERTO', 'AEROPUERTO', 'TRANSITO ADUANERO', 'USUARIO ADUANERO',
            'AGENCIA DE ADUANAS', 'DECLARANTE', 'VALOR EN ADUANA', 'ORIGEN', 'FLETES', 'CONTRABANDO'
        ],
        'Cambiario': [
            'DIVISAS', 'MONEDA EXTRANJERA', 'CANALIZAR', 'BANCO DE LA REPUBLICA', 'INTERMEDIARIOS', 
            'IMC', 'CUENTAS DE COMPENSACION', 'FORMULARIO', 'DECLARACION DE CAMBIO', 'REINTEGRO', 
            'REEMBOLSO', 'ENDEUDAMIENTO EXTERNO', 'INVERSION EXTRANJERA', 'PROFESIONAL DE CAMBIO',
            'COMPRA Y VENTA DE DIVISAS', 'DOLARES', 'EUROS', 'PESOS', 'TASA DE CAMBIO'
        ],
        'Tributario': [
            'IMPUESTO', 'RENTA', 'IVA', 'RETENCION', 'FACTURA', 'INGRESOS', 'PATRIMONIO', 
            'DECLARACION', 'EXOGENA', 'RUT', 'COSTOS', 'GASTOS', 'DEDUCCIONES', 'EVASION', 
            'OMISO', 'SANCION', 'INTERESES', 'CONTRIBUYENTE', 'RESPONSABLE', 'AGENTE RETENEDOR',
            'TIMBRE', 'CONSUMO'
        ]
    }
    
    conteos = {dom: 0 for dom in vocabulario_dominios}
    texto_upper = texto.upper()
    
    # Contar ocurrencias
    for dom, palabras in vocabulario_dominios.items():
        for palabra in palabras:
            # Buscamos la palabra exacta o como parte de otra
            if palabra in texto_upper:
                conteos[dom] += 1
                
    # Determinar ganador
    # Solo consideramos dominante si tiene una diferencia significativa o al menos > 0
    if not any(conteos.values()):
        return None
        
    dominio_ganador = max(conteos, key=conteos.get)
    puntaje_ganador = conteos[dominio_ganador]
    
    # Validación simple: El ganador debe tener al menos 2 palabras clave encontradas 
    # para considerarse un contexto fuerte y evitar falsos positivos por una sola palabra.
    if puntaje_ganador >= 2:
        return dominio_ganador
        
    return None


def es_similar(palabra1, palabra2, umbral=0.8):
    """
    Compara dos palabras y determina si son similares usando una métrica simple.
    """
    return SequenceMatcher(None, palabra1, palabra2).ratio() > umbral

def limpiar_identificacion(valor):
    """
    Limpia un valor de identificación para asegurar un cruce correcto.
    Elimina puntos, comas, guiones, espacios y sufijos decimales.
    """
    if pd.isna(valor):
        return ""
    
    # Convertir a string
    s = str(valor).strip()
    
    # Quitar sufijo .0 común en Excel
    if s.endswith('.0'):
        s = s[:-2]
        
    # Quitar caracteres especiales comunes en NITs y Cédulas (., -) y espacios
    s = re.sub(r'[.,\-\s]', '', s)
    
    return s.upper()

def generar_codigo_estadisticas(df):
    """
    Genera el código Python para realizar estadísticas y gráficas.
    
    Args:
        df (pd.DataFrame): DataFrame con los datos clasificados.
        
    Returns:
        str: Código Python completo para estadísticas.
    """
    
    codigo = """
# -*- coding: utf-8 -*-
import pandas as pd
import matplotlib.pyplot as plt
import os
import re

# Asegúrate de que este archivo exista en tu directorio local
RUTA_ARCHIVO = 'denuncias_procesadas.xlsx' 
NOMBRE_HOJA = 'Resultados' 

try:
    # Intenta leer la hoja de Resultados (la primera hoja)
    df = pd.read_excel(RUTA_ARCHIVO, sheet_name=NOMBRE_HOJA, engine='openpyxl')
    print("DataFrame cargado exitosamente.")
except FileNotFoundError:
    print(f"Error: El archivo '{RUTA_ARCHIVO}' no se encontró.")
    exit()
except ValueError:
    print(f"Error: La hoja '{NOMBRE_HOJA}' no se encontró en el archivo.")
    exit()

# ------------------------------------------------
# 1. ANÁLISIS DE PRIORIDAD (Sí/No)
# ------------------------------------------------
print("\\n--- Análisis de Prioridad ---")
prioridad_counts = df['Prioritaria'].value_counts()
print(prioridad_counts)

plt.figure(figsize=(6, 6))
plt.pie(prioridad_counts, labels=prioridad_counts.index, autopct='%1.1f%%', startangle=90, colors=['#4CAF50', '#FF9800'])
plt.title('Distribución de Denuncias Prioritarias')
plt.show()

# ------------------------------------------------
# 2. ANÁLISIS POR RÉGIMEN
# ------------------------------------------------
print("\\n--- Análisis por Régimen ---")
regimen_counts = df['Régimen'].value_counts()
print(regimen_counts)

plt.figure(figsize=(8, 5))
regimen_counts.plot(kind='bar', color=['#03A9F4', '#FF5722', '#8BC34A'])
plt.title('Número de Denuncias por Régimen')
plt.ylabel('Cantidad de Denuncias')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()

# ------------------------------------------------
# 3. TOP 5 CONDUCTAS SANCIONABLES
# ------------------------------------------------
print("\\n--- Top 5 Conductas Sancionables ---")
conducta_counts = df['Conducta Sancionable'].value_counts().nlargest(5)
print(conducta_counts)

plt.figure(figsize=(10, 6))
conducta_counts.plot(kind='barh', color='#9C27B0')
plt.title('Top 5 Conductas Sancionables más Comunes')
plt.xlabel('Cantidad de Denuncias')
plt.ylabel('Conducta Sancionable')
plt.gca().invert_yaxis()
plt.tight_layout()
plt.show()

# ------------------------------------------------
# 4. ANÁLISIS POR AÑO DE INVESTIGACIÓN
# ------------------------------------------------
print("\\n--- Análisis por Año de Investigación ---")

# La columna 'Año de Investigación' puede contener múltiples años separados por coma.
# Desnormalizamos los datos para contar cada año individualmente.
años = df['Año de Investigación'].astype(str).str.split(', ').explode()
años_validos = años[años != 'No determinado'].astype(int)

# Contar la frecuencia de cada año
frecuencia_años = años_validos.value_counts().sort_index()
print(frecuencia_años)

plt.figure(figsize=(10, 5))
frecuencia_años.plot(kind='line', marker='o', color='#F44336')
plt.title('Tendencia de Denuncias por Año Fiscal')
plt.xlabel('Año')
plt.ylabel('Número de Denuncias (Total de Vigencias)')
plt.grid(True, axis='y', linestyle='--')
plt.tight_layout()
plt.show()

# ------------------------------------------------
# 5. ANÁLISIS POR DEPARTAMENTO (TOP 5)
# ------------------------------------------------
print("\\n--- Top 5 Denuncias por Departamento ---")
departamento_counts = df['Departamento'].value_counts().nlargest(5)
print(departamento_counts)

plt.figure(figsize=(9, 5))
departamento_counts.plot(kind='bar', color='#FFC107')
plt.title('Top 5 Departamentos con más Denuncias')
plt.ylabel('Cantidad de Denuncias')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()

# ------------------------------------------------
# 6. ANÁLISIS POR CIUDAD (TOP 5)
# ------------------------------------------------
print("\\n--- Top 5 Denuncias por Ciudad ---")
ciudad_counts = df['Ciudad'].value_counts().nlargest(5)
print(ciudad_counts)

plt.figure(figsize=(9, 5))
ciudad_counts.plot(kind='bar', color='#00BCD4')
plt.title('Top 5 Ciudades con más Denuncias')
plt.ylabel('Cantidad de Denuncias')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()
    """
    return codigo



def seleccionar_modelo_ia(root):
    """
    Versión corrección GUI: Fuerza la visibilidad de la ventana y debug.
    """
    print("DEBUG: Verificando librería ollama...")
    if 'ollama' not in globals() or ollama is None:
        print("DEBUG: Librería ollama no detectada.")
        return None

    modelos_disponibles = []
    
    # Intento de conexión con Timeout corto para no congelar
    try:
        print("DEBUG: Conectando a Ollama (127.0.0.1)...")
        cliente = ollama.Client(host='http://127.0.0.1:11434')
        respuesta = cliente.list()
        
        lista = respuesta.get('models', [])
        for m in lista:
            if isinstance(m, dict):
                nombre = m.get('name', m.get('model', ''))
                if nombre: modelos_disponibles.append(nombre)
            else:
                modelos_disponibles.append(str(m))
        
        print(f"DEBUG: Modelos encontrados: {len(modelos_disponibles)}")
        
    except Exception as e:
        print(f"DEBUG: Error de conexión: {e}")
        # Intento fallback
        try:
            lista = ollama.list().get('models', [])
            for m in lista:
                nombre = m.get('name', m.get('model', '')) if isinstance(m, dict) else str(m)
                if nombre: modelos_disponibles.append(nombre)
        except:
            print("DEBUG: Falló intento secundario.")

    if not modelos_disponibles:
        # Usamos messagebox del sistema operativo directo si tkinter falla
        print("DEBUG: Sin modelos. Abriendo alerta.")
        messagebox.showwarning("Atención", "No se detectaron modelos en Ollama.")
        return None

    print("DEBUG: Creando ventana de selección...")
    
    # --- CAMBIOS CRÍTICOS DE VISIBILIDAD ---
    ventana_ia = tk.Toplevel(root)
    ventana_ia.title("Selección de Modelo IA")
    ventana_ia.geometry("400x250")
    
    # 1. No usar transient (desvincula la visibilidad de la ventana oculta)
    # ventana_ia.transient(root)  <-- COMENTADO/ELIMINADO
    
    # 2. Forzar al frente agresivamente
    ventana_ia.attributes('-topmost', True) 
    ventana_ia.lift()
    ventana_ia.focus_force()
    
    # 3. Bloquear interacción con otras ventanas
    ventana_ia.grab_set()
    
    seleccion = {"modelo": None}

    tk.Label(ventana_ia, text="CONEXIÓN EXITOSA", fg="green", font=("Arial", 10, "bold")).pack(pady=10)
    tk.Label(ventana_ia, text="Seleccione el modelo a utilizar:", font=("Arial", 11)).pack(pady=5)
    
    combo = ttk.Combobox(ventana_ia, values=modelos_disponibles, state="readonly", width=35)
    combo.pack(pady=10)
    if modelos_disponibles:
        combo.current(0)

    def confirmar():
        seleccion["modelo"] = combo.get()
        print(f"DEBUG: Usuario seleccionó {seleccion['modelo']}")
        ventana_ia.destroy()

    def cancelar():
        print("DEBUG: Usuario canceló.")
        seleccion["modelo"] = None
        ventana_ia.destroy()

    btn_frame = tk.Frame(ventana_ia)
    btn_frame.pack(pady=20)

    tk.Button(btn_frame, text="✅ EJECUTAR CON IA", command=confirmar, bg="#4CAF50", fg="white", font=("Arial", 10, "bold"), padx=15, pady=5).pack(side=tk.LEFT, padx=10)
    tk.Button(btn_frame, text="❌ SOLO CÓDIGO", command=cancelar, bg="#f44336", fg="white", font=("Arial", 10, "bold"), padx=15, pady=5).pack(side=tk.LEFT, padx=10)

    print("DEBUG: Esperando interacción del usuario...")
    
    # 4. Actualizar la GUI antes de esperar
    root.update()
    root.wait_window(ventana_ia)
    
    return seleccion["modelo"]




def consultar_contexto_ia(texto, modelo):
    """
    Envía el hecho denunciado a la IA para obtener contexto y años.
    No decide, solo enriquece.
    """
    prompt = f"""
    Actúa como un asistente experto en fiscalización tributaria y aduanera de Colombia. 
    Tu tarea NO es juzgar, sino extraer contexto técnico y años implícitos para ayudar a un algoritmo de clasificación.
    
    Analiza el siguiente hecho denunciado: "{texto}"

    1. Extrae términos técnicos clave que definan si es Tributario, Aduanero o Cambiario (Ej: "Omisión", "Contrabando", "Divisas").
    2. Identifica todos los años fiscales mencionados explícita o implícitamente (Ej: "año pasado" si hoy es 2025 sería 2024).

    Responde ESTRICTAMENTE con este formato:
    CONTEXTO: [Palabras clave técnicas separadas por espacio]
    AÑOS: [Año1, Año2, ...]
    """
    
    try:
        response = ollama.chat(model=modelo, messages=[
            {'role': 'user', 'content': prompt},
        ])
        respuesta = response['message']['content']
        
        # Procesamiento simple de la respuesta
        contexto_extra = ""
        anios_extra = []
        
        lines = respuesta.split('\n')
        for line in lines:
            if "CONTEXTO:" in line.upper():
                contexto_extra = line.split(':')[1].strip()
            if "AÑOS:" in line.upper():
                partes_anios = line.split(':')[1].replace('[','').replace(']','').split(',')
                for a in partes_anios:
                    clean_a = re.sub(r'\D', '', a) # Solo dígitos
                    if len(clean_a) == 4:
                        anios_extra.append(clean_a)
                        
        return contexto_extra, anios_extra
    except Exception as e:
        print(f"Error consultando IA: {e}")
        return "", []



def repartir_denuncias(df, auditores):
    """
    Reparte las denuncias entre los auditores.
    LÓGICA MULTI-DESTINO: Si una denuncia tiene múltiples regímenes (ej. "Tributario\nAduanero"),
    se asigna a un especialista de CADA rama involucrada.
    """
    
    # 1. Preparar columna de Prioridad para ordenar el reparto
    # Aseguramos que 'Si' (Prioritaria) sea procesada antes que 'No'
    df['Prioritaria'] = pd.Categorical(df['Prioritaria'], categories=['Si', 'No'], ordered=True)
    
    # Ordenamos el DF solo por prioridad. 
    # (Ya no agrupamos por régimen principal porque una fila puede pertenecer a varios grupos)
    df_reparto = df.sort_values(by=['Prioritaria'], ascending=[True])
    
    # 2. Estructuras de Control para el Reparto
    
    # Diccionario para acumular las filas asignadas a cada auditor
    asignaciones = {auditor: [] for auditor in auditores.keys()}
    
    # Agrupar auditores por especialidad para facilitar la selección
    # Estructura ejemplo: {'Tributario': ['Juan', 'Ana'], 'Aduanero': ['Olga'], ...}
    auditores_por_especialidad = {}
    for nombre, especialidad in auditores.items():
        if especialidad not in auditores_por_especialidad:
            auditores_por_especialidad[especialidad] = []
        auditores_por_especialidad[especialidad].append(nombre)
        
    # Contadores para mantener el turno (Round Robin) por cada especialidad
    # Esto asegura un reparto equitativo independiente dentro de cada grupo
    contadores_especialidad = {esp: 0 for esp in auditores_por_especialidad.keys()}
    
    # Serie para guardar los nombres de los auditores asignados en el DataFrame principal
    # Usamos el índice original del df para mapear correctamente
    auditor_asignado_serie = pd.Series([''] * len(df), index=df.index)

    # 3. Iterar denuncia por denuncia
    for index, row in df_reparto.iterrows():
        regimen_raw = str(row.get('Régimen', ''))
        
        # Obtener lista de regímenes involucrados en esta denuncia
        # Separamos por salto de línea (\n) que es como los unimos en la etapa de clasificación
        if not regimen_raw or regimen_raw.lower() in ['nan', 'none', '', 'no clasificado']:
            regimenes_denuncia = ['Tributario'] # Default si falla la clasificación
        else:
            regimenes_denuncia = [r.strip() for r in regimen_raw.split('\n') if r.strip()]
            
        # Si la lista está vacía tras limpiar
        if not regimenes_denuncia:
            regimenes_denuncia = ['Tributario']
            
        # Eliminamos duplicados para no asignar dos veces al mismo grupo si aparece repetido
        regimenes_denuncia = list(set(regimenes_denuncia))
        
        auditores_seleccionados_fila = []

        # LÓGICA CLAVE: Para CADA régimen detectado, asignamos un auditor de esa especialidad
        for reg in regimenes_denuncia:
            
            # Verificar si existe grupo de auditores para este régimen
            if reg not in auditores_por_especialidad:
                # Si el régimen es desconocido (ej. "Cambiario" pero no hay auditores definidos),
                # asignamos por defecto al grupo 'Tributario' para no perder la denuncia
                reg_destino = 'Tributario'
            else:
                reg_destino = reg
                
            # Obtener el grupo de auditores disponible
            grupo = auditores_por_especialidad.get(reg_destino)
            
            if grupo:
                # Obtener el índice del turno actual para esta especialidad
                idx = contadores_especialidad[reg_destino]
                
                # Seleccionar al auditor que le toca el turno
                auditor_elegido = grupo[idx]
                
                # Guardar la asignación (La fila completa se va a la hoja de este auditor)
                asignaciones[auditor_elegido].append(row)
                auditores_seleccionados_fila.append(auditor_elegido)
                
                # Avanzar el turno (cíclico) para el siguiente reparto de este régimen
                contadores_especialidad[reg_destino] = (idx + 1) % len(grupo)
        
        # Guardar los nombres asignados en la columna resumen del excel maestro
        # Si fue asignado a varios (ej. Juan y Olga), aparecerán separados por salto de línea
        auditor_asignado_serie[index] = '\n'.join(auditores_seleccionados_fila)

    # 4. Convertir las listas a DataFrames para devolver
    df_asignaciones = {}
    for auditor, data in asignaciones.items():
        if data:
            df_asignaciones[auditor] = pd.DataFrame(data)
        else:
            # Crear hoja vacía con encabezados si no tiene asignaciones para que el archivo no falle
            df_asignaciones[auditor] = pd.DataFrame(columns=df.columns)

    return df_asignaciones, auditor_asignado_serie


def identificar_patrones_investigacion(df):
    """
    Busca patrones de mención de denunciados (por Documento y Nombre/Razón Social)
    en los hechos denunciados de otras filas, generando un DataFrame para Investigación.
    """
    
    patrones_investigacion = []
    
    # 1. Normalizar todos los identificadores únicos y asegurar que sean strings
    # Asegurar que todas las columnas de identificación sean strings para la búsqueda
    df['Documento Denunciado'] = df['Documento Denunciado'].astype(str)
    df['Nombre/Razon Social Denunciado'] = df['Nombre/Razon Social Denunciado'].astype(str)
    df['Descripción de los Hechos_str'] = df['Descripción de los Hechos'].astype(str)
    
    df['Denunciado_Identificador'] = df['Documento Denunciado'] + " / " + df['Nombre/Razon Social Denunciado']
    
    # Crear un diccionario para mapear identificadores a las denuncias donde son principales
    identificador_a_denuncia_principal = {}
    for index, row in df.iterrows():
        identificador = row['Denunciado_Identificador']
        if identificador not in identificador_a_denuncia_principal:
            # Almacenar la denuncia principal (identificada por columnas)
            identificador_a_denuncia_principal[identificador] = {
                'Denuncia_Principal': row.to_dict(),
                'Menciones_Hechos': []
            }
        
    # 2. Buscar menciones en los Hechos Denunciados
    for index_mencion, row_mencion in df.iterrows():
        # Usamos la columna string
        hechos_normalizados = normalizar_texto(row_mencion['Descripción de los Hechos_str'])
        
        for identificador, data in identificador_a_denuncia_principal.items():
            # --- CORRECCIÓN AQUÍ ---
            # Usamos maxsplit=1 para evitar errores si el nombre contiene " / "
            partes = identificador.split(' / ', 1)
            
            if len(partes) == 2:
                doc, nombre = partes
            else:
                # Fallback por si acaso el identificador está mal formado
                doc = partes[0]
                nombre = "" 
            # -----------------------
            
            # Normalizar el nombre para la búsqueda en los hechos
            nombre_normalizado = normalizar_texto(nombre)
            
            # Determinar el patrón encontrado (Patrón será el documento o el nombre)
            patron_encontrado = ""
            
            # Buscar coincidencia del documento O el nombre en los hechos
            # Validamos que 'nombre' no esté vacío para evitar falsos positivos
            if doc in hechos_normalizados:
                patron_encontrado = doc
            elif nombre and len(nombre) > 3 and nombre_normalizado in hechos_normalizados:
                 # Se agrega validación de longitud > 3 para evitar coincidencias con nombres muy cortos o vacíos
                 patron_encontrado = nombre # Usamos el nombre original sin normalizar para el reporte
            
            if patron_encontrado and row_mencion['Número Radicación'] != data['Denuncia_Principal']['Número Radicación']:
                
                # Almacenar la denuncia donde fue mencionado
                mencion_data = row_mencion.to_dict()
                mencion_data['PATRÓN'] = patron_encontrado # Almacenar el patrón
                data['Menciones_Hechos'].append(mencion_data)

    # 3. Estructurar el DataFrame de Investigación
    
    INVESTIGACION_COLS = [
        'TIPO_REGISTRO', 
        'DOCUMENTO_IDENTIFICADOR', 
        'NOMBRE_IDENTIFICADOR',
        'PATRÓN', # NUEVA COLUMNA
        'Número Radicación', 
        'Descripción de los Hechos', 
        'Régimen', 
        'Conducta Sancionable',
        'Impuesto / Infracción', # COLUMNA REUBICADA
        'Año de Investigación', # COLUMNA REUBICADA
        'Prioritaria'
    ]
    investigacion_rows = []

    # Procesar denuncias donde el identificado es PRINCIPAL (columna)
    for identificador, data in identificador_a_denuncia_principal.items():
        if data['Menciones_Hechos']:
            # Caso 1: Patrón identificado (Principal + Menciones)
            
            # Denuncia Principal (la fila donde está identificado en las columnas)
            principal = data['Denuncia_Principal']
            investigacion_rows.append({
                'TIPO_REGISTRO': 'PATRÓN ENCONTRADO (Principal)',
                'DOCUMENTO_IDENTIFICADOR': principal['Documento Denunciado'],
                'NOMBRE_IDENTIFICADOR': principal['Nombre/Razon Social Denunciado'],
                'PATRÓN': principal['Documento Denunciado'], # El patrón es el Documento Denunciado en la principal
                'Número Radicación': principal['Número Radicación'],
                'Descripción de los Hechos': principal['Descripción de los Hechos'],
                'Régimen': principal['Régimen'],
                'Conducta Sancionable': principal['Conducta Sancionable'],
                'Impuesto / Infracción': principal['Impuesto / Infracción'],
                'Año de Investigación': principal['Año de Investigación'],
                'Prioritaria': principal['Prioritaria']
            })
            
            # Denuncias donde fue mencionado (ordenadas por Prioridad)
            menciones_df = pd.DataFrame(data['Menciones_Hechos'])
            
            # Asegurarse de que 'Prioritaria' sea categórica antes de ordenar
            menciones_df['Prioritaria'] = pd.Categorical(menciones_df['Prioritaria'], categories=['Si', 'No'], ordered=True)
            menciones_df = menciones_df.sort_values(by='Prioritaria', ascending=True)
            
            for _, mencion in menciones_df.iterrows():
                
                investigacion_rows.append({
                    'TIPO_REGISTRO': 'MENCIONADO EN HECHOS (Relacionada)',
                    'DOCUMENTO_IDENTIFICADOR': mencion['Documento Denunciado'], 
                    'NOMBRE_IDENTIFICADOR': mencion['Nombre/Razon Social Denunciado'],
                    'PATRÓN': mencion['PATRÓN'], # Usamos el patrón encontrado en el paso 2
                    'Número Radicación': mencion['Número Radicación'],
                    'Descripción de los Hechos': mencion['Descripción de los Hechos'],
                    'Régimen': mencion['Régimen'],
                    'Conducta Sancionable': mencion['Conducta Sancionable'],
                    'Impuesto / Infracción': mencion['Impuesto / Infracción'],
                    'Año de Investigación': mencion['Año de Investigación'],
                    'Prioritaria': mencion['Prioritaria']
                })
            
            investigacion_rows.append({col: '' for col in INVESTIGACION_COLS}) # Separador
    
    # 5. Generar el DataFrame final
    df_investigacion = pd.DataFrame(investigacion_rows, columns=INVESTIGACION_COLS)
    
    return df_investigacion

    # =============================================================================
# FRAGMENTO 1: BASE DE CONOCIMIENTO (DEFINICIONES)
# =============================================================================

# Definiciones extraídas de la Matriz de Lectura (Tributario, Aduanero, Cambiario)
DEFINICIONES_CONDUCTAS = {
    # --- TRIBUTARIO ---
    'evade impuestos': "Realizar un conjunto de acciones ilegales y fraudulentas que buscan evitar la obligación formal y sustancial de declarar los diferentes impuestos, asi como ejecutar maniobras para bajar artificialmente la base imponible o ejecutar estrategias para pagar menos impuestos",
    'extemporaneidad en la presentacion de las declaraciones': "Presentar una declaración tributaria (como Renta, IVA, Impuesto al Consumo o Retención en la Fuente) después de la fecha límite establecida en el calendario tributario.",
    'no declara activos en el exterior': "Omitir la presentación de la declaración de activos en el exterior estando obligado a ello por poseer bienes fuera del país.",
    'no declara impuesto al consumo': "No presentar la declaración y pago del Impuesto Nacional al Consumo por la prestación de servicios o venta de bienes específicos.",
    'no declara impuesto al patrimonio': "Omitir la presentación de la declaración del Impuesto al Patrimonio, un gravamen que recae sobre el valor neto de los bienes y/o derechos de personas naturales.",
    'no declara iva': "Omitir la presentación de la declaración de IVA ante la autoridad fiscal, aun cuando el contribuyente está inscrito en la responsabilidad correspondiente.",
    'no declara regimen simple de tributacion': "Omitir la presentación de la declaración anual consolidada del Impuesto Unificado bajo el Régimen Simple de Tributación (SIMPLE).",
    'no declara renta': "Omisión voluntaria o involuntaria de la obligación de presentar la declaración del impuesto sobre la renta y complementarios ante la autoridad tributaria.",
    'no declara retencion en la fuente': "Incumplir el deber de presentar la declaración periódica de Retención en la Fuente estando obligado a hacerlo.",
    'no efectua retencion en la fuente': "No aplicar o no practicar el descuento de impuestos (retención) que la ley exige realizar a un tercero al momento de un pago o abono en cuenta.",
    'no paga impuesto de timbre': "Omitir la obligación de retener el impuesto que grava la suscripción de ciertos documentos o la realización de transacciones específicas.",
    'no presenta informes precios de transferencia': "Omitir la presentación de la documentación, informes o declaraciones específicas requeridas a aquellos contribuyentes que realizan operaciones con vinculados.",
    'inexacto': "Incluir datos falsos, incompletos o manipulados en las declaraciones tributarias o reportes de información.",
    'cobra tarifas en iva diferentes': "Aplicar un porcentaje de Impuesto al Valor Agregado (IVA) a una venta o servicio que no corresponde con la tarifa oficial.",
    'consigna ingresos propios en cuentas de terceros': "Utilizar cuentas bancarias de otras personas para depositar ingresos propios con la intención de ocultar el origen de los fondos.",
    'dinero depositados en paraisos fiscales': "Transferir o mantener fondos en países o territorios que ofrecen regímenes fiscales de baja o nula imposición.",
    'doble facturacion': "Expedir dos facturas por la venta de un mismo bien o servicio, de las cuales solo una es reportada oficialmente.",
    'incluye costos no procedentes': "Deducir de la base gravable gastos que no cumplen con los requisitos legales, no tienen relación de causalidad o no están soportados.",
    'incluye pasivos inexistentes': "Declarar deudas u obligaciones que no son reales o que ya han sido pagadas, con el fin de disminuir el patrimonio.",
    'no declara retención en la fuente correctamente': "Declarar valores de retención en la fuente practicada que no coinciden con la realidad (bases, tarifas o montos inferiores).",
    'no declara impuesto de timbre correctamente': "Consignar en la declaración valores del Impuesto de Timbre que no reflejan el monto real causado.",
    'omite activos': "No incluir la totalidad de los bienes, derechos y recursos que posee una persona o empresa en su declaración de renta y patrimonio.",
    'omite ingresos': "No declarar la totalidad de los ingresos o entradas de dinero obtenidas en un período fiscal.",
    'costos o gastos originados con proveedor ficticio': "Incluir costos o gastos que provienen de transacciones con un proveedor inexistente, de fachada o insolvente.",
    'retiene en la fuente a tarifas diferentes a las legales': "Aplicar a una transacción un porcentaje de retención que no es el que la ley establece.",
    'solicita beneficios fiscales inexistentes': "Aplicar deducciones, exenciones o descuentos tributarios que no están vigentes o no aplican.",
    'inexactitud declaracion ingresos y patrimonio': "Consignar en la declaración de Renta y Complementarios datos o cifras que no son verdaderas respecto a ingresos y patrimonio.",
    'utiliza documentos presuntamente falsos': "Usar facturas, recibos o documentos no legítimos o alterados para soportar costos, gastos o impuestos.",
    'no factura': "No expedir la factura de venta o documento equivalente para soportar una transacción económica.",
    'factura sin requisitos': "Expedir facturas de venta que no cumplen con todos los requerimientos legales para su validez.",
    'errores envio informacion exogena': "Incluir datos inconsistentes, incompletos o erróneos en los reportes anuales obligatorios (medios magnéticos).",
    'inscrito en el regimen de iva que no corresponde': "Cumplir requisitos para ser responsable de IVA y no actualizar el RUT acorde a ello.",
    'lleva doble contabilidad': "Mantener dos sistemas de registro contable, uno real interno y otro falso para autoridades fiscales.",
    'no contabiliza todas sus operaciones': "Incumplir la obligación de registrar completa y verazmente la totalidad de las transacciones económicas.",
    'no esta inscrito en el rut': "Incumplir la obligación formal de inscribirse en el Registro Unico Tributario.",
    'reportado sin vinculo comercial en exogena por terceros': "Inconsistencia cuando un tercero reporta comercialmente a un contribuyente sin haber tenido relación real.",
    'no expide certificados de retencion': "Omitir la obligación de entregar el documento que certifica el valor retenido a quien se le practicó la retención.",
    'no lleva contabilidad': "No tener libros contables o mantenerlos incompletos o desactualizados.",
    'proveedor ficticio': "Registrar operaciones con facturas de un proveedor que no existe o no realizó la venta.",
    'solicita devoluciones improcedentes': "Solicitar devolución de saldos a favor que no corresponden o fueron generados irregularmente.",
    'no reporta información exógena': "Omitir el deber de suministrar los reportes anuales o periódicos de información tributaria.",

    # --- ADUANERO ---
    'contrabando abierto': "Ingresar o sacar mercancías del territorio nacional de forma ilegal, evadiendo el control aduanero.",
    'ejercer actividades aduaneras sin autorización ': "Realizar importación, exportación o trámites sin los permisos y licencias requeridos.",
    'el valor declarado de la mercancia no corresponde': "Declarar un precio de mercancía inferior al real (sub-facturación) para disminuir impuestos.",
    'errada clasificacion arancelaria': "Asignar un código arancelario incorrecto a la mercancía importada o exportada.",
    'exportacion ficticia': "Simular una venta al exterior que no ocurre para obtener beneficios fiscales o aduaneros.",
    'incumplimiento de requisitos previos': "No cumplir con permisos, registros o licencias obligatorios para importar o exportar.",
    'incumplimiento de reglamentos tecnicos': "No cumplir con normas técnicas, etiquetado o reglamentos de seguridad de la mercancía.",
    'suministrar informacion o documentacion inexacta o irregular': "Entregar documentos falsos o datos erróneos a la autoridad aduanera sobre la mercancía.",

    # --- CAMBIARIO ---
    'canalizar operaciones diferentes a las autorizadas': "Utilizar un canal cambiario autorizado para una operación distinta a la permitida.",
    'ejercer actividades cambiarias sin autorización': "Manejo profesional de divisas (compra/venta) sin permiso o licencia.",
    'extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados': "Compensar obligaciones de comercio exterior o deuda usando mecanismos no autorizados.",
    'no presentar o no transmitir al banco de la república las operaciones': "Omitir reportar al Banco Central las transacciones de divisas realizadas.",
    'no presentar o no transmitir información exogena cambiaria a la dian': "Omitir reportar a la DIAN los datos detallados sobre operaciones de cambio.",
    'pagar o recibir pagos a través del mercado no cambiario operaciones canalizables': "Usar mercado negro o canales informales para operaciones que exigen canal formal.",
    'realizar operaciones de compra y venta de divisas sin autorizacion': "Transacciones de divisas fuera de los Intermediarios del Mercado Cambiario autorizados.",
    'transmitir al banco de la república en forma extemporánea': "Reportar operaciones cambiarias al Banco de la República fuera de los plazos legales.",
    'transmitir a la dian información exogena cambiaria en forma extemporánea': "Enviar información exógena cambiaria a la DIAN después de la fecha límite."
}




def procesar_denuncias(ruta_archivo_entrada, ruta_archivo_salida, ruta_archivo_beneficio):
    """
    Procesa un archivo de denuncias en formato Excel.
    """

    # --- BLOQUE DE PREGUNTA IA (CORREGIDO) ---
    print("DEBUG: Iniciando bloque de selección de IA...")
    modelo_seleccionado = None
    usar_ia = False

    try:
        # Creamos la raíz temporal
        root_selector = tk.Tk()
        root_selector.withdraw() # Ocultar la ventana principal inmediatamente
        
        # Forzar actualización para que el sistema reconozca la ventana
        root_selector.update()
        
        # Llamamos a la función de selección
        modelo_seleccionado = seleccionar_modelo_ia(root_selector)
        
        # --- CORRECCIÓN CLAVE: Cerrar explícitamente el loop de eventos ---
        root_selector.quit()   # Detiene el mainloop si estuviera corriendo
        root_selector.destroy() # Destruye la ventana y libera recursos
        # -----------------------------------------------------------------
        
        usar_ia = True if modelo_seleccionado else False
        
        if usar_ia:
            print(f"\n>>> MODO IA ACTIVADO: Modelo '{modelo_seleccionado}' <<<\n")
        else:
            print("\n>>> MODO ESTÁNDAR: Ejecución sin IA (Usuario canceló o no seleccionó) <<<\n")

    except Exception as e:
        print(f"Error CRÍTICO al abrir selector (se continuará sin IA): {e}")
        usar_ia = False
        modelo_seleccionado = None
        # Intentar destruir por seguridad si falló algo
        try:
            root_selector.destroy()
        except:
            pass

    print("DEBUG: Ventana IA cerrada correctamente. Continuando con la carga de variables...")
    
            
    
    # Definición de la estructura de auditores
    # El usuario debe reemplazar 'Auditor X' y 'Tributario' según sea necesario.
    AUDITORES = {
        'Anyela Rodriguez': 'Tributario',
        'Ruth Peña': 'Tributario',
        'Lorena Bohorquez': 'Tributario',
        'Gloria Tamayo': 'Tributario',
        'Ana Castellanos': 'Tributario',
        'Rafael Ordoñez': 'Tributario',
        'Olga Medina': 'Aduanero',
        'Carlos Rubiano': 'Aduanero',
        'Jefferson Romero': 'Tributario',
        'Juan Turriago': 'Tributario',
        'Maria Franco': 'Tributario',
        'Juan Clavijo': 'Tributario',
        'Juan Franco': 'Tributario',
        'Lina Ceballos': 'Tributario',
        'Jose Uribe': 'Tributario',
        'Javier Chacon': 'Tributario',
        'Carlos Martinez': 'Tributario',
        'Auditor 1': 'Cambiario',
    }


   



    # =======================================================================================
    # SECCIÓN DE REGLAS ANIDADAS (Dependencias entre Conductas Sancionables)
    # 
    # Estructura: 
    # {
    #     'CONDUCTA_PRINCIPAL': {
    #         'Regimen': 'REGIMEN_ANIDADO',
    #         'Conducta': 'CONDUCTA_ANIDADA_PADRE',
    #         'Conducta Sancionable': 'CONDUCTA_ANIDADA',
    #         'Impuesto / Infracción': 'IMPUESTO_ANIDADO',
    #         'Normatividad': 'NORMATIVIDAD_ANIDADA',
    #         'Puntos de Auditoria': 'PUNTOS_ANIDADOS'
    #     }
    # }
    # =======================================================================================
    
    # ----------------------------------------------------------------------------------------
    # NOTA: Los valores aquí DEBEN ser EXTRAÍDOS TEXTUALMENTE del diccionario reglas_conclusion
    # para garantizar la fidelidad.
    # ----------------------------------------------------------------------------------------
    
    REGLAS_ANIDADAS = {
        'Reportado sin vinculo comercial en exogena por terceros': {
            'Regimen': 'Tributario',
            'Conducta': 'Obligaciones diferentes a declarar y pagar',
            'Conducta Sancionable': 'Incluye costos no procedentes',
            'Impuesto / Infracción': 'Renta y Complementarios',
            'Normatividad': 'Art. 631 E.T. / Art. 107 E.T.',
            'Puntos de Auditoria': 'Verificación de costos y deducciones por honorarios no causados.'
        }, 
        'No factura': {
            'Regimen': 'Tributario',
            'Conducta': 'Facturación',
            'Conducta Sancionable': 'Omite Ingresos',
            'Impuesto / Infracción': 'Renta y Complementarios',
            'Normatividad': 'Art. 657 E.T. / Art. 647 E.T.',
            'Puntos de Auditoria': 'Verificación de ingresos reportados vs. reportados por terceros.'
        }
    }

   # --- mapa de Beneficios (NIT -> AÑO -> DATOS) ---
    beneficio_map = {}
    
    # Solo procesamos si hay una ruta de archivo válida
    if ruta_archivo_beneficio:
        try:
            df_beneficio = pd.read_excel(ruta_archivo_beneficio, engine='openpyxl')
            
            # Búsqueda robusta de la columna NIT
            col_nit = 'NIT'
            if 'NIT' not in df_beneficio.columns:
                for col in df_beneficio.columns:
                    if 'nit' in str(col).lower():
                        col_nit = col
                        break
            
            # Búsqueda robusta de la columna Dirección Seccional (Normalizada)
            col_direccion = None
            for col in df_beneficio.columns:
                # Normalizamos el nombre de la columna para buscar coincidencia
                col_norm = normalizar_texto(str(col))
                # Buscamos palabras clave como 'direccion' y 'seccional' o similar
                if 'direccion' in col_norm and 'seccional' in col_norm:
                    col_direccion = col
                    break
            
            for _, row_ben in df_beneficio.iterrows():
                nit_raw = row_ben.get(col_nit, '')
                nit_limpio = limpiar_identificacion(nit_raw)
                
                if nit_limpio:
                    # Obtener el Año Gravable
                    anio_gravable = str(row_ben.get('Año gravable', '')).strip()
                    if anio_gravable.endswith('.0'):
                        anio_gravable = anio_gravable[:-2]

                    # Procesar fecha presentación
                    raw_presentacion = str(row_ben.get('Fecha de presentación año actual', '')).strip()
                    if raw_presentacion.endswith('.0'):
                        raw_presentacion = raw_presentacion[:-2]
                    
                    if len(raw_presentacion) == 8 and raw_presentacion.isdigit():
                        fecha_presentacion = f"{raw_presentacion[:4]}-{raw_presentacion[4:6]}-{raw_presentacion[6:]}"
                    else:
                        fecha_presentacion = raw_presentacion.split(' ')[0]

                    # Procesar Fecha de Firmeza
                    fecha_firmeza = str(row_ben.get('Fecha de firmeza', '')).strip()
                    if fecha_firmeza.endswith('.0'):
                        fecha_firmeza = fecha_firmeza[:-2]
                    fecha_firmeza = fecha_firmeza.split(' ')[0]

                    # Obtener Dirección Seccional si la columna fue encontrada
                    dir_seccional = str(row_ben.get(col_direccion, '')) if col_direccion else ''

                    texto_dato = f"{anio_gravable}\nPresentada: {fecha_presentacion}"
                    
                    # Inicializar diccionario del NIT si no existe
                    if nit_limpio not in beneficio_map:
                        beneficio_map[nit_limpio] = {}
                    
                    # Guardar datos organizados por año
                    beneficio_map[nit_limpio][anio_gravable] = {
                        'texto': texto_dato,
                        'firmeza': fecha_firmeza,
                        'direccion': dir_seccional, # Nuevo campo
                        'existe': True
                    }
                
        except Exception as e:
            print(f"Advertencia: No se pudo cargar el archivo de Beneficio de Auditoría: {e}")
    else:
        print("Se omitió el cruce de información de Beneficio de Auditoría.")

    REGLA_PRINCIPAL_AUXILIAR = list(REGLAS_ANIDADAS.keys())[0] if REGLAS_ANIDADAS else None
    
    print(f"--- Intentando leer archivo: {os.path.basename(ruta_archivo_entrada)} ---")
    
    try:
        # Cargamos el Excel
        df = pd.read_excel(ruta_archivo_entrada, engine='openpyxl', dtype={'Fecha Hechos': str})
        
        # Limpieza de encabezados
        df.columns = df.columns.str.strip()
        
        # Validación de columna clave
        if 'Documento Denunciado' not in df.columns:
            col_found = False
            for col in df.columns:
                if 'documento' in str(col).lower() and 'denunciado' in str(col).lower():
                    df.rename(columns={col: 'Documento Denunciado'}, inplace=True)
                    col_found = True
                    break
            if not col_found:
                print("ERROR: No se encontró la columna 'Documento Denunciado'.")
                return

        print(f"✅ EXITO: Datos cargados. Filas a procesar: {len(df)}", flush=True)
        print("DEBUG: Leyendo reglas de negocio (Espere un momento, no cierre la ventana)...", flush=True)


    except Exception as e:
        print(f"❌ ERROR CRÍTICO AL LEER EL ARCHIVO: {e}", flush=True)
        return

        print("DEBUG: Cargando reglas de negocio y sinónimos (Espere un momento)...", flush=True)


    



        # Diccionario de sinónimos para hacer la búsqueda más robusta
        sinonimos = {
            'reportar': ['reportar', 'transmitir', 'enviar', 'remitir', 'comunicar', 'reportado'],
            'informacion': ['informacion', 'datos', 'reporte', 'exogena', 'informacion'],
            'cambiario': ['cambiario', 'divisas', 'moneda'],
            'pagar': ['pagar', 'consignar', 'transferir', 'cancelar'],
            'mercancia': ['mercancia', 'productos', 'bienes', 'articulos'],
            'documentacion': ['documentacion', 'documentos', 'papeles'],
            'importar': ['importar', 'importando'],
            'exportar': ['exportar', 'exportando'],
            'canalizar': ['canalizar', 'canaliza'],
            'transmitir': ['transmitir', 'transmitio', 'enviando'],
            'recibir': ['recibir', 'recibio'],
            'evadir': ['evadir', 'evasion', 'evadiendo'],
            'ingresos': ['ingresos', 'ganancias', 'rentas'],
            'gastos': ['gastos', 'costos', 'deducciones'],
            'contrabando': ['contrabando', 'mercancia', 'ilegal', 'extranjera'],
            'omiso': ['no presento', 'no ha presentado', 'se encuentra omiso', 'no ha cumplido con el deber de declarar', 'no ha declarado', 'falta por declarar','dejo de pagar'],
            'inscribir': ['inscrito', 'inscribirse']
        }

       # Diccionario de palabras clave para la clasificación completa.
       # Contexto: Palabras que acompañan el hecho (15 pts c/u) 
       # Refuerzo: Detalles menores (5 pts c/u)

        reglas_conclusion = {
    'Aduanero': {
        'reglas': {
            'contrabando abierto': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Contrabando abierto',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Art. 294 y 295 del Decreto 1165 de 2019',
                'Puntos de Auditoria': 'Proponer acción de control que permita establecer la legal procedencia de las mercancías',
                'palabras_clave': [{'contrabando', 'mercancia de contrabando', 'mercancia', 'ingresan de contrabando', 'ingresa contrabando', 'mercancia iliegal', 'precios muy bajos', 'precios bajos', 'bajos precios'}],
                'patrones_regex': [
                    r"contrabando\s+abierto",
                    r"mercanc[ií]a\s+sin\s+documentos",
                    r"ingreso\s+ilegal\s+de\s+mercanc[ií]a"
                ],
                'palabras_determinantes': ['contrabando', 'ilegal', 'clandestino', 'sin levante'],
                'palabras_contexto': ['trocha', 'paso fronterizo', 'policia fiscal', 'aprehension', 'mercancia'],
                'palabras_refuerzo': ['bajos precios', 'barato', 'sin papeles', 'ocultamiento']
            },
            'ejercer actividades aduaneras sin autorización ': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Ejercer actividades aduaneras sin autorización ',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Art. 119 del Decreto 1165 de 2019',
                'Puntos de Auditoria': 'Determinar la infracción dependiendo del tipo de usuario aduanero',
                'palabras_clave': [{'ejercer actividades aduaneras', 'aduaneras sin autorizacion'}],
                'patrones_regex': [
                    r"sin\s+autorizaci[oó]n\s+aduanera",
                    r"opera\s+como\s+agencia\s+sin\s+serlo",
                    r"no\s+habilitado\s+por\s+la\s+dian"
                ],
                'palabras_determinantes': ['no autorizado', 'sin habilitación', 'ilegalmente'],
                'palabras_contexto': ['agencia de aduanas', 'usuario aduanero', 'intermediación'],
                'palabras_refuerzo': ['usurpación', 'falsedad', 'sin registro']
            },
            'el valor declarado de la mercancia no corresponde': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'El valor declarado de la mercancía no corresponde',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Art. 52 del Decreto 1165 de 2019',
                'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos',
                'palabras_clave': [{'valor no corresponde', 'valor declarado', 'valor declarado no corresponde'}],
                'patrones_regex': [
                    r"valor\s+declarado\s+inferior",
                    r"subvaluaci[oó]n",
                    r"precio\s+ostensiblemente\s+bajo"
                ],
                'palabras_determinantes': ['subvaluación', 'sobrevaluación', 'precio irreal'],
                'palabras_contexto': ['importación', 'declaración de importación', 'valor en aduana', 'factura comercial'],
                'palabras_refuerzo': ['irrisorio', 'adulterado', 'manipulado']
            },
            'errada clasificacion arancelaria': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Errada clasificacion arancelaria',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Art. 119 del Decreto 1165 de 2019',
                'Puntos de Auditoria': 'Verificación de la posición arancelaria y descripción de mercancía.',
                'palabras_clave': [{'clasificación', 'clasificacion', 'error', 'arancelaria', 'clasificando'}],
                'patrones_regex': [
                    r"subpartida\s+incorrecta",
                    r"clasificaci[oó]n\s+err[oó]nea",
                    r"tributo\s+menor\s+por\s+partida"
                ],
                'palabras_determinantes': ['mala clasificación', 'error de partida', 'partida incorrecta'],
                'palabras_contexto': ['arancel', 'partida arancelaria', 'subpartida', 'descripción de mercancía'],
                'palabras_refuerzo': ['evadir arancel', 'pagar menos', 'ajuste de valor']
            },
            'exportacion ficticia': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Exportación ficticia',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Art. 31 del Decreto 920 de 2023',
                'Puntos de Auditoria': 'Verificación de ingreso de divisas y existencia física de la mercancía.',
                'palabras_clave': [{'exportacion', 'ficticia', 'ficticio', 'fictisia', 'fictisio'}],
                'patrones_regex': [
                    r"exportaci[oó]n\s+ficticia",
                    r"nunca\s+sali[oó]\s+la\s+mercanc[ií]a",
                    r"simulaci[oó]n\s+de\s+exportaci[oó]n"
                ],
                'palabras_determinantes': ['ficticia', 'simulada', 'inexistente'],
                'palabras_contexto': ['reintegro de divisas', 'dex', 'embarque', 'salida de mercancía'],
                'palabras_refuerzo': ['fraude', 'cobrar iva', 'devolución de impuestos']
            },
            'incumplimiento de requisitos previos': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Incumplmineto de requisitos previos',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Arts. 66 y 69 Decreto 920 de 2023',
                'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos.',
                'palabras_clave': [{'requisitos previos', 'incumple requisitos previos'}],
                'patrones_regex': [
                    r"sin\s+visto\s+bueno",
                    r"falta\s+licencia\s+previa",
                    r"sin\s+registro\s+de\s+importaci[oó]n"
                ],
                'palabras_determinantes': ['sin requisitos', 'no cumple previos', 'falta permiso'],
                'palabras_contexto': ['visto bueno', 'licencia', 'registro', 'invima', 'ica'],
                'palabras_refuerzo': ['restringido', 'prohibido', 'sin autorización']
            },
            'incumplimiento de reglamentos tecnicos': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Incumplimiento de reglamentos tecnicos',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Documento técnico de la entidad que regula',
                'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos y documentos tecnicos de la entidad que regula.',
                'palabras_clave': [{'incumplimiento requisitos', 'etiquetado', 'reglamento tecnico', 'reglamentos tecnicos'}],
                'patrones_regex': [
                    r"mal\s+etiquetado",
                    r"incumple\s+retie",
                    r"sin\s+certificado\s+de\s+conformidad"
                ],
                'palabras_determinantes': ['reglamento técnico', 'norma técnica', 'etiquetado'],
                'palabras_contexto': ['seguridad', 'calidad', 'certificado', 'norma'],
                'palabras_refuerzo': ['riesgo', 'no apto', 'ilegal']
            },
            'suministrar informacion o documentacion inexacta o irregular': {
                'Conducta': 'Aduanera',
                'Conducta Sancionable': 'Suministrar información o documentación inexacta o irregular',
                'Impuesto / Infracción': 'Infracción aduanera',
                'Normatividad': 'Arts. 66 y 69 Decreto 920 de 2023',
                'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos.',
                'palabras_clave': [{'documentos irregulares', 'documentacion irregular', 'documentos inexacta'}],
                'patrones_regex': [
                    r"informaci[oó]n\s+falsa",
                    r"documentos?\s+adulterados?",
                    r"datos\s+inexactos"
                ],
                'palabras_determinantes': ['inexacta', 'irregular', 'falsa'],
                'palabras_contexto': ['documentación soporte', 'declaración', 'datos'],
                'palabras_refuerzo': ['mentira', 'fraude', 'engaño']
            }
        }
    },
    'Cambiario': {
        'reglas': {
            'canalizar operaciones diferentes a las autorizadas': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Canalizar operaciones diferentes a las autorizadas',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'canalizar operaciones', 'canaliza'}],
                'patrones_regex': [
                    r"canaliz[oó]\s+mal",
                    r"operaci[oó]n\s+no\s+autorizada",
                    r"mercado\s+cambiario\s+indebido"
                ],
                'palabras_determinantes': ['mal canalizado', 'no autorizado', 'desviado'],
                'palabras_contexto': ['intermediario cambiario', 'cuenta de compensación', 'divisas'],
                'palabras_refuerzo': ['infracción', 'irregularidad', 'violación cambiaria']
            },
            'ejercer actividades cambiarias sin autorización': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'ejercer actividades cambiarias sin autorización',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'ejercer actividades cambiarias', 'cambiarias sin autorizacion'}],
                'patrones_regex': [
                    r"casa\s+de\s+cambio\s+ilegal",
                    r"cambista\s+de\s+la\s+calle",
                    r"compra\s+venta\s+d[oó]lares\s+sin\s+permiso"
                ],
                'palabras_determinantes': ['sin permiso', 'no autorizado', 'ilegal'],
                'palabras_contexto': ['profesional de cambio', 'divisas', 'compraventa'],
                'palabras_refuerzo': ['clandestino', 'informal', 'lavado']
            },
            'extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'extinguir operaciones', 'medios diferentes', 'liquidar operaciones'}],
                'patrones_regex': [
                    r"pago\s+en\s+efectivo\s+exportaci[oó]n",
                    r"no\s+us[oó]\s+banco",
                    r"canalizaci[oó]n\s+omitida"
                ],
                'palabras_determinantes': ['no canalizó', 'efectivo', 'medio no autorizado'],
                'palabras_contexto': ['importación', 'exportación', 'deuda externa', 'intermediarios'],
                'palabras_refuerzo': ['evasión cambiaria', 'bolsillo', 'caja menor']
            },
            'no presentar o no transmitir al Banco de la República las operaciones': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'No presentar o no transmitir al Banco de la República las operaciones',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'no ha presentado informacion al banco de la republica', 'no ha transmitido informacion al banco de la republica', 'no ha eviado informacion al banco de la republica'}],
                'patrones_regex': [
                    r"no\s+report[oó]\s+al\s+banco",
                    r"omisi[oó]n\s+reporte\s+banrep",
                    r"sin\s+declaraci[oó]n\s+de\s+cambio"
                ],
                'palabras_determinantes': ['no transmitió', 'omitió reporte', 'sin registro'],
                'palabras_contexto': ['banco de la república', 'banrep', 'operaciones cambiarias'],
                'palabras_refuerzo': ['ocultamiento', 'sancionable', 'omiso']
            },
            'no presentar o no transmitir información exogena cambiaria a la DIAN': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'No presentar o no transmitir información exogena cambiaria a la DIAN',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'no ha presentado informacion exogena cambiaria', 'no ha presentado exogena cambiaria', 'no ha transmitido informacion exogena cambiaria', 'no ha transmitido exogena cambiaria', 'informacion cambiaria'}],
                'patrones_regex': [
                    r"no\s+present[oó]\s+ex[oó]gena\s+cambiaria",
                    r"omiso\s+ex[oó]gena\s+cambiaria",
                    r"falta\s+reporte\s+1059"
                ],
                'palabras_determinantes': ['cambiaria'],
                'palabras_contexto': ['exogena cambiaria', 'dian', 'formatos'],
                'palabras_refuerzo': []
            },
            'pagar o recibir pagos a través del mercado no cambiario por operaciones canalizables': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Pagar o recibir pagos a través del mercado no cambiario por operaciones canalizables',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Ley 2245 de 2011',
                'Puntos de Auditoria': 'Verificar información exógena cambiaria.',
                'palabras_clave': [{'canaliza', 'mercado cambiario', 'cambiario', 'no cambiario'}],
                'patrones_regex': [
                    r"mercado\s+libre\s+para\s+importaciones",
                    r"pago\s+por\s+fuera",
                    r"no\s+us[oó]\s+imc"
                ],
                'palabras_determinantes': ['mercado negro', 'mercado libre', 'no canalizado'],
                'palabras_contexto': ['canalizable', 'obligatoria canalización', 'divisas'],
                'palabras_refuerzo': ['ilegalmente', 'por debajo', 'sin rastro']
            },
            'realizar operaciones de compra y venta de divisas sin autorizacion': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Realizar operaciones de compra y venta de divisas sin autorizacion',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 del Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar que el profesional de cambio este autorizado.',
                'palabras_clave': [{'compra divisas', 'compra de divisas', 'venta divisas', 'venta de divisas', 'divisas', 'compra venta sin autorizacion', 'operaciones de cambio'}],
                'patrones_regex': [
                    r"compraventa\s+divisas\s+ilegal",
                    r"cambio\s+de\s+moneda\s+sin\s+permiso",
                    r"negocio\s+de\s+divisas"
                ],
                'palabras_determinantes': ['sin autorización', 'ilegal', 'no profesional'],
                'palabras_contexto': ['dólares', 'euros', 'efectivo', 'local comercial'],
                'palabras_refuerzo': ['fachada', 'clandestino', 'lavado']
            },
            'transmitir al Banco de la República en forma extemporánea': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Transmitir al Banco de la República en forma extemporánea',
                'Impuesto / Infracción': 'Infracción cambiaria',
                'Normatividad': 'Art. 3 del Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar en la exogena la existencia de cuentas de compensación.',
                'palabras_clave': [{'banco de la republica', 'extemporanea al banco de la republica'}],
                'patrones_regex': [
                    r"reporte\s+tard[ií]o\s+banrep",
                    r"fuera\s+de\s+plazo\s+banco",
                    r"extempor[aá]neo\s+cambiario"
                ],
                'palabras_determinantes': ['extemporáneo', 'tarde', 'vencido'],
                'palabras_contexto': ['fechas', 'plazos', 'banco de la república'],
                'palabras_refuerzo': ['recurrente', 'siempre tarde', 'desorden']
            },
            'transmitir a la DIAN información exógena cambiaria en forma extemporánea': {
                'Conducta': 'Cambiaria',
                'Conducta Sancionable': 'Transmitir a la DIAN información exogena cambiaria en forma extemporánea',
                'Impuesto / Infracción': 'Infraccion cambiaria',
                'Normatividad': 'Art. 3 del Decreto 2245 de 2011',
                'Puntos de Auditoria': 'Verificar en la exogena la existencia de cuentas de compensación.',
                'palabras_clave': [{'exogena cambiaria', 'envia exogena cambiaria'}],
                'patrones_regex': [
                    r"ex[oó]gena\s+cambiaria\s+tarde",
                    r"presentaci[oó]n\s+extempor[aá]nea\s+dian",
                    r"fuera\s+de\s+fecha\s+ex[oó]gena"
                ],
                'palabras_determinantes': ['extemporaneidad', 'fuera de plazo', 'retraso'],
                'palabras_contexto': ['calendario', 'trimestre', 'informacion cambiaria'],
                'palabras_refuerzo': ['multa', 'sanción']
            }
        }
    },
    'Tributario': {
        'reglas': {
            'evade impuestos': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Evade Impuestos',
                'Impuesto / Infracción': 'Revisión tributaria integral',
                'Normatividad': 'Art. 647 E.T.',
                'Puntos de Auditoria': 'Cruce de patrimonio, ingresos y gastos.',
                'palabras_clave': [{'evade', 'evadir', 'evasion', 'evasión', 'evacion', 'evación', 'ventas', 'totales', 'no presenta', 'dejo de presentar', 'no presentó', 'no presento', 'no declaró', 'no declaro', 'evadiendo impuestos', 'evasion de impuestos', 'evasores', 'fraude', 'fraudulentos', 'evadiendo', 'no paga impuestos', 'no paga impuesto', 'no paga los impuestos', 'evada impuestos', 'en efectivo', 'evadido', 'recibe efectivo', 'recibe en efectivo', 'pago de impuestos', 'fraudulenta', 'bajar la base', 'robo de impuestos', 'base menor', 'investiguen', 'investigacion'}],
                'patrones_regex': [
                    r"evasi[oó]n\s+fiscal",
                    r"no\s+paga\s+nada",
                    r"fraude\s+tributario",
                    r"oculta\s+ingresos"
                ],
                'palabras_determinantes': ['evasor', 'fraude', 'robo', 'ilegal'],
                'palabras_contexto': ['impuestos', 'fiscalizacion'],
                'palabras_refuerzo': ['no ha pagado impuestos']
            },
            'extemporaneidad en la presentacion de las declaraciones': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Extemporaneidad en la presentacion de las declaraciones',
                'Impuesto / Infracción': 'Declaración Extemporánea',
                'Normatividad': 'Arts. 641 - 642 - 645 y 804 E.T',
                'Puntos de Auditoria': 'Verificar la fecha de vencimiento establecida en el calendario tributario para la vigencia correspondiente y la fecha efectiva de presentación. Adicionalmente, revisar la prelación de saldos en el pago asociado a dicha declaración, conforme a lo dispuesto en el artículo 804 del Estatuto Tributario, con el propósito de corroborar si el pago realizado fue oportuno y suficiente para que la declaración produzca plenos efectos jurídicos',
                'palabras_clave': [{'no calcula sancion', 'extemporanea', 'despues de la fecha'}],
                'patrones_regex': [
                    r"present[oó]\s+tarde",
                    r"declaraci[oó]n\s+vencida",
                    r"fuera\s+del\s+calendario"
                ],
                'palabras_determinantes': ['extemporáneo', 'vencido', 'tardío'],
                'palabras_contexto': ['fecha de vencimiento', 'plazo', 'calendario tributario'],
                'palabras_refuerzo': ['sin sanción', 'intereses', 'mora']
            },
            'no declara activos en el exterior': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No declara activos en el exterior',
                'Impuesto / Infracción': 'Declaración Activos en el exterior',
                'Normatividad': 'Arts. 574 Num. 5, 607 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar con fundamento en los documentos aportados como anexos a la denuncia la obligatoriedad del contribuyente de presentar la declaración de activos en el exterior por el o los periodos denunciados, de conformidad con lo establecido en el artículo 607 del Estatuto Tributario. A partir de dicha verificación, corresponderá determinar si el contribuyente estaba obligado a declarar y, en consecuencia, establecer la posible configuración de una conducta sancionable por la omisión en la presentación de la respectiva declaración.',
                'palabras_clave': [{'activos en el exterior', 'fuera del pais', 'activos fuera del pais'}],
                'patrones_regex': [
                    r"cuentas\s+en\s+miami",
                    r"propiedades\s+en\s+el\s+exterior",
                    r"dinero\s+afuera"
                ],
                'palabras_determinantes': ['exterior', 'oculto'],
                'palabras_contexto': ['panamá', 'estados unidos', 'cuentas bancarias', 'inversiones'],
                'palabras_refuerzo': ['paraísos', 'offshore']
            },
            'no declara impuesto al consumo': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No Declara Impuesto al Consumo',
                'Impuesto / Infracción': 'Impuesto al consumo',
                'Normatividad': 'Arts. 512-1 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar la responsabilidad del contribuyente frente al impuesto nacional al consumo, teniendo en cuenta los parámetros normativos según lo dispuesto en el artículo 437 parágrafo 3 y 512-1 del E.T. A partir de dicha verificación, identificar los periodos gravables en los cuales el contribuyente registra la obligación de presentar declaraciones del impuesto al consumo y, en consecuencia, determinar si existe omisión en la presentación de las correspondientes declaraciones',
                'palabras_clave': [{'impuesto al consumo', 'no declara impuesto al consumo', 'impuesto nacional al consumo', 'impoconsumo'}],
                'patrones_regex': [
                    r"no\s+cobra\s+impoconsumo",
                    r"evade\s+impuesto\s+al\s+consumo",
                    r"restaurante\s+sin\s+impuestos"
                ],
                'palabras_determinantes': ['omiso consumo'],
                'palabras_contexto': ['restaurante', 'bar', 'telefonía', 'vehículos'],
                'palabras_refuerzo': ['impoconsumo', 'impuesto al consumo']
            },
            'no declara impuesto al patrimonio': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No Declara Impuesto al Patrimonio',
                'Impuesto / Infracción': 'Impuesto al patrimonio',
                'Normatividad': 'Arts. 292-3 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado ostenta la calidad de sujeto pasivo del impuesto al patrimonio conformidad con lo establecido en el artículo 292-3 del Estatuto Tributario. A partir de dicha verificación identificar los periodos gravables en los cuales se configura la obligación formal de presentar la correspondiente declaración del impuesto al patrimonio y, en consecuencia, determinar si se presenta o no una conducta de omisión en el cumplimiento de dicha obligación tributaria.',
                'palabras_clave': [{'impuesto al patrimonio'}],
                'patrones_regex': [
                    r"patrimonio\s+alto\s+no\s+declarado",
                    r"evade\s+riqueza",
                    r"oculta\s+bienes"
                ],
                'palabras_determinantes': ['riqueza', 'patrimonio líquido', 'omiso'],
                'palabras_contexto': ['mil millones', 'propiedades', 'carros de lujo'],
                'palabras_refuerzo': ['testaferros', 'ocultamiento', 'multimillonario']
            },
            'no declara iva': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No declara IVA',
                'Impuesto / Infracción': 'Impuesto sobre las ventas',
                'Normatividad': 'Arts. 600 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar la correcta responsabilidad del contribuyente frente al impuesto sobre las ventas, teniendo en cuenta los parámetros normativos según lo dispuesto en el artículo 437, parágrafo 3. A partir de dicha verificación, identificar los periodos gravables en los cuales el contribuyente registra la obligación de presentar declaraciones de IVA y, en consecuencia, determinar si existe omisión en la presentación de las correspondientes declaraciones',
                'palabras_clave': [{'no declara iva', 'no declara IVA', 'no cobra iva', 'no paga iva', 'recaudo de iva', 'recaudo del iva', 'no factura iva', 'no facturar iva', 'recaudo del iva', 'recaudo de iva', 'sin iva', 'recaudo del impuesto IVA', 'mercancia sin iva', '19%', 'bajar el iva'}],
                'patrones_regex': [
                    r"vende\s+sin\s+iva",
                    r"no\s+factura\s+iva",
                    r"se\s+queda\s+con\s+el\s+iva"
                ],
                'palabras_determinantes': ['omiso iva', 'responsable iva', 'no recaudado'],
                'palabras_contexto': ['ventas', 'facturación', '19%', 'bienes gravados'],
                'palabras_refuerzo': ['robo', 'apropiación', 'ilegal']
            },
            'no declara regimen simple de tributacion': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'Regimen simple de tributacion',
                'Impuesto / Infracción': 'Declaración anual consolidada RST',
                'Normatividad': 'Arts. 910 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar en el Registro Único Tributario – RUT si el contribuyente ostenta la responsabilidad de declarar bajo el Régimen Simple de Tributación de acuerdo con lo establecido en el artículo 910 del Estatuto Tributario, A partir de dicha verificación revisar la presentación de la respectiva declaración y el pago asociado a fin de corroborar el cumplimiento de la obligación formal y sustancial y establecer si se configura o no una conducta de omisión frente a esta obligación tributaria.',
                'palabras_clave': [{'regimen simple de tributacion', 'no declara rst', 'no presenta rst', 'no declaro regimen simple de tributacion', 'rst'}],
                'patrones_regex': [
                    r"no\s+pag[oó]\s+anticipo\s+simple",
                    r"omiso\s+rst",
                    r"incumple\s+regimen\s+simple"
                ],
                'palabras_determinantes': ['rst', 'simple'],
                'palabras_contexto': ['anticipo bimestral', 'declaración anual', 'tarifas'],
                'palabras_refuerzo': ['exclusión','mora']
            },
            'no declara renta': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No Declara Renta',
                'Impuesto / Infracción': 'Renta y Complementarios',
                'Normatividad': 'Arts. 574 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado ostenta la calidad de sujeto pasivo del impuesto sobre la renta y complementarios. A partir de dicha verificación identificar los periodos gravables en los cuales se configura la obligación formal de presentar la correspondiente declaración del impuesto al patrimonio y, en consecuencia, determinar si se presenta o no una conducta de omisión en el cumplimiento de dicha obligación tributaria.',
                'palabras_clave': [{'no paga impuestos', 'no declara renta', 'no presenta renta', 'no declara impuestos', 'no presenta declaracion de renta', 'omiso', 'omiso en renta', 'no presento', 'no presento declaración de renta', 'contribuyente impuesto sobre la renta'}],
                'patrones_regex': [
                    r"nunca\s+ha\s+declarado\s+renta",
                    r"omiso\s+en\s+renta",
                    r"ingresos\s+superiores\s+al\s+tope"
                ],
                'palabras_determinantes': ['omiso', 'no declarante', 'evasor'],
                'palabras_contexto': ['ingresos', 'patrimonio', 'movimientos bancarios', 'tarjetas de crédito'],
                'palabras_refuerzo': ['mucho dinero', 'grandes ingresos', 'cero impuestos']
            },
            'no declara retencion en la fuente': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No declara retencion en la fuente',
                'Impuesto / Infracción': 'Retención en la Fuente',
                'Normatividad': ' Arts. 368, 368-2 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor en la fuente a título del impuesto sobre la renta conforme a lo previsto en los artículos 368 y 368-2 del Estatuto Tributario, con el fin de establecer su responsabilidad formal y sustancial frente a dicha obligación. A partir de esta verificación determinar si se configura o no una conducta de omisión en la declaración y/o pago de las retenciones en la fuente',
                'palabras_clave': [{'no declara retencion', 'no delcara retencion en la fuente'}],
                'patrones_regex': [
                    r"no\s+presenta\s+retefuente",
                    r"omisi[oó]n\s+declaraci[oó]n\s+retenci[oó]n",
                    r"formulario\s+350"
                ],
                'palabras_determinantes': ['omiso retención'],
                'palabras_contexto': ['agente retenedor', 'pagos mensuales', 'honorarios', 'servicios'],
                'palabras_refuerzo': []
            },
            'no efectua retencion en la fuente': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'no efectua retencion en la fuente',
                'Impuesto / Infracción': 'Retención en la Fuente',
                'Normatividad': ' Arts. 368, 368-2,574 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor en la fuente a título del impuesto sobre la renta conforme a lo previsto en los artículos 368 y 368-2 del Estatuto Tributario, con el fin de establecer su responsabilidad formal y sustancial frente a dicha obligación. A partir de esta verificación determinar si se configura o no una conducta de omisión en la práctica y/o pago de las retenciones en la fuente',
                'palabras_clave': [{'no efectua retencion', 'no retiene', 'no practica retencion', 'no efectua retencion', 'no esta practicando', 'no se esta practicando retencion'}],
                'patrones_regex': [
                    r"paga\s+completo\s+sin\s+retenci[oó]n",
                    r"no\s+me\s+descuenta",
                    r"omite\s+practicar\s+retenci[oó]n"
                ],
                'palabras_determinantes': ['no retiene', 'sin descuento','sin retencion'],
                'palabras_contexto': ['pagos laborales', 'compras', 'servicios', 'base gravable'],
                'palabras_refuerzo': []
            },
            'no paga impuesto de timbre': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No Paga Impuesto de Timbre',
                'Impuesto / Infracción': 'Impuesto de timbre',
                'Normatividad': 'Arts. 519 y 643 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor en la fuente a título del impuesto de timbre de acuerdo a lo previsto en los articulos 519 y 539-1 del Estatuto Tributario, con el fin de establecer su responsabilidad formal y sustancial frente a dicha obligación. A partir de esta verificación determinar si se configura o no una conducta de omisión en la declaración y/o pago de las retenciones practicadas',
                'palabras_clave': [{'impuesto de timbre', 'no paga impuesto de timbre', 'no cancela el impuesto de timbre', 'no realiza el pago del impuesto de timbre'}],
                'patrones_regex': [
                    r"evade\s+timbre",
                    r"contrato\s+sin\s+timbre",
                    r"no\s+pag[oó]\s+impuesto\s+notarial"
                ],
                'palabras_determinantes': ['timbre', 'no pago', 'evasión'],
                'palabras_contexto': ['notaría', 'escritura pública', 'contrato', 'cuantía'],
                'palabras_refuerzo': ['documento público', 'sin legalizar', 'irregular']
            },
            'no presenta informes precios de transferencia': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'No presenta informes precios de transferencia',
                'Impuesto / Infracción': 'Declaración Informativa y/o documentación comprobatoria de precios de transferencia',
                'Normatividad': 'Arts. 260-1, 260-5, 260-9 y 260-11',
                'Puntos de Auditoria': 'Verificar con base en los anexos adjuntados a la respectiva denuncia la sujeción del contribuyente denunciado al régimen de precios de transferencia y, en consecuencia, establecer la obligatoriedad de presentar la documentación comprobatoria y la declaración informativa, conforme a lo dispuesto en los artículos 260-5 y 260-9 del Estatuto Tributario.',
                'palabras_clave': [{'precios de transferencia', 'informe local', 'documentacion comprobatoria'}],
                'patrones_regex': [
                    r"vinculados\s+econ[oó]micos",
                    r"operaciones\s+internacionales\s+sin\s+reporte",
                    r"falta\s+estudio\s+precios"
                ],
                'palabras_determinantes': ['precios de transferencia', 'vinculados', 'omiso reporte'],
                'palabras_contexto': ['multinacional', 'casa matriz', 'filial', 'operaciones'],
                'palabras_refuerzo': ['millonarias', 'traslado de beneficios', 'erosión']
            },
            'retiene en la fuente y no consigna': {
                'Conducta': 'Incumplimiento de la Obligación Formal de Declarar',
                'Conducta Sancionable': 'Retiene en la fuente y no consigna',
                'Impuesto / Infracción': 'Retención en la Fuente',
                'Normatividad': 'Arts. 574 y 643 E-T',
                'Puntos de Auditoria': 'verificar si el contribuyente denunciado ostenta la calidad de agente retenedor en la fuente a título del impuesto sobre la renta, con el fin de establecer su responsabilidad formal y sustancial frente a dicha obligación. A partir de esta verificación se podrá determinar si se configura o no una conducta de omisión en la práctica, declaración y/o pago de las retenciones en la fuente.',
                'palabras_clave': [{'no consigna la retencion', 'no consigna los valores retenidos', 'retiene y no paga', 'no paga retencion'}],
                'patrones_regex': [
                    r"descuenta\s+y\s+no\s+paga",
                    r"se\s+roba\s+la\s+retenci[oó]n",
                    r"apropiaci[oó]n\s+retenciones"
                ],
                'palabras_determinantes': ['peculado', 'no consigna', 'apropiación'],
                'palabras_contexto': ['certificados', 'descuentos', 'nómina', 'proveedores'],
                'palabras_refuerzo': ['delito', 'cárcel', 'robo']
            },
            'cobra tarifas en iva diferentes': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Cobra tarifas en IVA diferentes a las legales',
                'Impuesto / Infracción': 'Impuesto sobre las ventas',
                'Normatividad': '468, 468-1, 468-3, 477 y 647 E.T.',
                'Puntos de Auditoria': 'Verificar, en concordancia con lo dispuesto en los artículos 468, 468-1, 468-3 y 477 del Estatuto Tributario, la tarifa aplicable del impuesto sobre las ventas (IVA) a las operaciones realizadas por el contribuyente, con el fin de establecer si se aplicaron correctamente las disposiciones normativas vigentes. A partir de esta verificación, determinar la existencia de una posible inexactitud derivada de la aplicación de tarifas diferentes a las legalmente establecidas.',
                'palabras_clave': [{'tarifas diferentes', 'tarifa diferente', 'tarifa que no corresponde', 'a otra trifa'}],
                'patrones_regex': [
                    r"iva\s+al\s+5%\s+y\s+es\s+19%",
                    r"tarifa\s+incorrecta",
                    r"baja\s+el\s+iva"
                ],
                'palabras_determinantes': ['tarifa errada', 'tarifa diferente', 'diferencia tarifa'],
                'palabras_contexto': ['factura', 'producto', 'servicio', 'porcentaje'],
                'palabras_refuerzo': []
            },
            'consigna ingresos propios en cuentas de terceros': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Consigna ingresos propios en cuentas de terceros',
                'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo',
                'Normatividad': 'Art. 755-3 E.T.',
                'Puntos de Auditoria': 'Verificar los ingresos del contribuyente denunciado a partir de la información registrada en sus declaraciones tributarias, contrastándola con los movimientos bancarios reportados por el tercero que, según la denuncia, presuntamente estaría sirviendo como intermediario o canal para el flujo de los ingresos. El análisis deberá permitir identificar posibles inconsistencias, omisiones o desvíos en la declaración de ingresos frente a la realidad económica evidenciada en los movimientos financieros.',
                'palabras_clave': [{'consigna ingresos de terceros', 'en cuentas de terceros'}],
                'patrones_regex': [
                    r"cuenta\s+prestada",
                    r"usa\s+la\s+cuenta\s+de\s+la\s+esposa",
                    r"recibe\s+en\s+otra\s+cuenta"
                ],
                'palabras_determinantes': ['cuenta ajena', 'interpósita persona', 'desvío'],
                'palabras_contexto': ['banco', 'transferencia', 'nequi', 'daviplata'],
                'palabras_refuerzo': ['ocultar', 'evadir', 'camuflar']
            },
            'dinero depositados en paraisos fiscales': {
                'Conducta': 'Inexactitu en las declaraciones tributarias',
                'Conducta Sancionable': 'Dinero depositados en paraisos fiscales',
                'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio',
                'Normatividad': 'Art. 239-1 E.T.',
                'Puntos de Auditoria': 'De acuerdo con los documentos anexos a la denuncia que sustentan un presunto ocultamiento de activos poseídos en el exterior, verificar la existencia de una posible omisión de activos por parte del contribuyente denunciado, contrastando la información allegada con lo declarado en renta y complmentarios y demás registros disponibles en las bases al acuales se tiene acceso.',
                'palabras_clave': [{'paraiso', 'paraisos', 'fiscales'}],
                'patrones_regex': [
                    r"cuentas\s+en\s+panam[aá]",
                    r"dinero\s+en\s+las\s+islas",
                    r"cayman"
                ],
                'palabras_determinantes': ['paraíso fiscal', 'offshore', 'jurisdicción no cooperante'],
                'palabras_contexto': ['banco internacional', 'fundación privada', 'sociedad'],
                'palabras_refuerzo': ['esconder', 'lavado', 'secreto']
            },
            'doble facturacion': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Doble facturación',
                'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo',
                'Normatividad': 'Art. 647 Num. 1',
                'Puntos de Auditoria': 'De acuerdo con los anexos adjuntados a la denuncia, verificar si el contribuyente denunciado incurre en la práctica de ocultar ingresos mediante una presunta doble facturación, contrastando la información contenida en dichos anexos con la facturación efectivamente generada y reportada ante la administración tributaria.',
                'palabras_clave': [{'doble facturacion'}],
                'patrones_regex': [
                    r"dos\s+facturas\s+mismo\s+n[uú]mero",
                    r"facturaci[oó]n\s+paralela",
                    r"software\s+doble\s+contabilidad"
                ],
                'palabras_determinantes': ['doble facturación', 'factura gemela', 'clonación'],
                'palabras_contexto': ['pos', 'software contable', 'caja', 'ventas'],
                'palabras_refuerzo': ['fraude', 'sistemático', 'organizado']
            },
            'incluye costos no procedentes': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Incluye costos no procedentes',
                'Impuesto / Infracción': 'Renta y Complementarios',
                'Normatividad': 'Art. 647 Num. 3 E.T.',
                'Puntos de Auditoria': 'Verificar, con base en los anexos y los hechos expuestos en la denuncia, si el contribuyente denunciado ha incluido en la declaración de renta y complementarios costos o gastos inexistentes, a fin de determinar una posible inexactitud en la información declarada.',
                'palabras_clave': [{'costos', 'procedentes', 'deducciones', 'incluir', 'incluye', 'soporte de gastos', 'soporte para los gastos'}],
                'patrones_regex': [
                    r"gastos\s+personales\s+como\s+empresa",
                    r"facturas\s+compradas",
                    r"inflar\s+costos"
                ],
                'palabras_determinantes': ['costo inexistente', 'deducción improcedente', 'gasto falso'],
                'palabras_contexto': ['declaración de renta', 'facturas', 'proveedores'],
                'palabras_refuerzo': ['bajar impuesto', 'falsedad', 'sin relación de causalidad']
            },
            'incluye pasivos inexistentes': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Incluye pasivos inexistentes',
                'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio',
                'Normatividad': 'Art. 239-1 E.T.',
                'Puntos de Auditoria': 'De acuerdo con los documentos anexos a la denuncia que sustentan la posible conducta de declarar pasivos inexistentes, verificar esta situación contrastando la información allegada con lo declarado en renta y complmentarios y demás registros disponibles en las bases al acuales se tiene acceso.',
                'palabras_clave': [{'pasivos', 'pasivo', 'pasivos inexistentes'}],
                'patrones_regex': [
                    r"deuda\s+falsa",
                    r"pasivo\s+ficticio",
                    r"pr[ée]stamo\s+inexistente"
                ],
                'palabras_determinantes': ['pasivo inexistente', 'deuda ficticia'],
                'palabras_contexto': ['patrimonio', 'declaración', 'acreedor'],
                'palabras_refuerzo': ['disminuir patrimonio', 'evadir', 'mentira']
            },
            'no declara retención en la fuente correctamente': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'no declara retención en la fuente correctamente',
                'Impuesto / Infracción': 'Retención en la Fuente',
                'Normatividad': 'Art. 647 Num. 2',
                'Puntos de Auditoria': 'Conforme a lo establecido en los artículos 368 y 368-2 del Estatuto Tributario, corresponde verificar si el contribuyente denunciado ostenta la calidad de agente retenedor en la fuente a título del impuesto sobre la renta, con el fin de determinar su responsabilidad formal y sustancial frente a dicha obligación. A partir de esta verificación, se deberá analizar la coherencia entre las bases sujetas a retención registradas en las declaraciones de retención en la fuente (costos y gastos) y los montos efectivamente retenidos, con el propósito de identificar posibles inconsistencias.',
                'palabras_clave': [{'no declara retencion correctamente'}],
                'patrones_regex': [
                    r"base\s+retenci[oó]n\s+errada",
                    r"valor\s+declarado\s+menor",
                    r"error\s+formulario\s+350"
                ],
                'palabras_determinantes': ['inexactitud', 'error valores', 'incorrecto'],
                'palabras_contexto': ['renglones', 'formulario', 'declaración'],
                'palabras_refuerzo': ['maquillado', 'falso', 'inconsistente']
            },
            'no declara impuesto de timbre correctamente': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'no declara impuesto de timbre correctamente',
                'Impuesto / Infracción': 'Impuesto de timbre nacional',
                'Normatividad': 'Arts. 519 y 647 Num. 2',
                'Puntos de Auditoria': 'Conforme a lo previsto en el artículo 519 del Estatuto Tributario, corresponde verificar si el contribuyente denunciado cumple con el hecho generador del impuesto al timbre nacional. A partir de esta verificación, se deberá analizar la coherencia entre la configuración del hecho generador y las retenciones practicadas, con el propósito de identificar posibles inconsistencias o incumplimientos frente a esta obligación tributaria.',
                'palabras_clave': [{'timbre'}],
                'patrones_regex': [
                    r"base\s+timbre\s+errada",
                    r"tarifa\s+timbre\s+mal"
                ],
                'palabras_determinantes': ['inexactitud timbre', 'valor errado'],
                'palabras_contexto': ['contratos', 'cheques', 'bonos'],
                'palabras_refuerzo': ['menor valor', 'evasión parcial']
            },
            'omite activos': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Omite activos',
                'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio',
                'Normatividad': 'Art. 239-1 E.T.',
                'Puntos de Auditoria': 'De acuerdo con los documentos anexos a la denuncia que sustentan un presunto ocultamiento de activos, verificar la existencia de una posible omisión de activos por parte del contribuyente denunciado, contrastando la información allegada con lo declarado en renta y complmentarios y demás registros disponibles en las bases al acuales se tiene acceso.',
                'palabras_clave': [{'omitir activos', 'omite activos', 'activos', 'activo', 'se ha declarado'}],
                'patrones_regex': [
                    r"bienes\s+a\s+nombre\s+de\s+otro",
                    r"no\s+declar[oó]\s+la\s+casa",
                    r"ocultamiento\s+de\s+bienes"
                ],
                'palabras_determinantes': ['omisión de activos', 'bienes ocultos'],
                'palabras_contexto': ['escrituras', 'vehículos', 'cuentas', 'inversiones','lavado de activos'],
                'palabras_refuerzo': ['testaferrato', 'dolo', 'intencional']
            },
            'omite ingresos': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Omite Ingresos',
                'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo',
                'Normatividad': 'Art. 647 E.T.',
                'Puntos de Auditoria': 'Verificar, a partir de los cruces de información entre las declaraciones de renta, retención en la fuente, impuesto sobre las ventas (IVA) e información exógena tributaria, la consistencia de las cifras registradas en dichas declaraciones, con el fin de establecer la coherencia en la determinación y declaración de los ingresos del contribuyente denunciado.',
                'palabras_clave': [{'omite ingresos'}, {'omision de ingresos'}, {'no declara ingresos'}, {'oculta ingresos', 'no declara todos los ingresos', 'recibe intereses', 'recibe arrendamientos', 'ingresos declarados debidamente', 'ingresos declarados indebidamente'}],
                'patrones_regex': [
                    r"ventas\s+por\s+debajo\s+de\s+cuerda",
                    r"ingresos\s+no\s+reportados",
                    r"dinero\s+sin\s+declarar"
                ],
                'palabras_determinantes': ['omisión de ingresos', 'subdeclaración', 'ocultamiento'],
                'palabras_contexto': ['ventas', 'consignaciones', 'efectivo', 'caja'],
                'palabras_refuerzo': ['masivo', 'sistemático', 'gran cuantía']
            },
            'costos o gastos originados con Proveedor ficticio': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Costos o gastos originados con Proveedor ficticio',
                'Impuesto / Infracción': 'Renta y Complmentarios',
                'Normatividad': 'Art. 647-3 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado registra operaciones con terceros incluidos en las resoluciones de declaratoria de proveedores ficticios emitidas por la Subdirección de Fiscalización Tributaria, con el fin de determinar la cuantía de dichas operaciones y establecer los montos que podrían considerarse presuntamente inexactos',
                'palabras_clave': [{'proveedor ficticio'}],
                'patrones_regex': [
                    r"empresa\s+de\s+papel",
                    r"facturaci[oó]n\s+simulada",
                    r"proveedor\s+sancionado"
                ],
                'palabras_determinantes': ['proveedor ficticio', 'empresa fachada', 'inexistente'],
                'palabras_contexto': ['compras', 'servicios', 'facturas'],
                'palabras_refuerzo': ['trama', 'carrusel', 'fraude']
            },
            'retiene en la fuente a tarifas diferentes a las legales': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Retiene en la fuente a tarifas diferentes a las legales',
                'Impuesto / Infracción': 'Retención en la Fuente',
                'Normatividad': 'Art. 647 Num. 2',
                'Puntos de Auditoria': 'Verificar, en concordancia con lo dispuesto en los artículos 392, 395 y 401 del Estatuto Tributario la tarifa de retención en la fuente aplicable a las operaciones realizadas por el contribuyente, con el fin de establecer si se aplicaron correctamente las disposiciones normativas vigentes. A partir de esta verificación, determinar la existencia de una posible inexactitud derivada de la aplicación de tarifas diferentes a las legalmente establecidas',
                'palabras_clave': [{'aplica retencion en la fuente con tarifas distintas', 'tarifas diferentes', 'efectua retenciones en la fuente con tarifas', 'practica retención en la fuente a una tarifa', 'realiza retencion en la fuente con una tarifa'}],
                'patrones_regex': [
                    r"porcentaje\s+retenci[oó]n\s+mal",
                    r"aplica\s+tarifa\s+menor",
                    r"error\s+tabla\s+retenci[oó]n"
                ],
                'palabras_determinantes': ['tarifa incorrecta', 'mal practicada'],
                'palabras_contexto': ['tabla de retención', 'concepto', 'base'],
                'palabras_refuerzo': ['desconocimiento', 'error reiterado']
            },
            'solicita beneficios fiscales inexistentes': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Solicita beneficios fiscales inexistentes',
                'Impuesto / Infracción': 'Renta y Complementarios',
                'Normatividad': 'Art. 647 Num. 3 E.T.',
                'Puntos de Auditoria': 'Verificar, con base en el hecho denunciado y los anexos aportados, si el contribuyente ha aplicado exenciones o beneficios tributarios sin cumplir los requisitos establecidos en la normativa vigente. A partir de esta verificación, determinar la posible existencia de una presunta inexactitud en sus declaraciones tributarias.',
                'palabras_clave': [{'exenciones', 'beneficios', 'fiscales', 'tributarios'}, {'beneficio tributario', 'exenciones tributarias'}],
                'patrones_regex': [
                    r"descuento\s+tributario\s+falso",
                    r"exenci[oó]n\s+no\s+aplica",
                    r"renta\s+exenta\s+improcedente"
                ],
                'palabras_determinantes': ['beneficio improcedente', 'exención falsa'],
                'palabras_contexto': ['zona franca', 'economía naranja', 'agro', 'ley 1429'],
                'palabras_refuerzo': ['abuso', 'sin requisitos', 'fraude']
            },
            'inexactitud declaracion ingresos y patrimonio': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'inexactitud declaracion ingresos y patrimonio',
                'Impuesto / Infracción': 'Renta y Complementarios',
                'Normatividad': 'Art. 23, 13-1, 23-2 y 647 Num. 6 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado tiene la obligación de presentar la declaración de ingresos y patrimonio, conforme a los parámetros establecidos en la normativa tributaria vigente. A partir de esta verificación, determinar la posible existencia de una presunta inexactitud en sus declaraciones tributarias.',
                'palabras_clave': [{'exenciones', 'beneficios', 'fiscales', 'tributarios'}, {'beneficio tributario', 'exenciones tributarias'}],
                'patrones_regex': [
                    r"entidad\s+sin\s+animo\s+lucro\s+inexacta",
                    r"error\s+ingresos\s+y\s+patrimonio"
                ],
                'palabras_determinantes': ['inexactitud', 'error cifras'],
                'palabras_contexto': ['esal', 'fundación', 'asociación', 'cooperativa'],
                'palabras_refuerzo': ['desvío de recursos', 'lucro indirecto']
            },
            'utiliza documentos presuntamente falsos': {
                'Conducta': 'Inexactitud en las declaraciones tributarias',
                'Conducta Sancionable': 'Utiliza documentos presuntamente falsos',
                'Impuesto / Infracción': 'Impuesto sobre la renta',
                'Normatividad': 'Art. 647 Num. 6 E.T.',
                'Puntos de Auditoria': 'Verificar la realidad económica de las operaciones efectuadas por el contribuyente denunciado, con el propósito de establecer la procedencia de los costos y deducciones imputados en sus declaraciones tributarias, conforme a los principios de causalidad, necesidad y proporcionalidad previstos en la normativa fiscal vigente, y sustentados en documentos que cumplan con los requisitos formales y sustanciales exigidos para su aceptación tributaria.',
                'palabras_clave': [{'documentos falsos', 'documento falso', 'documentos irregulares'}],
                'patrones_regex': [
                    r"factura\s+falsificada",
                    r"soporte\s+adulterado",
                    r"firma\s+falsa"
                ],
                'palabras_determinantes': ['falsedad', 'adulteración', 'forjado'],
                'palabras_contexto': ['soportes', 'contabilidad', 'pruebas'],
                'palabras_refuerzo': ['delito', 'penal', 'criminal']
            },
            'no factura': {
                'Conducta': 'Facturación',
                'Conducta Sancionable': 'No factura',
                'Impuesto / Infracción': 'Factura Electrónica',
                'Normatividad': 'Arts. 615 y 652-1 E.T. - Res. 165/2023',
                'Puntos de Auditoria': 'Verificar, de acuerdo con los requerimientos establecidos en la normativa tributaria vigente, si el contribuyente denunciado se encuentra obligado a expedir factura electrónica de venta o documentos equivalentes. A partir de dicha verificación, determinar la posible omisión en el cumplimiento del deber formal de expedición de dichos documentos.',
                'palabras_clave': [{'no factura', 'no expide factura', 'no emite factura', 'no emite factura electronica', 'no da factura', 'sistema de facturacion electronica', 'sistema de facturacion', 'no emitieron', 'recibos de caja', 'recibo de caja', 'no me da recibo', 'no recibir las facturas', 'le emite factura', 'no hace facturas', 'no hace factura', 'facturar electronicamente', 'me la enviaban', 'no es una factura electronica', 'sin factura'}],
                'patrones_regex': [
                    r"se\s+niega\s+a\s+facturar",
                    r"entrega\s+cuenta\s+de\s+cobro",
                    r"papelito\s+sin\s+validez"
                ],
                'palabras_determinantes': ['no factura', 'omisión facturación', 'evasión'],
                'palabras_contexto': ['compra', 'venta', 'almacén', 'restaurante'],
                'palabras_refuerzo': ['ilegal', 'clausura', 'sanción']
            },
            'factura sin requisitos': {
                'Conducta': 'Facturación',
                'Conducta Sancionable': 'Factura sin requisitos',
                'Impuesto / Infracción': 'Factura Electrónica',
                'Normatividad': 'Arts. 615 y 652 E.T. - Res. 165/2023',
                'Puntos de Auditoria': 'Revisión de la información mínima de la factura.',
                'palabras_clave': [{'irregularidades en facturacion', 'sin requisitos', 'sin el lleno de requisitos', 'con todos los requisitos', 'mismo numero', 'comprado a mi nombre', 'factura falsa', 'facturacion falsa'}],
                'patrones_regex': [
                    r"factura\s+sin\s+resoluci[oó]n",
                    r"ticket\s+sin\s+nombre",
                    r"factura\s+manual\s+vencida"
                ],
                'palabras_determinantes': ['requisitos incompletos', 'factura ilegal'],
                'palabras_contexto': ['artículo 617', 'resolución', 'numeración'],
                'palabras_refuerzo': ['informal', 'error', 'sin validez']
            },
            'errores envio informacion exogena': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'Errores envío información exógena',
                'Impuesto / Infracción': 'Suministro información',
                'Normatividad': 'Arts. 631 y  651 E.T.',
                'Puntos de Auditoria': 'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria y en contraste con los hechos denunciados y sus anexos, si la información transmitida por el contribuyente denunciado cumple con las especificaciones y requerimientos técnicos establecidos por la normativa vigente.',
                'palabras_clave': [{'error informacion exogena', 'errores informacion exogena', 'errores exogena', 'error exogena', 'exogena erronea'}],
                'patrones_regex': [
                    r"datos\s+errados\s+ex[oó]gena",
                    r"cifras\s+que\s+no\s+cruzan",
                    r"reporte\s+mal\s+diligenciado"
                ],
                'palabras_determinantes': ['error', 'inconsistencia', 'inexactitud'],
                'palabras_contexto': ['medios magnéticos', 'formatos', 'prevalidador'],
                'palabras_refuerzo': ['masivo', 'reproceso', 'sanción']
            },
            'inscrito en el regimen de iva que no corresponde': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'Inscrito en el regimen de IVA que no corresponde',
                'Impuesto / Infracción': 'Obligaciones formales',
                'Normatividad': 'Art. 658-3 E.T.',
                'Puntos de Auditoria': 'Verificar la realidad económica del contribuyente denunciado con el fin de establecer la correcta inscripción, actualización y correspondencia de sus obligaciones, calidades y atributos tributarios en el Registro Único Tributario (RUT), conforme a la normativa vigente.',
                'palabras_clave': [{'inscrito', 'inscribir'}],
                'patrones_regex': [
                    r"r[ée]gimen\s+simplificado\s+siendo\s+com[uú]n",
                    r"no\s+responsable\s+siendo\s+responsable",
                    r"tope\s+superado\s+iva"
                ],
                'palabras_determinantes': ['régimen incorrecto', 'falso no responsable'],
                'palabras_contexto': ['rut', 'responsabilidad 48', 'ingresos brutos'],
                'palabras_refuerzo': ['actualización', 'fraude rut', 'evasión']
            },
            'lleva doble contabilidad': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'Lleva doble contabilidad',
                'Impuesto / Infracción': 'Irregularidades en la contabilidad',
                'Normatividad': 'Art. 655 E.T.',
                'Puntos de Auditoria': 'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado incurre en irregularidades relacionadas con los libros de contabilidad, conforme a las disposiciones establecidas en el Código de Comercio y en la normativa tributaria vigente.',
                'palabras_clave': [{'doble contabilidad', 'lleva doble'}],
                'patrones_regex': [
                    r"libros\s+oficiales\s+y\s+reales",
                    r"contabilidad\s+paralela",
                    r"cuaderno\s+privado"
                ],
                'palabras_determinantes': ['doble contabilidad', 'libros falsos'],
                'palabras_contexto': ['libros contables', 'auditoría', 'revisoría'],
                'palabras_refuerzo': ['sanción clausura', 'delito', 'grave']
            },
            'no contabiliza todas sus operaciones': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'no contabiliza todas sus operaciones',
                'Impuesto / Infracción': 'Irregularidades en la contabilidad',
                'Normatividad': 'Art. 655 E.T.',
                'Puntos de Auditoria': 'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado incurre en irregularidades contables derivadas de la omisión en el registro de todas las operaciones realizadas, conforme a lo dispuesto en el Código de Comercio y en la normativa tributaria vigente.',
                'palabras_clave': [{'no registra', 'no contabiliza', 'todas sus operaciones', 'no esta registrado'}],
                'patrones_regex': [
                    r"ventas\s+sin\s+registrar",
                    r"gastos\s+sin\s+soporte\s+contable",
                    r"caja\s+no\s+cuadra"
                ],
                'palabras_determinantes': ['falta registro', 'omisión contable'],
                'palabras_contexto': ['asientos', 'auxiliares', 'diario'],
                'palabras_refuerzo': ['desorden', 'atraso', 'irregularidad']
            },
            'no esta inscrito en el rut': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'No esta inscrito en el Registro Unico Tributario - RUT',
                'Impuesto / Infracción': 'Obligaciones formales',
                'Normatividad': 'Art. 658-3 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente se encuentra debidamente inscrito en el Registro Único Tributario – RUT, con la inclusión de las responsabilidades, calidades y atributos tributarios que correspondan a su actividad económica y obligaciones fiscales, de conformidad con la normativa vigente.',
                'palabras_clave': [{'no esta inscrito', 'no aparece inscrito', 'no se encuentra inscrito', 'no aparece registrado', 'no se encuentra debidamente inscrito', 'no tiene rut'}],
                'patrones_regex': [
                    r"trabaja\s+sin\s+rut",
                    r"empresa\s+sin\s+registro",
                    r"comercio\s+informal"
                ],
                'palabras_determinantes': ['sin rut', 'no inscrito', 'informal'],
                'palabras_contexto': ['cámara de comercio', 'registro'],
                'palabras_refuerzo': []
            },
            'reportado sin vinculo comercial en exogena por terceros': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'reportado sin vinculo comercial en exogena por terceros',
                'Impuesto / Infracción': 'Suministro información',
                'Normatividad': 'Arts. 631 y  651 E.T.',
                'Puntos de Auditoria': 'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria y en contraste con los hechos denunciados y sus anexos, si la información transmitida por el contribuyente denunciado cumple con las especificaciones y requerimientos técnicos establecidos por la normativa vigente.',
                'palabras_clave': [{'exogena de terceros', 'sin vinculo', 'me reporto', 'me informo', 'no conozco', 'corrija', 'corregir', 'no reconozco', 'mi informacion', 'reconozco', 'mi exogena', 'reporte realizado por', 'reporte hecho por', 'suplantado', 'suplantar', 'realizo reporte de informacion', 'reporte de informacion exogena', 'ningun vinculo', 'ningun vinculo comercial', 'operaciones que jamas realice', 'operaciones que nunca realice'}],
                'patrones_regex': [
                    r"aparezco\s+en\s+su\s+ex[oó]gena",
                    r"nunca\s+le\s+vend[ií]",
                    r"jam[aá]s\s+compr[ée]"
                ],
                'palabras_determinantes': ['reporte indebido', 'sin vínculo', 'suplantacion'],
                'palabras_contexto': ['consulta de datos', 'declaración sugerida', 'terceros'],
                'palabras_refuerzo': ['falso', 'error', 'desconozco']
            },
            'no expide certificados de retencion': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'No Expide certificados de retencion en fuente',
                'Impuesto / Infracción': 'Obligaciones formales',
                'Normatividad': 'Art. 667 E.T.',
                'Puntos de Auditoria': 'De acuerdo con el hecho denunciado y los anexos adjuntos, verificar si el contribuyente denunciado ha incumplido el deber formal de expedir los certificados de retención en la fuente a los que está obligado en calidad de agente retenedor, dentro de los plazos y condiciones establecidos por la normativa tributaria vigente.',
                'palabras_clave': [{'no expide certificado', 'no emite certificado', 'no genera certificado', 'no entrega certificado', 'no proporciona certificado', 'certificados de retencion', 'certificados correspondientes', 'certificado de ingresos', 'certificados de retencion', 'certificado de retenciones', 'certificado de ingresos y retenciones', 'no fue certificada'}],
                'patrones_regex': [
                    r"niego\s+certificado\s+retefuente",
                    r"no\s+me\s+da\s+el\s+papel",
                    r"certificado\s+ingresos\s+y\s+retenciones"
                ],
                'palabras_determinantes': ['no certifica', 'sin certificado', 'incumple deber'],
                'palabras_contexto': ['marzo', 'declaración renta', 'soporte'],
                'palabras_refuerzo': ['obligación', 'sanción', 'perjuicio']
            },
            'no lleva contabilidad': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'No lleva contabilidad',
                'Impuesto / Infracción': 'Irregularidades en la contabilidad',
                'Normatividad': 'Art. 655 E.T.',
                'Puntos de Auditoria': 'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado incurre en irregularidades contables derivadas de la omisión de llevar contabilidad, conforme a lo dispuesto en el Código de Comercio y en la normativa tributaria vigente.',
                'palabras_clave': [{'no lleva contabilidad', 'no lleva registros contables', 'no realiza registros contables'}],
                'patrones_regex': [
                    r"no\s+tiene\s+contador",
                    r"negocio\s+sin\s+libros",
                    r"manejo\s+de\s+tienda"
                ],
                'palabras_determinantes': ['sin contabilidad', 'no obligado (falso)', 'informalidad'],
                'palabras_contexto': ['comerciante', 'obligado a llevar', 'código comercio'],
                'palabras_refuerzo': ['total', 'caos', 'imposible auditar']
            },
            'proveedor ficticio': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'proveedor ficticio',
                'Impuesto / Infracción': 'Proveedor ficticio o insolvente',
                'Normatividad': 'Art. 671 E.T.',
                'Puntos de Auditoria': 'Verificar si el contribuyente denunciado registra operaciones con terceros incluidos en las resoluciones de declaratoria de proveedores ficticios emitidas por la Subdirección de Fiscalización Tributaria, con el fin de determinar la cuantía de dichas operaciones y establecer los montos que podrían considerarse presuntamente inexactos',
                'palabras_clave': [{'proveedor ficticio'}],
                'patrones_regex': [
                    r"declarado\s+ficticio\s+dian",
                    r"empresa\s+fantasma",
                    r"venta\s+de\s+facturas"
                ],
                'palabras_determinantes': ['ficticio', 'insolvente', 'fachada'],
                'palabras_contexto': ['resolución dian', 'publicación', 'listado'],
                'palabras_refuerzo': ['prohibido', 'sanción penal', 'fraude']
            },
            'solicita devoluciones improcedentes': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'Solicita devoluciones improcedentes',
                'Impuesto / Infracción': 'Improcedencia de las devoluciones y/o compensaciones',
                'Normatividad': 'Art. 670 E.T.',
                'Puntos de Auditoria': 'De acuerdo con el hecho denunciado y los anexos adjuntos, verificar si existen indicios que permitan determinar que el contribuyente denunciado utilizó documentos falsos o, mediante maniobras fraudulentas, obtuvo indebidamente una devolución o compensación tributaria.',
                'palabras_clave': [{'devolucion', 'solicita devoluciones improcedentes', 'devoluciones improcedentes'}],
                'patrones_regex': [
                    r"saldo\s+a\s+favor\s+falso",
                    r"pidi[oó]\s+devoluci[oó]n\s+con\s+trampa",
                    r"arrastre\s+improcedente"
                ],
                'palabras_determinantes': ['devolución improcedente', 'compensación indebida'],
                'palabras_contexto': ['saldo a favor', 'solicitud'],
                'palabras_refuerzo': []
            },
            'no reporta información exógena': {
                'Conducta': 'Obligaciones diferentes a declarar y pagar',
                'Conducta Sancionable': 'No reporta información exógena',
                'Impuesto / Infracción': 'Suministro de información',
                'Normatividad': 'Arts. 631 y  651 E.T.',
                'Puntos de Auditoria': 'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria y en contraste con los hechos denunciados y sus anexos, si el contribuyente denunciado cumplió con el deber formal de suministrar información exógena de relevancia tributaria bajo las especificaciones y requerimientos técnicos establecidos por la normativa vigente.',
                'palabras_clave': [{'no reporta informacion exogena', 'no transmite informacion exogena', 'no transmitio informacion exogerna', 'la exogena no se ha presentado','medios magneticos'}],
                'patrones_regex': [
                    r"no\s+envi[oó]\s+medios",
                    r"no\s+magn[eé]ticos",
                    r"omisi[oó]n\s+reporte\s+anual",
                    r"falta\s+informaci[oó]n\s+ex[oó]gena"
                ],
                'palabras_determinantes': ['no reporta', 'omiso exógena', 'sin medios','medios magneticos'],
                'palabras_contexto': ['formatos', 'prevalidador', 'resolución','medios magneticos'],
                'palabras_refuerzo': []
            }
        }
    }
}

        # --- CÓDIGO OPTIMIZADO PARA EVITAR BLOQUEOS ---
        
        print("DEBUG: Estructura de reglas lista. Creando columnas...", flush=True)

        # 1. Crear columnas vacías rápidamente
        columnas_nuevas = [
            'Año de Investigación', 'Conclusión', 'Auditor', 'Normatividad', 
            'Puntos de Auditoria', 'Lavado de Activos', 'Dirección Seccional', 
            'Beneficio Auditoria', 'Año Beneficio Auditoria', 'Fecha Firmeza'
        ]
        for col in columnas_nuevas:
            df[col] = ''

        print(f"DEBUG: INICIANDO PROCESAMIENTO DE {len(df)} FILAS AHORA MISMO...", flush=True)

        # 2. Inicio del Bucle Principal
        for index, row in df.iterrows():
            # Forzamos la salida en pantalla para confirmar vida
            print(f"--> Procesando Fila {index + 1}...", flush=True)




            

        descripcion_hechos = str(row.get('Descripción de los Hechos', ''))
        
        # Inicializamos variables críticas
        contexto_ia = ""
        anios_ia = []
        
        # --- A. CONSULTA A LA IA ---
        if usar_ia:
            try:
                ctx, anios = consultar_contexto_ia(descripcion_hechos, modelo_seleccionado)
                contexto_ia = " " + ctx 
                anios_ia = anios
            except Exception as e:
                print(f"Advertencia fila {index}: Falló la IA. Error: {e}")

        # --- B. DETERMINAR AÑO DE INVESTIGACIÓN ---
        anho_valido = set()
        
        # 1. Años de la IA
        for a in anios_ia:
            if 2018 <= int(a) <= 2100: anho_valido.add(str(a))

        # 2. Años del texto (Método Tradicional)
        descripcion_normalizada_lower = descripcion_hechos.lower()
        
        # Parseo fecha radicación para referencias relativas
        fecha_radicacion_str = str(row.get('Fecha Radicación', ''))
        anho_radicacion = None
        if pd.notna(fecha_radicacion_str) and fecha_radicacion_str.strip():
            try:
                fr = pd.to_datetime(fecha_radicacion_str, dayfirst=True, errors='coerce')
                if pd.notna(fr): anho_radicacion = fr.year
            except: pass

        # Búsqueda explícita 20xx
        for anho in re.findall(r'\b(20\d{2})\b', descripcion_hechos):
            if 2018 <= int(anho) <= 2100: anho_valido.add(anho)

        # Referencias relativas ("hace dos años", "año pasado")
        if anho_radicacion:
            if "desde el año pasado" in descripcion_normalizada_lower:
                anho_valido.add(str(anho_radicacion - 1))
            
            numeros_txt = {'uno': 1, 'dos': 2, 'tres': 3, 'cuatro': 4, 'cinco': 5}
            for match_x in re.findall(r'(?:desde\s+)?hace\s+(\d+|[a-zA-Z]+)\s+años', descripcion_normalizada_lower):
                try: val = int(match_x)
                except: val = numeros_txt.get(match_x, 0)
                if val > 0:
                    start = anho_radicacion - val
                    limit = max(anho_radicacion - 5, 2018)
                    for y in range(start, anho_radicacion + 1):
                        if y >= limit: anho_valido.add(str(y))

        # Fallback: Fecha Hechos
        if not anho_valido:
            fh_str = str(row.get('Fecha Hechos', ''))
            if pd.notna(fh_str) and fh_str.strip():
                fh = pd.to_datetime(fh_str, dayfirst=True, errors='coerce')
                if pd.notna(fh): anho_valido.add(str(fh.year))

        anho_investigacion = ', '.join(sorted(list(anho_valido))) if anho_valido else 'No determinado'

        # Prioridad
        prioridad = 'No'
        if anho_valido:
            actual = datetime.now().year
            if any(int(a) <= actual - 2 for a in anho_valido): prioridad = 'Si'

        df.at[index, 'Año de Investigación'] = anho_investigacion
        df.at[index, 'Prioritaria'] = prioridad

        # --- C. CLASIFICACIÓN DE CONDUCTAS ---
        texto_completo = descripcion_hechos + contexto_ia
        desc_norm = normalizar_texto(texto_completo)
        desc_lema = lematizar_artesanal(desc_norm)
        
        matches = []
        PESOS = {'patron_regex': 60, 'determinantes': 50, 'exacta': 40, 'contexto': 15, 'legacy': 10, 'refuerzo': 5}

        # Función auxiliar local para puntuación
        def calc_pts(lista, peso):
            pts = 0
            if not lista: return 0
            for item in lista:
                if isinstance(item, (list, tuple)): # Grupo
                    g = [lematizar_artesanal(normalizar_texto(x)) for x in item]
                    if all(gi in desc_lema and not detectar_negacion_cercana(desc_lema, gi) for gi in g):
                        pts += peso * len(g)
                elif isinstance(item, str): # Simple
                    i_lema = lematizar_artesanal(normalizar_texto(item))
                    if i_lema in desc_lema and not detectar_negacion_cercana(desc_lema, i_lema):
                        pts += peso
            return pts

        for reg_nom, data in reglas_conclusion.items():
            for key, rules in data['reglas'].items():
                puntos = 0
                
                # 1. Negación (Abortar si encuentra palabra negativa)
                if 'palabras_negativas' in rules and rules['palabras_negativas']:
                    if any(normalizar_texto(pn) in desc_norm for pn in rules['palabras_negativas']): continue

                # 2. Refuerzo
                bono = 0
                if 'palabras_refuerzo' in rules:
                    bono = calc_pts(rules['palabras_refuerzo'], 0) * 0 # Solo chequeo existencia simple
                    if any(normalizar_texto(pr) in desc_norm for pr in rules.get('palabras_refuerzo', [])): bono = 50

                # 3. Puntuación
                # Exacta
                k_lema = lematizar_artesanal(normalizar_texto(key))
                if k_lema in desc_lema and not detectar_negacion_cercana(desc_lema, k_lema): puntos += PESOS['exacta']
                
                # Listas
                puntos += calc_pts(rules.get('palabras_determinantes', []), PESOS['determinantes'])
                puntos += calc_pts(rules.get('palabras_contexto', []), PESOS['contexto'])
                puntos += calc_pts(rules.get('palabras_clave', []), PESOS['legacy'])
                
                # Regex
                if 'patrones_regex' in rules:
                    for pat in rules['patrones_regex']:
                        if re.search(pat, desc_lema, re.IGNORECASE): puntos += PESOS['patron_regex']

                if puntos > 0:
                    matches.append({
                        'Puntaje': puntos + bono,
                        'Regimen': reg_nom,
                        'Conducta': rules['Conducta'],
                        'Conducta Sancionable': rules['Conducta Sancionable'],
                        'Impuesto / Infracción': rules['Impuesto / Infracción'],
                        'Normatividad': rules.get('Normatividad', 'N/A'),
                        'Puntos de Auditoria': rules.get('Puntos de Auditoria', 'N/A')
                    })

        # --- D. FILTRADO Y EXCLUSIÓN ---
        EXCLUSION = {
            'no declara regimen simple de tributacion': ['no declara renta', 'no declara iva', 'no declara impuesto al consumo'],
            'no esta inscrito en el rut': ['no declara renta', 'no declara iva'],
            'evade impuestos': ['inexactitud declaracion ingresos y patrimonio'],
            'contrabando abierto': ['no factura']
        }
        eliminar = set()
        for m in matches:
            if m['Puntaje'] >= 40 and m['Conducta Sancionable'] in EXCLUSION:
                eliminar.update(EXCLUSION[m['Conducta Sancionable']])
        matches = [m for m in matches if m['Conducta Sancionable'] not in eliminar]

        finales = []
        if matches:
            max_p = max(m['Puntaje'] for m in matches)
            umbral = max_p * 0.10
            base = [m for m in matches if m['Puntaje'] >= umbral]
            # Unicos
            seen = set()
            for m in base:
                k = (m['Regimen'], m['Conducta Sancionable'])
                if k not in seen: finales.append(m); seen.add(k)
        
        # Reglas Anidadas
        if finales and max_p >= 10:
            for princ, aux in REGLAS_ANIDADAS.items():
                if any(m['Conducta Sancionable'] == princ for m in finales) and not any(m['Conducta Sancionable'] == aux['Conducta Sancionable'] for m in finales):
                    finales.insert(1, aux) # Insertar después del líder

        # --- E. ESCRITURA EN DATAFRAME ---
        # Limpiar
        cols_borrar = ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria']
        for c in cols_borrar: df.at[index, c] = 'No Clasificado' if 'Normatividad' not in c else 'N/A'

        if finales:
            df.at[index, 'Régimen'] = '\n'.join(pd.Series([m['Regimen'] for m in finales]).unique())
            df.at[index, 'Conducta'] = '\n'.join(pd.Series([m['Conducta'] for m in finales]).unique())
            df.at[index, 'Conducta Sancionable'] = '\n'.join(pd.Series([m['Conducta Sancionable'] for m in finales]).unique())
            df.at[index, 'Impuesto / Infracción'] = '\n'.join(pd.Series([m['Impuesto / Infracción'] for m in finales]).unique())
            df.at[index, 'Normatividad'] = '\n'.join(pd.Series([m['Normatividad'] for m in finales]).unique())
            df.at[index, 'Puntos de Auditoria'] = '\n'.join(pd.Series([m['Puntos de Auditoria'] for m in finales]).unique())
            
            txts = [f"régimen [{m['Regimen']}] conducta [{m['Conducta']}]" for m in finales]
            df.at[index, 'Conclusión'] = f"Se detectaron: {' | '.join(txts)}. Vigencias: [{anho_investigacion}]"
        else:
            df.at[index, 'Conclusión'] = "No se encontraron infracciones clasificables."

        # Lavado y Beneficio (Mantenimiento simple)
        es_lavado = any(x in desc_norm for x in ["lavado de activo", "lava activos", "lavado"])
        df.at[index, 'Lavado de Activos'] = 'SI' if es_lavado else 'NO'

        doc_raw = limpiar_identificacion(row.get('Documento Denunciado', ''))
        ben_info = {'ben': [], 'anio': [], 'firm': [], 'dir': []}
        if doc_raw in beneficio_map:
            for y in anho_investigacion.split(','):
                y = y.strip()
                if y in beneficio_map[doc_raw]:
                    d = beneficio_map[doc_raw][y]
                    ben_info['ben'].append('SI'); ben_info['anio'].append(d['texto'])
                    ben_info['firm'].append(d['firmeza']); ben_info['dir'].append(d['direccion'])
        
        if ben_info['ben']:
            df.at[index, 'Beneficio Auditoria'] = '\n'.join(ben_info['ben'])
            df.at[index, 'Año Beneficio Auditoria'] = '\n'.join(ben_info['anio'])
            df.at[index, 'Fecha Firmeza'] = '\n'.join(ben_info['firm'])
            df.at[index, 'Dirección Seccional'] = '\n'.join(list(set(filter(None, ben_info['dir']))))
        else:
            df.at[index, 'Beneficio Auditoria'] = 'NO' if ruta_archivo_beneficio else ''   








                


            # GENERACIÓN DE CONCLUSIÓN ---
            # Ahora la generación de conclusión es independiente del bloque de beneficio de auditoría
            if conclusiones_encontradas:
                # Generamos el texto de conclusión completo
                conclusion_texto_list = []
                for match in conclusiones_encontradas:
                    conclusion_texto_list.append(
                        f"régimen [{match['Regimen']}] por la conducta de [{match['Conducta']}] "
                        f"y conducta sancionable [{match['Conducta Sancionable']}] por el impuesto o infracción "
                        f"[{match['Impuesto / Infracción']}]"
                    )

                conclusion_final = (
                    f"Según radicado {row.get('Número Radicación', 'N/A')} de fecha {row.get('Fecha Radicación', 'N/A')}, "
                    f"el contribuyente denunciado {row.get('Nombre/Razon Social Denunciado', 'N/A')} "
                    f"identificado con tipo de documento {row.get('Tipo Documento Denunciado', 'N/A')} "
                    f"número {row.get('Documento Denunciado', 'N/A')}, ubicado en la ciudad de {row.get('Ciudad', 'N/A')} "
                    f"en el departamento de {row.get('Departamento', 'N/A')}, es denunciado por infringir el "
                    f"{' y también por '.join(conclusion_texto_list)}, por la(s) vigencia(s) fiscal(es) [{anho_investigacion}]"
                )

                df.at[index, 'Conclusión'] = conclusion_final
            else:
                df.at[index, 'Conclusión'] = "No se encontraron infracciones clasificables."
        
        # --- Reparto de Denuncias entre Auditores ---
        # Se guarda el df original (antes de reordenar) en df_original_index para mapear la asignación
        df_asignaciones, auditor_asignado_serie = repartir_denuncias(df.copy(), AUDITORES)
        
        # Asignar la columna 'Auditor' al DataFrame principal (df)
        df['Auditor'] = auditor_asignado_serie
        
        # --- Reordenamiento de Columnas ---
        
        # Define las nuevas columnas a insertar
        columnas_fijas = ['Prioritaria', 'Año de Investigación', 'Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria', 'Dirección Seccional', 'Beneficio Auditoria', 'Año Beneficio Auditoria','Fecha Firmeza', 'Lavado de Activos']
        
        # Crear la lista de columnas en el orden deseado
        columnas_ordenadas_final = []
        for col in df.columns:
            if col not in columnas_fijas and col not in ['Conclusión', 'Auditor', 'Normatividad', 'Puntos de Auditoria']:
                columnas_ordenadas_final.append(col)
        
        # Insertar las columnas fijas en su posición
        temp_df = df[columnas_ordenadas_final]
        
        # Encontrar la posición para insertar las nuevas columnas
        columnas_ordenadas_final_con_data = []
        for col in df.columns:
            if col not in ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria', 'Conclusión', 'Auditor']:
                columnas_ordenadas_final_con_data.append(col)
            
            if col == 'Año de Investigación':
                columnas_ordenadas_final_con_data.extend(['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción'])
                
            if col == 'Conclusión':
                # Insertar Normatividad y Puntos de Auditoria después de Conclusión para la Hoja Resultados
                columnas_ordenadas_final_con_data.append('Conclusión')
                columnas_ordenadas_final_con_data.extend(['Normatividad', 'Puntos de Auditoria','Dirección Seccional', 'Beneficio Auditoria', 'Año Beneficio Auditoria', 'Fecha Firmeza', 'Lavado de Activos', 'Auditor'])
        
        # Eliminar duplicados si los hay y aplicar el orden
        final_order = []
        for item in columnas_ordenadas_final_con_data:
            if item not in final_order:
                final_order.append(item)

        df = df[final_order]

        # --- Generación de código Python de estadísticas ---
        codigo_estadisticas = generar_codigo_estadisticas(df)
        
        # --- Generación de las tablas de frecuencia (las estadísticas directas) ---
        
        # 1. Prioridad
        df_prioridad = df['Prioritaria'].value_counts().rename_axis('Prioritaria').reset_index(name='Cantidad')
        
        # 2. Régimen
        # Nota: Usamos solo el primer valor (antes del primer salto de línea) para el conteo de estadísticas.
        df_regimen = df['Régimen'].apply(lambda x: x.split('\n')[0]).value_counts().rename_axis('Régimen').reset_index(name='Cantidad')
        
        # 3. Top Conducta Sancionable
        df_conducta_top = df['Conducta Sancionable'].apply(lambda x: x.split('\n')[0]).value_counts().nlargest(10).rename_axis('Conducta Sancionable').reset_index(name='Cantidad')

        # 4. Años de Investigación (Desnormalizado)
        años = df['Año de Investigación'].astype(str).str.split(', ').explode()
        df_años = años[años != 'No determinado'].value_counts().rename_axis('Año Fiscal').reset_index(name='Cantidad').sort_values('Año Fiscal')

    
        # 3: Generación de DataFrame para Hoja "Priorización" (Explosión por Año) ---
        filas_priorizacion = []
        
        # Columnas base que queremos en Priorización (mismas que Resultados)
        cols_priorizacion = df.columns.tolist() 
        
        # Año actual para el cálculo de prioridad individual
        # Si estamos en 2025, años <= 2023 son prioritarios.
        anho_actual_sistema = datetime.now().year

        for _, row in df.iterrows():
            # Obtener el valor original y asegurar que sea string limpio
            val_anio = row['Año de Investigación']
            anios_investigacion_str = str(val_anio).strip() if pd.notna(val_anio) else ""
            
            doc_limpio = limpiar_identificacion(row.get('Documento Denunciado', ''))
            
            # --- Lógica robusta de separación de años ---
            lista_anios = []
            
            # Validamos si es un valor que se deba dividir
            if not anios_investigacion_str or anios_investigacion_str.lower() in ['no determinado', 'nan', 'none', '']:
                # Si no hay año determinado, se deja una sola fila con el valor original
                lista_anios = [anios_investigacion_str]
            else:
                # Separar por comas eliminando espacios vacíos
                # Esto convierte "2019, 2020, 2021" en ["2019", "2020", "2021"]
                lista_anios = [a.strip() for a in anios_investigacion_str.split(',') if a.strip()]
            
            # Seguridad: Si la lista quedó vacía por algún motivo, poner el valor original
            if not lista_anios:
                lista_anios = [anios_investigacion_str]

            # --- Generar una fila INDEPENDIENTE por cada año encontrado ---
            for anio_inv in lista_anios:
                # Convertir a diccionario para crear una instancia totalmente nueva e independiente
                nueva_fila = row.to_dict()
                
                # 1. SOBRESCRIBIR el Año de Investigación con el año individual
                nueva_fila['Año de Investigación'] = anio_inv
                
                # 2. Recalcular PRIORIDAD para este año específico
                # La prioridad global del caso puede ser 'Si', pero para un año reciente (ej. 2024) podría ser 'No'.
                nueva_prioridad = 'No'
                if anio_inv.isdigit():
                    try:
                        anio_num = int(anio_inv)
                        # Regla: Si el año es 2 o más años anterior al actual, es prioritario
                        if anio_num <= anho_actual_sistema - 2:
                            nueva_prioridad = 'Si'
                    except ValueError:
                        pass # Si no es numérico, se queda en 'No'
                
                nueva_fila['Prioritaria'] = nueva_prioridad

                # 3. Calcular Beneficio y Datos ESPECÍFICOS para este año puntual
                ben_aud = 'NO'
                anio_ben_aud = ''
                firmeza = ''
                dir_seccional = ''
                
                if doc_limpio and beneficio_map and doc_limpio in beneficio_map:
                    # Verificar si este año específico (anio_inv) tiene beneficio
                    clave_anio = str(anio_inv).strip()
                    
                    if clave_anio in beneficio_map[doc_limpio]:
                        data_anio = beneficio_map[doc_limpio][clave_anio]
                        
                        ben_aud = 'SI'
                        anio_ben_aud = data_anio['texto']
                        firmeza = data_anio['firmeza']
                        dir_seccional = data_anio.get('direccion', '') 
                
                # Asignar los valores específicos a la fila desagregada
                nueva_fila['Beneficio Auditoria'] = ben_aud
                nueva_fila['Año Beneficio Auditoria'] = anio_ben_aud
                nueva_fila['Fecha Firmeza'] = firmeza
                
                # Limpiar dirección seccional si no hay beneficio en este año específico
                if ben_aud == 'SI':
                    nueva_fila['Dirección Seccional'] = dir_seccional
                else:
                    nueva_fila['Dirección Seccional'] = ''

                filas_priorizacion.append(nueva_fila)
                
        # Crear DataFrame final desde la lista de filas expandidas
        df_priorizacion = pd.DataFrame(filas_priorizacion)
        
        # Asegurar que las columnas mantengan el orden correcto
        # Si el DataFrame quedó vacío (caso raro), asegurarse de tener las columnas
        if df_priorizacion.empty:
             df_priorizacion = pd.DataFrame(columns=cols_priorizacion)
        else:
             df_priorizacion = df_priorizacion[cols_priorizacion]
                    
                    
        # --- Creación del DataFrame de Estadísticas (Hoja 'Estadísticas') ---
                
        # Inicializar el writer para escribir en el mismo archivo
        writer = pd.ExcelWriter(ruta_archivo_salida, engine='openpyxl')    
        # 1. Escribir la primera hoja con los resultados del procesamiento
        df.to_excel(writer, sheet_name='Resultados', index=False)
        df_priorizacion.to_excel(writer, sheet_name='Priorización', index=False)
            
        # 2. Escribir las Tablas de Frecuencia y el Código en la hoja 'Estadísticas'
            
        # Posición inicial para escribir
        fila_inicio = 0
            
        # Escribir Prioridad
        writer.sheets['Estadísticas'] = pd.ExcelWriter(ruta_archivo_salida, engine='openpyxl').sheets.get('Estadísticas', None)
        df_prioridad.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_prioridad) + 2
            
        # Escribir Régimen
        pd.DataFrame({'TITULO': ['Distribución por Régimen']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_regimen.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_regimen) + 2

        # Escribir Conducta Sancionable
        pd.DataFrame({'TITULO': ['Top 10 Conductas Sancionables']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_conducta_top.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_conducta_top) + 2
            
        # Escribir Años Fiscales
        pd.DataFrame({'TITULO': ['Distribución por Año Fiscal']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_años.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_años) + 2

        # Escribir el Código Python para la generación de gráficas (en una columna separada)
        df_codigo = pd.DataFrame({'Código Python para Gráficas (Ejecutar localmente)': [codigo_estadisticas]})
        df_codigo.to_excel(writer, sheet_name='Estadísticas', startrow=0, startcol=4, index=False)

        # 3. Generación de la hoja de Investigación
        df_investigacion = identificar_patrones_investigacion(df.copy())
        # 4. Escribir la hoja de Investigación
        if not df_investigacion.empty:
            df_investigacion.to_excel(writer, sheet_name='Investigación', index=False)
        else:
            # Crear una hoja vacía si no hay patrones
            df_vacio = pd.DataFrame({'Mensaje': ['No se encontraron patrones de investigación ampliados.']})
            df_vacio.to_excel(writer, sheet_name='Investigación', index=False)


        # 5. Escribir las hojas de reparto por auditor (orden alfabético de los nombres)
        for auditor_nombre in sorted(df_asignaciones.keys()):
        # Reordenar las columnas en la hoja de auditor para incluir Normatividad y Puntos de Auditoria
            df_auditor = df_asignaciones[auditor_nombre].drop(columns=['index'], errors='ignore')
            
        # Orden de las columnas de clasificación para las hojas de auditor
        cols_clasificacion_auditor = ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria']
                
        # Obtener el orden actual de columnas (sin las nuevas de clasificación)
        current_cols = [col for col in df_auditor.columns if col not in cols_clasificacion_auditor]
                
        # Reinsertar las columnas de clasificación en la posición deseada (después de Impuesto / Infracción)
        # Primero, encontrar el índice de 'Impuesto / Infracción'
        idx_impuesto = current_cols.index('Impuesto / Infracción') if 'Impuesto / Infracción' in current_cols else len(current_cols)
            
        # Crear la nueva lista de columnas ordenadas
        final_cols_auditor = current_cols[:idx_impuesto + 1] + ['Normatividad', 'Puntos de Auditoria'] + current_cols[idx_impuesto + 1:]
                
        # Limpiar duplicados si se agregaron previamente (seguro contra errores de lógica)
        final_cols_auditor = list(dict.fromkeys(final_cols_auditor))
                
        df_auditor = df_auditor[final_cols_auditor]

        df_auditor.to_excel(writer, sheet_name=auditor_nombre, index=False)
            
        # 6. Aplicar el formato de Excel ANTES de guardar
        aplicar_formato_excel(writer)

        # 7. Guardar el archivo
        writer.close()
            
        print(f"El archivo con las conclusiones, estadísticas y hojas de reparto ha sido guardado en: {ruta_archivo_salida}")
            

    except FileNotFoundError:
        print(f"Error: El archivo '{ruta_archivo_entrada}' no se encontró.")
    except Exception as e:
        print(f"Ocurrió un error inesperado: {e}")

if __name__ == "__main__":
    # Inicializar tkinter
    root = tk.Tk()
    root.withdraw() # Ocultar la ventana base pequeña

    # --- CORRECCIÓN: Forzar que la ventana aparezca al frente ---
    # Esto evita que el diálogo se abra detrás del editor de código o carpeta
    root.attributes('-topmost', True) 
    # -----------------------------------------------------------

    print("Abriendo ventana para seleccionar el archivo de DENUNCIAS...")
    
    # Se agrega parent=root para asegurar que herede la propiedad 'topmost'
    ruta_archivo_entrada = filedialog.askopenfilename(
        parent=root, 
        title="Seleccione el archivo de DENUNCIAS",
        filetypes=[("Archivos de Excel", "*.xlsx *.xls")]
    )

    # Una vez cerrado el diálogo, podemos desactivar el topmost por si acaso (opcional)
    # root.attributes('-topmost', False) 

    if not ruta_archivo_entrada:
        print("No se seleccionó el archivo de denuncias. Operación cancelada.")
        root.destroy() # Cerrar recursos de tkinter si cancela
    else:
        print(f"Archivo de denuncias seleccionado: {os.path.basename(ruta_archivo_entrada)}")
        
        # PREGUNTA DE VALIDACIÓN (También vinculada a root)
        realizar_cruce = messagebox.askyesno(
            "Cruce de Información", 
            "¿Desea realizar el cruce de información con Beneficio de Auditoría?",
            parent=root
        )
        
        ruta_archivo_beneficio = None
        
        if realizar_cruce:
            print("Abriendo ventana para seleccionar el archivo de BENEFICIO DE AUDITORIA...")
            ruta_archivo_beneficio = filedialog.askopenfilename(
                parent=root,
                title="Seleccione el archivo de BENEFICIO DE AUDITORIA",
                filetypes=[("Archivos de Excel", "*.xlsx *.xls")]
            )
            
            if not ruta_archivo_beneficio:
                print("No se seleccionó archivo de beneficio. Se continuará sin el cruce.")
            else:
                print(f"Archivo de beneficio seleccionado: {os.path.basename(ruta_archivo_beneficio)}")
        else:
            print("Usuario seleccionó NO realizar cruce de Beneficio de Auditoría.")

        # Destruimos la instancia de tkinter ya que no la necesitamos para el procesamiento pandas
        root.destroy()

        # Definir ruta de salida automáticamente en la misma carpeta del archivo de entrada
        directorio_base = os.path.dirname(ruta_archivo_entrada)
        ruta_archivo_salida = os.path.join(directorio_base, "denuncias_procesadas.xlsx")

        # Ejecutar el proceso (ruta_archivo_beneficio puede ser None)
        procesar_denuncias(ruta_archivo_entrada, ruta_archivo_salida, ruta_archivo_beneficio)
