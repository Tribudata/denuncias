# -*- coding: utf-8 -*-
import pandas as pd
import re
from datetime import datetime
import os
import time  # <--- IMPORTADO PARA EL TEMPORIZADOR
import unicodedata
from difflib import SequenceMatcher
from openpyxl.styles import Alignment, Border, Side, Font, PatternFill
from openpyxl.utils import get_column_letter
import tkinter as tk
from tkinter import filedialog, messagebox
import tkinter.ttk as ttk 

try:
    import ollama
except ImportError:
    ollama = None 

# =============================================================================
# DEFINICIÓN DE REGLAS 
# =============================================================================

reglas_conclusion = {
    'Aduanero': {
        'reglas': {
            'contrabando abierto': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Contrabando abierto', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Art. 294 y 295 del Decreto 1165 de 2019', 'Puntos de Auditoria': 'Proponer acción de control que permita establecer la legal procedencia de las mercancías', 'palabras_clave': [{'contrabando','mercancia de contrabando','ingresan de contrabando','ingresa contrabando','mercancia iliegal','precios muy bajos','precios bajos','bajos precios','precio muy inferior','contrabandeando'}]},
            'ejercer actividades aduaneras sin autorización ': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Ejercer actividades aduaneras sin autorización ', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Art. 119 del Decreto 1165 de 2019', 'Puntos de Auditoria': 'Determinar la infracción dependiendo del tipo de usuario aduanero', 'palabras_clave': [{'ejercer actividades aduaneras','aduaneras sin autorizacion'}]},
            'el valor declarado de la mercancia no corresponde': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'El valor declarado de la mercancía no corresponde', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Art. 52 del Decreto 1165 de 2019', 'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos', 'palabras_clave': [{'valor no corresponde','valor declarado','valor declarado no corresponde'}]},
            'errada clasificacion arancelaria': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Errada clasificacion arancelaria', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Art. 119 del Decreto 1165 de 2019', 'Puntos de Auditoria': 'Verificación de la posición arancelaria y descripción de mercancía.', 'palabras_clave': [{'clasificación', 'clasificacion', 'arancelaria','clasificando'}]},
            'exportacion ficticia': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Exportación ficticia', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Art. 31 del Decreto 920 de 2023', 'Puntos de Auditoria': 'Verificación de ingreso de divisas y existencia física de la mercancía.', 'palabras_clave': [{'exportacion', 'exportacion', 'exportacion ficticia','exportacion ficticio','exportacion fictisia','exportacion fictisio'}]},
            'incumplimiento de requisitos previos': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Incumplmineto de requisitos previos', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Arts. 66 y 69 Decreto 920 de 2023', 'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos.', 'palabras_clave': [{'requisitos previos','incumple requisitos previos','control aduanero','toda la cadena legal'}]},
            'incumplimiento de reglamentos tecnicos': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Incumplimiento de reglamentos tecnicos', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Documento técnico de la entidad que regula', 'Puntos de Auditoria': 'Verificar las importaciones en los aplicativos y documentos tecnicos de la entidad que regula.', 'palabras_clave': [{'incumplimiento requisitos', 'etiquetado', 'reglamento tecnico','reglamentos tecnicos'}]},
            'suministrar informacion o documentacion inexacta o irregular': {'Conducta': 'Aduanera', 'Conducta Sancionable': 'Suministrar información o documentación inexacta o irregular', 'Impuesto / Infracción': 'Infracción aduanera', 'Normatividad': 'Arts. 66 y  69 Decreto 920 de 2023', 'Puntos de Auditoria':'Verificar las importaciones en los aplicativos.', 'palabras_clave': [{'documentos irregulares','documentacion irregular','documentos inexacta','lista de empaque'}]},
        }
    },
    'Cambiario': {
        'reglas': {
            'canalizar operaciones diferentes a las autorizadas': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Canalizar operaciones diferentes a las autorizadas','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave': [{'canalizar operaciones','canaliza'}]},
            'ejercer actividades cambiarias sin autorización': {'Conducta': 'Cambiaria','Conducta Sancionable': 'ejercer actividades cambiarias sin autorización','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave': [{'ejercer actividades cambiarias','cambiarias sin autorizacion'}]},
            'extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave': [{'extinguir operaciones','medios diferentes','liquidar operaciones'}]},
            'no presentar o no transmitir al Banco de la República las operaciones': {'Conducta': 'Cambiaria','Conducta Sancionable': 'No presentar o no transmitir al Banco de la República las operaciones','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave': [{'no ha presentado informacion al banco de la republica','no ha transmitido informacion al banco de la republica','no ha eviado informacion al banco de la republica'}]},
            'no presentar o no transmitir información exogena cambiaria a la DIAN': {'Conducta': 'Cambiaria','Conducta Sancionable': 'No presentar o no transmitir información exogena cambiaria a la DIAN','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave': [{'no ha presentado informacion exogena cambiaria','no ha presentado exogena cambiaria','no ha transmitido informacion exogena cambiaria','no ha transmitido exogena cambiaria','informacion cambiaria'}]},
            'pagar o recibir pagos a través del mercado no cambiario por operaciones canalizables': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Pagar o recibir pagos a través del mercado no cambiario por operaciones canalizables','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Ley 2245 de 2011','Puntos de Auditoria': 'Verificar información exógena cambiaria.','palabras_clave':[{'canaliza','mercado cambiario','cambiario','no cambiario'}]},
            'realizar operaciones de compra y venta de divisas sin autorizacion': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Realizar operaciones de compra y venta de divisas sin autorizacion','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 del Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar que el profesional de cambio este autorizado.','palabras_clave':[{'compra divisas','compra de divisas','venta divisas','venta de divisas','divisas','compra venta sin autorizacion','operaciones de cambio'}]},
            'transmitir al Banco de la República en forma extemporánea': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Transmitir al Banco de la República en forma extemporánea','Impuesto / Infracción': 'Infracción cambiaria','Normatividad': 'Art. 3 del Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar en la exogena la existencia de cuentas de compensación.','palabras_clave':[{'banco de la republica','extemporanea al banco de la republica'}]},
            'transmitir a la DIAN información exogena cambiaria en forma extemporánea': {'Conducta': 'Cambiaria','Conducta Sancionable': 'Transmitir a la DIAN información exogena cambiaria en forma extemporánea','Impuesto / Infracción': 'Infraccion cambiaria','Normatividad': 'Art. 3 del Decreto 2245 de 2011','Puntos de Auditoria': 'Verificar en la exogena la existencia de cuentas de compensación.','palabras_clave':[{'exogena cambiaria','envia exogena cambiaria'}]},
        }
    },
    'Tributario': {
        'reglas': {                  
            'evade impuestos': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Evade Impuestos', 'Impuesto / Infracción': 'Revisión tributaria integral', 'Normatividad': 'Art. 647 E.T.', 'Puntos de Auditoria': 'Cruce de patrimonio, ingresos y gastos.', 
                'palabras_clave': [{'evade','evadir','evasion','evasión','evacion','evación','ventas', 'totales','no presenta','dejo de presentar','no presentó','no presento','no declaró','no declaro','evadiendo impuestos','evasion de impuestos','evasores','fraude','fraudulentos','evadiendo','no paga impuestos','no paga impuesto','no paga los impuestos','evada impuestos','en efectivo','evadido','recibe efectivo','recibe en efectivo','pago de impuestos','fraudulenta','bajar la base','robo de impuestos','base menor','investiguen','investigacion','omitiendo el pago los impuestos','evadieran impuestos','evasora fiscal','evasor fiscal','sin pago de impuestos','pagar menos impuestos','evasoras','pagar impuestos','evasor','tributan de acuerdo a la ley','temas de impuestos','nunca han sido reportadas','no dan facturas','sin factura','sin factura legal','sin factura de venta','bajar impuestos','bajar impuesto','debidamente declarados','sustanciales','formales','delito fiscal','evadiendo','carece de veracidad','abuso tributario','no declarar impuestos','patrimonio injustificado','no paga ningun impuesto','no pagan impuestos','no cancela impuesto','facturas falsas','eludir impuestos','normas tributarias','renta falsas','no es declarado','no los declaran','lavado','maquillados los estados financieros','transacciones no legales','disminuir el valor a pagar','evitar el pago','omite informacion','infrecciones tributarias','infracciones tributarias','evadir impuestos','no pago tributario','sin cumplir las obligaciones tributarias','nunca declaro impuestos','no lo declaran','no ha pagado impuestos'}],
                'palabras_negativas': ['me acusa', 'me denuncia', 'dice que yo', 'presuntamente', 'supuestamente', 'sin pruebas', 'falsa denuncia'], 
                'palabras_refuerzo': ['es evidente', 'tengo pruebas', 'adjunto', 'sistematicamente', 'claramente']}, 
            'extemporaneidad en la presentacion de las declaraciones': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Extemporaneidad en la presentacion de las declaraciones', 'Impuesto / Infracción': 'Declaración Extemporánea', 'Normatividad':'Arts. 641 - 642 - 645 y 804 E.T', 'Puntos de Auditoria':'Verificar la fecha de vencimiento establecida en el calendario tributario...', 'palabras_clave': [{'no calcula sancion','extemporanea','despues de la fecha'}]},
            'no declara activos en el exterior': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No declara activos en el exterior', 'Impuesto / Infracción': 'Declaración Activos en el exterior', 'Normatividad':'Arts. 574 Num. 5, 607 y 643 E.T.', 'Puntos de Auditoria':'Verificar con fundamento en los documentos aportados...', 'palabras_clave': [{'activos en el exterior','fuera del pais','activos fuera del pais'}]},
            'no declara impuesto al consumo': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No Declara Impuesto al Consumo', 'Impuesto / Infracción': 'Impuesto al consumo', 'Normatividad':'Arts. 512-1 y 643 E.T.', 'Puntos de Auditoria':'Verificar la responsabilidad del contribuyente frente al impuesto nacional al consumo...', 'palabras_clave': [{'impuesto al consumo','no declara impuesto al consumo','impuesto nacional al consumo','impoconsumo'}]},
            'no declara impuesto al patrimonio': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No Declara Impuesto al Patrimonio', 'Impuesto / Infracción': 'Impuesto al patrimonio', 'Normatividad':'Arts. 292-3 y 643 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado ostenta la calidad de sujeto pasivo...', 'palabras_clave': [{'impuesto al patrimonio'}]},
            'no declara iva': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No declara IVA', 'Impuesto / Infracción': 'Impuesto sobre las ventas', 'Normatividad':'Arts. 600 y 643 E.T.', 'Puntos de Auditoria':'Verificar la correcta responsabilidad del contribuyente frente al impuesto sobre las ventas...', 'palabras_clave': [{'no declara iva','no declara IVA', 'no cobra iva', 'no paga iva','recaudo de iva','recaudo del iva','no factura iva','no facturar iva','recaudo del iva','recaudo de iva','sin iva','recaudo del impuesto iva','mercancia sin iva','19%','bajar el iva','sin generar el impuesto','mal manejo en el iva','no cobran iva','hecho generador del iva','sin la generacion del iva','generacion del iva','factura con iva','evitar pagar iva','obligación de declarar el iva','recauda el iva','recauda iva','no lo paga','ni cobra iva','no paga iva','no paga el iva','no cobra iva','no cobra el iva','no reportan el iva','no reporta iva','reflejan el pago de iva','no pagar iva','no pagar impuesto de iva','a pagar de iva','con el pago del iva','con el pago de iva','nunca lo paga'}]},
            'no declara regimen simple de tributacion': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'Regimen simple de tributacion', 'Impuesto / Infracción': 'Declaración anual consolidada RST', 'Normatividad':'Arts. 910 y 643 E.T.', 'Puntos de Auditoria':'Verificar en el Registro Único Tributario – RUT si el contribuyente ostenta la responsabilidad...', 'palabras_clave': [{'regimen simple de tributacion', 'no declara rst','no presenta rst','no declaro regimen simple de tributacion','rst'}]},
            'no declara impuestos saludables': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'Regimen simple de tributacion', 'Impuesto / Infracción': 'Declaración anual consolidada RST', 'Normatividad':'Arts. 910 y 643 E.T.', 'Puntos de Auditoria':'Verificar en el Registro Único Tributario – RUT si el contribuyente ostenta la responsabilidad...', 'palabras_clave': [{'comestibles','ultraprocesados','azucares','sodio','grasas','saturadas'}]},
            'no declara renta': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No Declara Renta', 'Impuesto / Infracción': 'Renta y Complementarios', 'Normatividad':'Arts. 574 y 643 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado ostenta la calidad de sujeto pasivo...', 'palabras_clave': [{'no paga impuestos','no declara renta','no presenta renta','no declara impuestos','no presenta declaracion de renta','omiso','omiso en renta','no presento','no presento declaración de renta','contribuyente impuesto sobre la renta','nunca ha declarado rentas','omision','no se declaro renta','si ha declarado','no declarar ante la dian','presentar la declaracion','no declaran','no declaracion','jamas han declarado','obligado a declarar','no ha declarado sus ingresos','no ha realizado la declaracion','presentar declaraciones'}]},
            'no declara retencion en la fuente': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No declara retencion en la fuente', 'Impuesto / Infracción': 'Retención en la Fuente', 'Normatividad':' Arts. 368, 368-2 y 643 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor...', 'palabras_clave': [{'no declara retencion','no delcara retencion en la fuente'}]},
            'no efectua retencion en la fuente': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'no efectua retencion en la fuente', 'Impuesto / Infracción': 'Retención en la Fuente', 'Normatividad':' Arts. 368, 368-2,574 y 643 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor...', 'palabras_clave': [{'no efectua retencion','no retiene','no practica retencion','no efectua retencion','no esta practicando','no se esta practicando retencion','no efectuaron las retenciones','debian retenerme','no aplico las retenciones'}]},
            'no paga impuesto de timbre': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No Paga Impuesto de Timbre', 'Impuesto / Infracción': 'Impuesto de timbre', 'Normatividad':'Arts. 519 y 643 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado ostenta la calidad de agente retenedor...', 'palabras_clave': [{'impuesto de timbre', 'no paga impuesto de timbre','no cancela el impuesto de timbre','no realiza el pago del impuesto de timbre'}]},
            'no presenta informes precios de transferencia': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'No presenta informes precios de transferencia', 'Impuesto / Infracción': 'Declaración Informativa y/o documentación comprobatoria de precios de transferencia', 'Normatividad':'Arts. 260-1, 260-5, 260-9 y 260-11', 'Puntos de Auditoria':'Verificar con base en los anexos adjuntados a la respectiva denuncia...', 'palabras_clave': [{'precios de transferencia', 'informe local','documentacion comprobatoria'}]},
            'retiene en la fuente y no consigna': {'Conducta': 'Incumplimiento de la Obligación Formal de Declarar', 'Conducta Sancionable': 'Retiene en la fuente y no consigna', 'Impuesto / Infracción': 'Retención en la Fuente', 'Normatividad':'Arts. 574 y 643 E-T', 'Puntos de Auditoria':'verificar si el contribuyente denunciado ostenta la calidad de agente retenedor...', 'palabras_clave': [{'no consigna la retencion','no consigna los valores retenidos','retiene y no paga','no paga retencion'}]},
            'cobra tarifas en iva diferentes': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Cobra tarifas en IVA diferentes a las legales', 'Impuesto / Infracción': 'Impuesto sobre las ventas', 'Normatividad':'468, 468-1, 468-3, 477 y 647 E.T.', 'Puntos de Auditoria':'Verificar, en concordancia con lo dispuesto en los artículos 468...', 'palabras_clave': [{'tarifas diferentes','tarifa diferente','tarifa que no corresponde','a otra trifa','exentos de iva','exentos','excluidos','gravados con iva','cobro indebido del impuesto al valor agregado','cobro indebido del iva'}]},
            'consigna ingresos propios en cuentas de terceros': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Consigna ingresos propios en cuentas de terceros', 'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo', 'Normatividad':'Art. 755-3 E.T.', 'Puntos de Auditoria':'Verificar los ingresos del contribuyente denunciado a partir de la información registrada...', 'palabras_clave': [{'consigna ingresos de terceros','en cuentas de terceros','facilite mi cuenta','consignar dineros','consigna dinero'}]},
            'dinero depositados en paraisos fiscales': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Dinero depositados en paraisos fiscales', 'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio', 'Normatividad':'Art. 239-1 E.T.', 'Puntos de Auditoria':'De acuerdo con los documentos anexos a la denuncia que sustentan...', 'palabras_clave': [{'paraiso', 'paraisos', 'paraisos fiscales', 'paraiso fiscal'}]},
            'doble facturacion': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Doble facturación', 'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo', 'Normatividad':'Art. 647 Num. 1', 'Puntos de Auditoria':'De acuerdo con los anexos adjuntados a la denuncia, verificar si el contribuyente denunciado...', 'palabras_clave': [{'doble facturacion'}]},
            'incluye costos no procedentes': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Incluye costos no procedentes', 'Impuesto / Infracción': 'Renta y Complementarios', 'Normatividad':'Art. 647 Num. 3 E.T.', 'Puntos de Auditoria':'Verificar, con base en los anexos y los hechos expuestos en la denuncia...', 'palabras_clave': [{'costos','procedentes','deducciones','incluir','incluye','soporte de gastos','soporte para los gastos','deducibles inexistentes','bancarizacion','documento falso','documento que es falso','nunca realice','sin comprobante legal','gastos ficticios'}]},
            'incluye pasivos inexistentes': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Incluye pasivos inexistentes', 'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio', 'Normatividad':'Art. 239-1 E.T.', 'Puntos de Auditoria':'De acuerdo con los documentos anexos a la denuncia que sustentan...', 'palabras_clave': [{'pasivos','pasivo','pasivos inexistentes','obligaciones inexistentes'}]},
            'no declara retención en la fuente correctamente': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'no declara retención en la fuente correctamente', 'Impuesto / Infracción': 'Retención en la Fuente', 'Normatividad':'Art. 647 Num. 2', 'Puntos de Auditoria':'Conforme a lo establecido en los artículos 368 y 368-2 del Estatuto Tributario...', 'palabras_clave': [{'no declara retencion correctamente','no reporta retenciones','no realizo la presentacion de las retenciones'}]},
            'no declara impuesto de timbre correctamente': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'no declara impuesto de timbre correctamente', 'Impuesto / Infracción': 'Impuesto de timbre nacional', 'Normatividad':'Arts. 519 y 647 Num. 2', 'Puntos de Auditoria':'Conforme a lo previsto en el artículo 519 del Estatuto Tributario...', 'palabras_clave': [{'timbre'}]},
            'omite activos': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Omite activos', 'Impuesto / Infracción': 'Renta y Complementarios e impuesto al patrimonio', 'Normatividad':'Art. 239-1 E.T.', 'Puntos de Auditoria':'De acuerdo con los documentos anexos a la denuncia que sustentan un presunto ocultamiento de activos...', 'palabras_clave': [{'omitir activos','omite activos','activos','activo','se ha declarado'}]},
            'omite ingresos': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Omite Ingresos', 'Impuesto / Infracción': 'Impuesto sobre la renta, impuesto sobre las ventas e impuesto al consumo', 'Normatividad':'Art. 647 E.T.', 'Puntos de Auditoria':'Verificar, a partir de los cruces de información entre las declaraciones de renta...', 'palabras_clave':[{'omite ingresos'},{'omision de ingresos'},{'no declara ingresos'},{'oculta ingresos','no declara todos los ingresos','no declaran todos los ingresos','recibe intereses','recibe arrendamientos','ingresos declarados debidamente','ingresos declarados indebidamente','sin factura','ingresos fueron mayores','ingresos no declarados','ingresos inferiores','facturando un menor valor','no es declarado','no declaran todos los ingresos','no los declaran','no reporta ningun ingreso','de lo ingresado','sus ingresos'}]},
            'costos o gastos originados con Proveedor ficticio': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Costos o gastos originados con Proveedor ficticio', 'Impuesto / Infracción': 'Renta y Complmentarios', 'Normatividad':'Art. 647-3 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado registra operaciones con terceros...', 'palabras_clave':[{'proveedor ficticio'}]},
            'retiene en la fuente a tarifas diferentes a las legales': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Retiene en la fuente a tarifas diferentes a las legales', 'Impuesto / Infracción': 'Retención en la Fuente', 'Normatividad':'Art. 647 Num. 2', 'Puntos de Auditoria':'Verificar, en concordancia con lo dispuesto en los artículos 392, 395 y 401...', 'palabras_clave':[{'aplica retencion en la fuente con tarifas distintas','tarifas diferentes','efectua retenciones en la fuente con tarifas','practica retención en la fuente a una tarifa','realiza retencion en la fuente con una tarifa'}]},
            'solicita beneficios fiscales inexistentes': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Solicita beneficios fiscales inexistentes', 'Impuesto / Infracción': 'Renta y Complementarios', 'Normatividad':'Art. 647 Num. 3 E.T.', 'Puntos de Auditoria':'Verificar, con base en el hecho denunciado y los anexos aportados...', 'palabras_clave': [{'exenciones', 'beneficios fiscales','beneficios tributarios'}, {'beneficio tributario','exenciones tributarias'}]},
            'inexactitud declaraciones tributarias': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'inexactitud declaraciones tributarias', 'Impuesto / Infracción': 'Renta y Complementarios', 'Normatividad':'Art. 23, 13-1, 23-2 y 647 Num. 6 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado a partir de esta verificación...', 'palabras_clave': [{'sin la firma','inexactos','inexacto','inexactitud','presenta con información erronea'}]},
            'inexactitud declaracion ingresos y patrimonio': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'inexactitud declaracion ingresos y patrimonio', 'Impuesto / Infracción': 'Renta y Complementarios', 'Normatividad':'Art. 23, 13-1, 23-2 y 647 Num. 6 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado tiene la obligación de presentar...', 'palabras_clave': [{'ingresos y patromonio'}]},
            'utiliza documentos presuntamente falsos': {'Conducta': 'Inexactitud en las declaraciones tributarias', 'Conducta Sancionable': 'Utiliza documentos presuntamente falsos', 'Impuesto / Infracción': 'Impuesto sobre la renta', 'Normatividad':'Art. 647 Num. 6 E.T.', 'Puntos de Auditoria':'Verificar la realidad económica de las operaciones efectuadas por el contribuyente denunciado...', 'palabras_clave': [{'documentos falsos','documento falso','documentos irregulares'}]},
            'no factura': {'Conducta': 'Facturación', 'Conducta Sancionable': 'No factura', 'Impuesto / Infracción': 'Factura Electrónica', 'Normatividad':'Arts. 615 y 652-1 E.T. - Res. 165/2023', 'Puntos de Auditoria':'Verificar, de acuerdo con los requerimientos establecidos en la normativa tributaria vigente...',
                          'palabras_clave': [{'anomalias en las facturas','sin expedir ningun tipo de factura','no expide una factura','no factura','no factura legalmente','no expide factura','no emite factura','no emiten factura','no emite factura electronica','no da factura', 'sistema de facturacion electronica', 'sistema de facturacion','no emitieron','recibos de caja','recibo de caja','no me da recibo','no recibir las facturas','le emite factura','no hace facturas','no hace factura','facturar electronicamente','me la enviaban','no es una factura electronica','nunca recibieron en su correo electronico estas facturas','solicitando la factura','resolucion vencida','de mi factura','se niega a generar factura','nunca me han entregado','no me envian','no expiden factura electronica','no expiden ningun tipo de factura','solicite la factura','expedir una factura','no entregan factura','no entrega factura','no los facturan','niega a presentar la factura','no necesitaba factura','factura generada','no dan facturas','no dan factura','no dan la factura','irregularidades en la facturacion','irregularidades en la factura','sin la respectiva factura','factura cuando el cliente se lo exige','no les aportaron la factura','hemos solicitado la factura','ellos no generaban factura','ni de venta','facturas manuales','no expedicion de la factura','me enviarian una factura','nunca entregan','no va a generar las facturas','dudo que esten facturando','exigi la factura','no llego','ni se emiten facturas','no cumple con los parametros','la factura no es original','no estan expidiendo','correspondiente factura','no me las remiten','no me la remiten','facturacion electronica','obligaciones tributarias','por un valor diferente','no me expidieron factura','no emitian factura','no pueden generar facturas','se niega a entregarme','me la enviarian','no expedian factura','solicitar la factura','no entrega factura','no la generan','jamas dan factura','no entrega ningun tipo de factura','se negaron a entregarla','no emitir factura','factura de papel','no me la envia','no me quisieron entregar','se niegan a entregar','no han entregado','al solicitarla','no se esta expidiendo','no se entrega factura','no emiten','no tiene factura','no emitirla','no emitirlas','no la mandaron','no expedicion de factura','no me proporcionaron','entregaron la factura','entregaron factura','a entregar','no me quiere','no esta entregando','no me han proporcionado',' no ha enviado','no realiza factura','no nos podian generar','no podian generar','sin que me entregaran'}],
                          'palabras_negativas': ['si factura', 'siempre entrega', 'entrega factura', 'expide correctamente', 'factura legal'],
                          'palabras_refuerzo': ['nunca entrega', 'se niega a', 'le pedi y no me dio', 'compra sin factura', 'no me dio factura','no puede expedir']},
            'factura sin requisitos': {'Conducta': 'Facturación', 'Conducta Sancionable': 'Factura sin requisitos', 'Impuesto / Infracción': 'Factura Electrónica', 'Normatividad':'Arts. 615 y 652 E.T. - Res. 165/2023', 'Puntos de Auditoria':'Revisión de la información mínima de la factura.','palabras_clave': [{'irregularidades en facturacion','sin requisitos','sin el lleno de requisitos','con todos los requisitos','mismo numero','comprado a mi nombre','factura falsa','facturacion falsa','no realice compras','facturas suministradas','clientes que no existen','discrimina el iva','datos correctos','nunca he comprado','facturacion indebida','compras no realizadas','facturas electronicas adulteradas','facturas electronicas a mi nombre','nota credito','nunca compre','no se realizaron las compras','yo no he comprado','irregularidad en la facturacion','recibido facturacion','las facturas vienen con mi numero','no tenemos relaciones comerciales','no hice tal compra','no registro en la factura','cufe no aparece','desconozco las compras','se encuentra errado','codigo qr','documento errado','expidio factura sin mi consentimiento'}]},
            'errores envio informacion exogena': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'Errores envío información exógena', 'Impuesto / Infracción': 'Suministro información', 'Normatividad':'Arts. 631 y  651 E.T.', 'Puntos de Auditoria':'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria...', 'palabras_clave':[{'error informacion exogena','errores informacion exogena','errores exogena','error exogena','exogena erronea','mal diligenciado','erradamente la informacion'}]},
            'inscrito en el regimen de iva que no corresponde': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'Inscrito en el regimen de IVA que no corresponde', 'Impuesto / Infracción': 'Obligaciones formales', 'Normatividad':'Art. 658-3 E.T.', 'Puntos de Auditoria':'Verificar la realidad económica del contribuyente denunciado con el fin de establecer...', 'palabras_clave': [{'inscrito','inscribir','regimen simplificado'}]},
            'lleva doble contabilidad': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'Lleva doble contabilidad', 'Impuesto / Infracción': 'Irregularidades en la contabilidad', 'Normatividad':'Art. 655 E.T.', 'Puntos de Auditoria':'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado...', 'palabras_clave':[{'doble contabilidad','lleva doble','dos contabilidades','revisar contabilidad'}]},
            'no contabiliza todas sus operaciones': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'no contabiliza todas sus operaciones', 'Impuesto / Infracción': 'Irregularidades en la contabilidad', 'Normatividad':'Art. 655 E.T.', 'Puntos de Auditoria':'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado...', 'palabras_clave':[{'no registra','no contabiliza','todas sus operaciones','no esta registrado','acomodo las cifras','manipulan la contabilidad'}]},
            'no esta inscrito en el rut': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'No esta inscrito en el Registro Unico Tributario - RUT', 'Impuesto / Infracción': 'Obligaciones formales', 'Normatividad':'Art. 658-3 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente se encuentra debidamente inscrito en el Registro Único Tributario...', 'palabras_clave': [{'no esta inscrito','no aparece inscrito','no se encuentra inscrito','no aparece registrado','no se encuentra debidamente inscrito','no tiene rut','documentacion','no estan formalizados','no esta formalizado'}]},
            'reportado sin vinculo comercial en exogena por terceros': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'reportado sin vinculo comercial en exogena por terceros', 'Impuesto / Infracción': 'Suministro información', 'Normatividad':'Arts. 631 y  651 E.T.', 'Puntos de Auditoria':'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria...', 'palabras_clave':[{'exogena de terceros','sin vinculo','me reporto','me informo','no conozco','corrija', 'corregir', 'no reconozco','mi informacion','reconozco','mi exogena','reporte realizado por','reporte hecho por','suplantado','suplantar','realizo reporte de informacion','reporte de informacion exogena','ningun vinculo','ningun vinculo comercial','operaciones que jamas realice','operaciones que nunca realice','compras a mi nombre','se hace a mi nombre','a nombre mio','me reportaron en medios magneticos','reporte errado a mi nombre','no son ciertos','otros conceptos','no es cierta','me reporta','ingresos que no me corresponden','resulta ser falsa','reportaron pago','nunca he recibido','reporto bajo mi cedula','no corresponde a la realidad','no correponde con la realidad','exogena falsa','error en la informacion','no son reales','ninguna relacion comercial','reportadas a mi nombre','informa de manera errada','movimientos reportados','no tengo relaciones comerciales','informacion falsa','datos inexistentes','reportada por terceros','errores en el reporte ante la dian','reporte erroneo en la informacion exogena','desconozco los montos reflejados','reportes ficticios','reporte ficticio','inconsistencias en la información exogena','suministrada por terceros','pagos irreales','bajo mi nombre','correccion','a mi nombre'}]},
            'no expide certificados de retencion': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'No Expide certificados de retencion en fuente', 'Impuesto / Infracción': 'Obligaciones formales', 'Normatividad':'Art. 667 E.T.', 'Puntos de Auditoria':'De acuerdo con el hecho denunciado y los anexos adjuntos, verificar si el contribuyente denunciado...', 'palabras_clave': [{'no expide certificado','no emite certificado','no genera certificado','no entrega certificado','no proporciona certificado','certificados de retencion','certificados correspondientes','certificado de ingresos','certificados de retencion','certificado de retenciones','certificado de ingresos y retenciones','no fue certificada','expedido los certificados','no certifico las respectivas retenciones','certificado de retencion','respectivo certificado','nos emitan el certificado','se  niega a certificar'}]},
            'no lleva contabilidad': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'No lleva contabilidad', 'Impuesto / Infracción': 'Irregularidades en la contabilidad', 'Normatividad':'Art. 655 E.T.', 'Puntos de Auditoria':'De acuerdo con el hecho denunciado y los anexos aportados, verificar si el contribuyente denunciado...', 'palabras_clave':[{'no lleva contabilidad','no lleva registros contables','no realiza registros contables','no tiene libros de contabilidad','ninguna contabilidad','no tiene libros contable'}]},
            'proveedor ficticio': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'proveedor ficticio', 'Impuesto / Infracción': 'Proveedor ficticio o insolvente', 'Normatividad':'Art. 671 E.T.', 'Puntos de Auditoria':'Verificar si el contribuyente denunciado registra operaciones con terceros...', 'palabras_clave':[{'proveedor ficticio'}]},
            'solicita devoluciones improcedentes': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'Solicita devoluciones improcedentes', 'Impuesto / Infracción': 'Improcedencia de las devoluciones y/o compensaciones', 'Normatividad':'Art. 670 E.T.', 'Puntos de Auditoria':'De acuerdo con el hecho denunciado y los anexos adjuntos, verificar si existen indicios...', 'palabras_clave':[{'devolucion','solicita devoluciones improcedentes','devoluciones improcedentes'}]},
            'no reporta información exógena': {'Conducta': 'Obligaciones diferentes a declarar y pagar', 'Conducta Sancionable': 'No reporta información exógena', 'Impuesto / Infracción': 'Suministro de información', 'Normatividad':'Arts. 631 y  651 E.T.', 'Puntos de Auditoria':'Verificar, de acuerdo con los requerimientos de suministro de información de relevancia tributaria...', 'palabras_clave':[{'no reporta informacion exogena','no transmite informacion exogena','no transmitio informacion exogerna','presentar exogena','presentar informacion exogena','no ha presentado la informacion'}]},
        }
    }
}

# =============================================================================
# DICCIONARIO DE DEFINICIONES JURÍDICAS (Para contexto de la IA)
# =============================================================================
DEFINICIONES_CONDUCTAS = {
    # --- TRIBUTARIO ---
    'evade impuestos': "Realizar acciones ilegales para evitar la obligación de declarar impuestos o bajar artificialmente la base imponible.",
    'extemporaneidad en la presentacion de las declaraciones': "Presentar una declaración tributaria después de la fecha límite establecida.",
    'no declara activos en el exterior': "Omitir la presentación de la declaración de activos en el exterior estando obligado a ello.",
    'no declara impuesto al consumo': "No presentar la declaración y pago del Impuesto Nacional al Consumo.",
    'no declara impuesto al patrimonio': "Omitir la presentación de la declaración del Impuesto al Patrimonio.",
    'no declara iva': "Omitir la presentación de la declaración de IVA estando obligado.",
    'no declara regimen simple de tributacion': "Omitir la declaración anual consolidada del Régimen Simple (SIMPLE).",
    'no declara renta': "Omisión de la obligación de presentar la declaración de renta y complementarios.",
    'no declara retencion en la fuente': "Incumplir el deber de presentar la declaración periódica de Retención en la Fuente.",
    'no efectua retencion en la fuente': "No aplicar el descuento de impuestos (retención) exigido por ley al realizar un pago.",
    'no paga impuesto de timbre': "Omitir la obligación de retener/pagar el impuesto sobre documentos o transacciones específicas.",
    'no presenta informes precios de transferencia': "Omitir la presentación de documentación comprobatoria o declaración informativa de precios de transferencia.",
    'inexacto': "Incluir datos falsos, incompletos o manipulados en declaraciones tributarias.",
    'cobra tarifas en iva diferentes': "Aplicar un porcentaje de IVA que no corresponde con la tarifa oficial.",
    'consigna ingresos propios en cuentas de terceros': "Utilizar cuentas de otras personas para depositar ingresos propios y ocultar su origen.",
    'dinero depositados en paraisos fiscales': "Transferir o mantener fondos en territorios de baja imposición fiscal.",
    'doble facturacion': "Expedir dos facturas por una misma venta, reportando solo una oficialmente.",
    'incluye costos no procedentes': "Deducir gastos que no cumplen requisitos legales o no tienen relación de causalidad.",
    'incluye pasivos inexistentes': "Declarar deudas irreales para disminuir el patrimonio.",
    'no declara retención en la fuente correctamente': "Declarar valores de retención que no coinciden con la realidad.",
    'no declara impuesto de timbre correctamente': "Consignar valores incorrectos del Impuesto de Timbre.",
    'omite activos': "No incluir la totalidad de bienes y derechos en la declaración de renta.",
    'omite ingresos': "No declarar la totalidad de las entradas de dinero obtenidas.",
    'costos o gastos originados con proveedor ficticio': "Incluir costos de transacciones con proveedores inexistentes o de fachada.",
    'retiene en la fuente a tarifas diferentes a las legales': "Aplicar porcentajes de retención distintos a los establecidos por ley.",
    'solicita beneficios fiscales inexistentes': "Aplicar deducciones o exenciones que no aplican o no están vigentes.",
    'inexactitud declaracion ingresos y patrimonio': "Datos falsos en la declaración de ingresos y patrimonio.",
    'utiliza documentos presuntamente falsos': "Usar facturas o recibos alterados para soportar costos o impuestos.",
    'no factura': "No expedir factura de venta o documento equivalente estando obligado.",
    'factura sin requisitos': "Expedir facturas que no cumplen con los requisitos legales (ej. sin CUFE, sin discriminación de IVA).",
    'errores envio informacion exogena': "Incluir datos inconsistentes en los reportes de medios magnéticos.",
    'inscrito en el regimen de iva que no corresponde': "No actualizar el RUT acorde a la responsabilidad real de IVA.",
    'lleva doble contabilidad': "Mantener dos sistemas contables (uno real y otro para la DIAN).",
    'no contabiliza todas sus operaciones': "Omitir el registro contable de ciertas transacciones.",
    'no esta inscrito en el rut': "Incumplir la obligación de inscribirse en el Registro Único Tributario.",
    'reportado sin vinculo comercial en exogena por terceros': "Un tercero reporta operaciones con el contribuyente que este desconoce.",
    'no expide certificados de retencion': "No entregar el certificado de retención a quien se le practicó.",
    'no lleva contabilidad': "No tener libros contables estando obligado.",
    'proveedor ficticio': "Registrar operaciones con proveedores declarados como ficticios por la DIAN.",
    'solicita devoluciones improcedentes': "Pedir devolución de saldos a favor generados irregularmente.",
    'no reporta información exógena': "Omitir el envío de información exógena.",

    # --- ADUANERO ---
    'contrabando abierto': "Ingresar/sacar mercancías ilegalmente evadiendo control aduanero.",
    'ejercer actividades aduaneras sin autorización ': "Operar como usuario aduanero sin los permisos requeridos.",
    'el valor declarado de la mercancia no corresponde': "Sub-facturación o alteración del valor en aduana.",
    'errada clasificacion arancelaria': "Asignar una subpartida arancelaria incorrecta.",
    'exportacion ficticia': "Simular exportaciones para obtener beneficios (ej. devolución de IVA).",
    'incumplimiento de requisitos previos': "No cumplir con vistos buenos, licencias o registros antes de importar.",
    'incumplimiento de reglamentos tecnicos': "Incumplir normas de etiquetado o seguridad del producto.",
    'suministrar informacion o documentacion inexacta o irregular': "Entregar datos falsos a la autoridad aduanera.",

    # --- CAMBIARIO ---
    'canalizar operaciones diferentes a las autorizadas': "Usar mercado cambiario para fines distintos a los permitidos.",
    'ejercer actividades cambiarias sin autorización': "Profesional de cambio de divisas sin licencia.",
    'extinguir operaciones de obligatoria canalizacion por medios diferentes a los autorizados': "Pagar importaciones/exportaciones por fuera de los canales legales.",
    'no presentar o no transmitir al banco de la república las operaciones': "Omitir reporte de operaciones cambiarias al Banco Central.",
    'no presentar o no transmitir información exogena cambiaria a la dian': "Omitir reporte de información cambiaria a la DIAN.",
    'pagar o recibir pagos a través del mercado no cambiario por operaciones canalizables': "Usar mercado negro para operaciones obligatorias de canal.",
    'realizar operaciones de compra y venta de divisas sin autorizacion': "Comercio de divisas ilegal.",
    'transmitir al banco de la república en forma extemporánea': "Reportar tarde al Banco de la República.",
    'transmitir a la dian información exogena cambiaria en forma extemporánea': "Reportar tarde la exógena cambiaria."
}

# --- FUNCIONES ---

def analizar_temporalidad(texto):
    """
    Analiza la descripción de los hechos para determinar si la conducta
    está ocurriendo o ya ocurrió.
    """
    texto_minusculas = texto.lower()
    
    palabras_ocurriendo = ['esta ocurriendo', 'está sucediendo', 'actualmente', 'a la fecha', 'persiste']
    palabras_ya_ocurrio = ['ocurrió', 'sucedió', 'pasó', 'en el pasado', 'realizó']

    if any(palabra in texto_minusculas for palabra in palabras_ocurriendo):
        return 'Ocurriendo'
    if any(palabra in texto_minusculas for palabra in palabras_ya_ocurrio):
        return 'Ya Ocurrió'
    
    return 'Indeterminado'

def aplicar_formato_excel(writer):
    """
    Aplica formato profesional a todas las hojas del archivo Excel generado.
    """
    wb = writer.book

    borde_delgado = Side(border_style="thin", color="000000")
    borde_grueso = Side(border_style="thick", color="000000")
    
    borde_completo = Border(left=borde_delgado, right=borde_delgado, top=borde_delgado, bottom=borde_delgado)
    borde_titulo_grueso = Border(left=borde_delgado, right=borde_delgado, top=borde_delgado, bottom=borde_delgado, outline=borde_grueso)

    alineacion_centro_ajuste = Alignment(horizontal='center', vertical='center', wrap_text=True)
    alineacion_izq_ajuste = Alignment(horizontal='left', vertical='center', wrap_text=True)

    formato_resultados = {
        'A': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'B': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'C': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'D': {'ancho': 91.00, 'alineacion': alineacion_izq_ajuste},
        'E': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'F': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'G': {'ancho': 30.00, 'alineacion': alineacion_izq_ajuste},
        'H': {'ancho': 20.29, 'alineacion': alineacion_centro_ajuste},
        'I': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'J': {'ancho': 35.00, 'alineacion': alineacion_izq_ajuste},
        'K': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'L': {'ancho': 13.15, 'alineacion': alineacion_centro_ajuste},
        'M': {'ancho': 30.00, 'alineacion': alineacion_centro_ajuste},
        'N': {'ancho': 15.00, 'alineacion': alineacion_centro_ajuste},
        'O': {'ancho': 10.00, 'alineacion': alineacion_centro_ajuste},
        'P': {'ancho': 14.00, 'alineacion': alineacion_centro_ajuste},
        'Q': {'ancho': 40.00, 'alineacion': alineacion_centro_ajuste},
        'R': {'ancho': 40.00, 'alineacion': alineacion_centro_ajuste},
        'S': {'ancho': 40.00, 'alineacion': alineacion_centro_ajuste},
        'T': {'ancho': 37.00, 'alineacion': alineacion_centro_ajuste},
        'U': {'ancho': 60.00, 'alineacion': alineacion_izq_ajuste},
        'V': {'ancho': 40.00, 'alineacion': alineacion_centro_ajuste},
        'W': {'ancho': 50.00, 'alineacion': alineacion_izq_ajuste},
        'X': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'Y': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'Z': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'AA': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
        'AB': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'AC': {'ancho': 20.00, 'alineacion': alineacion_centro_ajuste},
    }

    formato_investigacion = {
        'A': {'ancho': 23.00, 'alineacion': alineacion_centro_ajuste},
        'B': {'ancho': 29.00, 'alineacion': alineacion_centro_ajuste},
        'C': {'ancho': 25.00, 'alineacion': alineacion_centro_ajuste},
        'D': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'E': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'F': {'ancho': 80.00, 'alineacion': alineacion_izq_ajuste},
        'G': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'H': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'I': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'J': {'ancho': 26.00, 'alineacion': alineacion_centro_ajuste},
        'K': {'ancho': 26.15, 'alineacion': alineacion_centro_ajuste},
    }

    for hoja_nombre in wb.sheetnames:
        ws = wb[hoja_nombre]
        ws.sheet_view.showGridLines = False
        ws.freeze_panes = 'B2'

        max_fila = ws.max_row
        max_col_letra = get_column_letter(ws.max_column)
        rango_datos = f"A1:{max_col_letra}{max_fila}"

        for fila in ws[rango_datos]:
            for celda in fila:
                celda.border = borde_completo
                alineacion_actual = alineacion_centro_ajuste

                if hoja_nombre in ['Resultados', 'Priorización']:
                    col_letra = get_column_letter(celda.column)
                    if col_letra in formato_resultados:
                        alineacion_actual = formato_resultados[col_letra]['alineacion']
                
                if hoja_nombre == 'Investigación':
                    col_letra = get_column_letter(celda.column)
                    if col_letra in formato_investigacion:
                        alineacion_actual = formato_investigacion[col_letra]['alineacion']
                
                celda.alignment = Alignment(horizontal=alineacion_actual.horizontal, vertical='top', wrap_text=True)

        if hoja_nombre in ['Resultados', 'Priorización']:
            for col_letra, formato in formato_resultados.items():
                ws.column_dimensions[col_letra].width = formato['ancho']
        
        if hoja_nombre == 'Investigación':
            for col_letra, formato in formato_investigacion.items():
                ws.column_dimensions[col_letra].width = formato['ancho']

        for celda in ws['1']:
            celda.border = borde_titulo_grueso
            celda.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)

def normalizar_texto(texto):
    if isinstance(texto, str):
        texto = texto.lower()
        texto = unicodedata.normalize('NFKD', texto).encode('ascii', 'ignore').decode('utf-8')
        texto = re.sub(r'[^a-z0-9\s]', '', texto)
        return texto
    return ""

DICCIONARIO_LEMAS_RAW = {
    'FACTURA': ['facturacion', 'facturas', 'factura', 'facture', 'facturo', 'facturando', 'facturado', 'expide', 'emite', 'entregar recibo', 'dar recibo'],
    'COMPRA': ['adquisicion', 'adquiere', 'adquirio', 'adquiriendo', 'compras', 'compro', 'compre', 'comprando', 'comprado'],
    'VENDE': ['comercializa', 'comercio', 'ventas', 'vende', 'vendio', 'vendiendo', 'vendido'],
    'DECLARA': ['declaracion', 'declaraciones', 'declaro', 'declara', 'declarando', 'declarado', 'presenta', 'presento', 'presentar'],
    'PAGA': ['consigna', 'consignar', 'consignado', 'cancelar', 'cancela', 'cancelado', 'pagos', 'pago', 'pagado', 'pagando'],
    'CONTRABANDO': ['ilegal', 'clandestino', 'contrabando'],
    'OMISO': ['omiso', 'omision', 'omitio', 'no presento', 'no declaro', 'sin declarar', 'nunca declaro'],
    'IVA': ['impuesto sobre las ventas', 'valor agregado', 'iva'],
    'RENTA': ['impuesto de renta', 'renta'],
    'INGRESOS': ['entradas de dinero', 'plata', 'ingresos', 'ganancias', 'dinero recibido'],
    'EXTRANJERO': ['fuera del pais', 'internacional', 'exterior', 'extranjero'],
    'EXOGENA': ['medios magneticos', 'informacion exogena', 'reporte de informacion', 'exogena'],
    'RUT': ['registro unico tributario', 'rut'],
    'ACTIVOS': ['bienes', 'propiedades', 'activos', 'patrimonio'],
    'PASIVOS': ['deudas', 'obligaciones', 'pasivos', 'prestamos'],
    'FICTICIO': ['simulado', 'irreal', 'fachada', 'ficticio', 'falso', 'falsa'],
    'RETENCION': ['retefuente', 'retencion en la fuente', 'retencion'],
    'TIMBRE': ['impuesto de timbre', 'timbre']
}

PATRONES_LEMAS = []
for raiz, variaciones in DICCIONARIO_LEMAS_RAW.items():
    variaciones.sort(key=len, reverse=True)
    lista_regex = [re.escape(v) for v in variaciones]
    patron = re.compile(r'\b(' + '|'.join(lista_regex) + r')\b', re.IGNORECASE)
    PATRONES_LEMAS.append((patron, raiz))

def lematizar_artesanal(texto):
    if not texto: return ""
    texto_procesado = texto 
    for patron, raiz in PATRONES_LEMAS:
        texto_procesado = patron.sub(raiz, texto_procesado)
    return texto_procesado

def detectar_negacion_cercana(texto, termino, ventana=3):
    palabras_negacion = {'no', 'nunca', 'jamas', 'tampoco', 'sin', 'ni', 'ningun', 'ninguna', 'falso', 'niega'}
    tokens_texto = texto.split()
    tokens_termino = termino.split()
    
    if not tokens_termino: return False
    
    primera_palabra_clave = tokens_termino[0]
    len_termino = len(tokens_termino)
    indices = [i for i, x in enumerate(tokens_texto) if x == primera_palabra_clave]
    
    for i in indices:
        if tokens_texto[i:i+len_termino] == tokens_termino:
            if primera_palabra_clave in palabras_negacion: return False
            inicio_ventana = max(0, i - ventana)
            ventana_previa = tokens_texto[inicio_ventana:i]
            if any(neg in ventana_previa for neg in palabras_negacion):
                return True 
    return False

def es_similar(palabra1, palabra2, umbral=0.8):
    return SequenceMatcher(None, palabra1, palabra2).ratio() > umbral

def limpiar_identificacion(valor):
    if pd.isna(valor): return ""
    s = str(valor).strip()
    if s.endswith('.0'): s = s[:-2]
    s = re.sub(r'[.,\-\s]', '', s)
    return s.upper()

def generar_codigo_estadisticas(df):
    codigo = """
# -*- coding: utf-8 -*-
import pandas as pd
import matplotlib.pyplot as plt

RUTA_ARCHIVO = 'denuncias_procesadas.xlsx' 
NOMBRE_HOJA = 'Resultados' 

try:
    df = pd.read_excel(RUTA_ARCHIVO, sheet_name=NOMBRE_HOJA, engine='openpyxl')
except Exception as e:
    print(f"Error: {e}")
    exit()

print("\\n--- Análisis de Prioridad ---")
print(df['Prioritaria'].value_counts())

print("\\n--- Top 5 Conductas Sancionables ---")
conducta_counts = df['Conducta Sancionable'].value_counts().nlargest(5)
print(conducta_counts)
plt.figure(figsize=(10, 6))
conducta_counts.plot(kind='barh', color='#9C27B0')
plt.title('Top 5 Conductas Sancionables más Comunes')
plt.show()
    """
    return codigo

def seleccionar_modelo_ia(root):
    if 'ollama' not in globals() or ollama is None:
        return None

    modelos_disponibles = []
    try:
        cliente = ollama.Client(host='http://127.0.0.1:11434')
        respuesta = cliente.list()
        lista = respuesta.models if hasattr(respuesta, 'models') else respuesta.get('models', [])
        for m in lista:
            nombre = None
            if hasattr(m, 'model'): nombre = m.model
            elif hasattr(m, 'name'): nombre = m.name
            elif isinstance(m, dict): nombre = m.get('name', m.get('model', ''))
            
            if nombre: modelos_disponibles.append(nombre)
    except:
        pass

    if not modelos_disponibles:
        messagebox.showwarning("Atención", "No se detectaron modelos en Ollama.")
        return None

    ventana_ia = tk.Toplevel(root)
    ventana_ia.title("Selección de Modelo IA")
    ventana_ia.geometry("400x250")
    ventana_ia.attributes('-topmost', True) 
    ventana_ia.lift()
    ventana_ia.focus_force()
    ventana_ia.grab_set()
    
    seleccion = {"modelo": None}

    tk.Label(ventana_ia, text="CONEXIÓN EXITOSA", fg="green", font=("Arial", 10, "bold")).pack(pady=10)
    tk.Label(ventana_ia, text="Seleccione el modelo a utilizar:", font=("Arial", 11)).pack(pady=5)
    
    combo = ttk.Combobox(ventana_ia, values=modelos_disponibles, state="readonly", width=35)
    combo.pack(pady=10)
    if modelos_disponibles: combo.current(0)

    def confirmar():
        seleccion["modelo"] = combo.get()
        ventana_ia.destroy()

    def cancelar():
        seleccion["modelo"] = None
        ventana_ia.destroy()

    btn_frame = tk.Frame(ventana_ia)
    btn_frame.pack(pady=20)

    tk.Button(btn_frame, text="✅ EJECUTAR CON IA", command=confirmar, bg="#4CAF50", fg="white").pack(side=tk.LEFT, padx=10)
    tk.Button(btn_frame, text="❌ SOLO CÓDIGO", command=cancelar, bg="#f44336", fg="white").pack(side=tk.LEFT, padx=10)

    root.update()
    root.wait_window(ventana_ia)
    
    return seleccion["modelo"]

# --- NUEVA FUNCIÓN: Formatear reglas para el Prompt ---
def formatear_reglas_para_prompt(reglas):
    """
    Convierte las reglas y sus definiciones en texto para la IA.
    """
    texto = "REGLAS DE CONDUCTA SANCIONABLE (CON DEFINICIONES JURÍDICAS):\n"
    for regimen, contenido in reglas.items():
        texto += f"\n--- RÉGIMEN: {regimen} ---\n"
        for nombre_conducta, detalle in contenido['reglas'].items():
            
            # 1. Buscamos la definición en el diccionario global
            # Usamos nombre_conducta en minúsculas para asegurar coincidencia
            definicion = DEFINICIONES_CONDUCTAS.get(nombre_conducta.lower(), "Sin definición específica disponible.")
            
            palabras = ", ".join([str(p) for p in detalle.get('palabras_clave', [])])
            
            texto += f"- CONDUCTA: {nombre_conducta}\n"
            texto += f"  DEFINICIÓN: {definicion}\n" 
            texto += f"  Palabras Clave: {palabras}\n"
            texto += f"  Sanción: {detalle.get('Conducta Sancionable', '')}\n"
            texto += "  --------------------------------------------------\n"
            
    return texto

# --- NUEVA FUNCIÓN: Formatear lemas (sinónimos) para el Prompt ---
def formatear_lemas_para_prompt():
    texto = "GLOSARIO DE SINÓNIMOS (Para interpretar el hecho):\n"
    for raiz, lista in DICCIONARIO_LEMAS_RAW.items():
        texto += f"- Concepto '{raiz}' incluye: {', '.join(lista)}\n"
    return texto

def consultar_contexto_ia(texto, modelo, reglas_dict):
    """
    Envía el hecho denunciado a la IA incluyendo las reglas reales en el prompt.
    """
    if not modelo or not str(modelo).strip():
        return "Error: Modelo no definido.", []

    # 1. Convertir reglas a texto
    reglas_texto = formatear_reglas_para_prompt(reglas_dict)
    lemas_texto = formatear_lemas_para_prompt()

    # 2. Prompt modificado para INCLUIR las reglas
    prompt = f"""
    Actúa como un Auditor Fiscal Experto. Tienes prohibido usar conocimientos externos. Debes basarte EXCLUSIVAMENTE en las siguientes reglas proporcionadas.

    {lemas_texto}

    {reglas_texto}

    Hecho Denunciado: "{texto}"

    Instrucciones:
    1. Lee las "REGLAS DE CONDUCTA SANCIONABLE" anteriores.
    2. Analiza el "Hecho Denunciado" buscando coincidencias con esas reglas específicas.
    3. Si el hecho menciona explícitamente palabras clave de una regla, identifícala.
    4. Extrae los años fiscales mencionados.
    5. Si hay ambigüedad o falta de información o no se idenfica una conducta sancionable, inclínate por "No Clasificado".

    Responde ESTRICTAMENTE con este formato:
    LECTURA_IA:
    [Aquí tu análisis mencionando qué regla se cumple según el texto anterior]
    AÑOS: [Año1, Año2]
    """
    
    try:
        modelo_str = str(modelo).strip()
        cliente = ollama.Client(host='http://127.0.0.1:11434')
        
        response = cliente.chat(model=modelo_str, messages=[
            {'role': 'user', 'content': prompt},
        ])
        
        if not response or 'message' not in response:
            return "Error: Respuesta vacía", []

        respuesta = response['message']['content']
        
        contexto_extra = ""
        anios_extra = []
        
        import re
        match_lectura = re.search(r'LECTURA_IA:?(.*?)(?:AÑOS:|AÑOS_DETECTADOS:|$)', respuesta, re.DOTALL | re.IGNORECASE)
        if match_lectura:
            contexto_extra = match_lectura.group(1).strip()
        else:
            partes = re.split(r'AÑOS:|AÑOS_DETECTADOS:', respuesta, flags=re.IGNORECASE)
            contexto_extra = partes[0].strip()

        match_anios = re.search(r'(?:AÑOS:|AÑOS_DETECTADOS:)(.*)', respuesta, re.DOTALL | re.IGNORECASE)
        if match_anios:
            texto_anios = match_anios.group(1)
            anios_extra = re.findall(r'\b(20\d{2})\b', texto_anios)

        if not contexto_extra: contexto_extra = respuesta

        return contexto_extra, anios_extra

    except Exception as e:
        print(f"Error IA: {e}")
        return f"Error IA: {str(e)}", []


def repartir_denuncias(df, auditores):
    df['Prioritaria'] = pd.Categorical(df['Prioritaria'], categories=['Si', 'No'], ordered=True)
    df_reparto = df.sort_values(by=['Prioritaria'], ascending=[True])
    
    asignaciones = {auditor: [] for auditor in auditores.keys()}
    auditores_por_especialidad = {}
    for nombre, especialidad in auditores.items():
        if especialidad not in auditores_por_especialidad:
            auditores_por_especialidad[especialidad] = []
        auditores_por_especialidad[especialidad].append(nombre)
        
    contadores_especialidad = {esp: 0 for esp in auditores_por_especialidad.keys()}
    auditor_asignado_serie = pd.Series([''] * len(df), index=df.index)

    for index, row in df_reparto.iterrows():
        regimen_raw = str(row.get('Régimen', ''))
        if not regimen_raw or regimen_raw.lower() in ['nan', 'none', '', 'no clasificado']:
            regimenes_denuncia = ['Tributario'] 
        else:
            regimenes_denuncia = [r.strip() for r in regimen_raw.split('\n') if r.strip()]
            
        if not regimenes_denuncia: regimenes_denuncia = ['Tributario']
        regimenes_denuncia = list(set(regimenes_denuncia))
        
        auditores_seleccionados_fila = []

        for reg in regimenes_denuncia:
            reg_destino = reg if reg in auditores_por_especialidad else 'Tributario'
            grupo = auditores_por_especialidad.get(reg_destino)
            
            if grupo:
                idx = contadores_especialidad[reg_destino]
                auditor_elegido = grupo[idx]
                asignaciones[auditor_elegido].append(row)
                auditores_seleccionados_fila.append(auditor_elegido)
                contadores_especialidad[reg_destino] = (idx + 1) % len(grupo)
        
        auditor_asignado_serie[index] = '\n'.join(auditores_seleccionados_fila)

    df_asignaciones = {}
    for auditor, data in asignaciones.items():
        if data: df_asignaciones[auditor] = pd.DataFrame(data)
        else: df_asignaciones[auditor] = pd.DataFrame(columns=df.columns)

    return df_asignaciones, auditor_asignado_serie


def identificar_patrones_investigacion(df):
    patrones_investigacion = []
    df['Documento Denunciado'] = df['Documento Denunciado'].astype(str)
    df['Nombre/Razon Social Denunciado'] = df['Nombre/Razon Social Denunciado'].astype(str)
    df['Descripción de los Hechos_str'] = df['Descripción de los Hechos'].astype(str)
    df['Denunciado_Identificador'] = df['Documento Denunciado'] + " / " + df['Nombre/Razon Social Denunciado']
    
    identificador_a_denuncia_principal = {}
    for index, row in df.iterrows():
        identificador = row['Denunciado_Identificador']
        if identificador not in identificador_a_denuncia_principal:
            identificador_a_denuncia_principal[identificador] = {
                'Denuncia_Principal': row.to_dict(),
                'Menciones_Hechos': []
            }
        
    for index_mencion, row_mencion in df.iterrows():
        hechos_normalizados = normalizar_texto(row_mencion['Descripción de los Hechos_str'])
        
        for identificador, data in identificador_a_denuncia_principal.items():
            partes = identificador.split(' / ', 1)
            if len(partes) == 2: doc, nombre = partes
            else: doc, nombre = partes[0], "" 
            
            nombre_normalizado = normalizar_texto(nombre)
            patron_encontrado = ""
            
            if doc in hechos_normalizados:
                patron_encontrado = doc
            elif nombre and len(nombre) > 3 and nombre_normalizado in hechos_normalizados:
                 patron_encontrado = nombre 
            
            if patron_encontrado and row_mencion['Número Radicación'] != data['Denuncia_Principal']['Número Radicación']:
                mencion_data = row_mencion.to_dict()
                mencion_data['PATRÓN'] = patron_encontrado 
                data['Menciones_Hechos'].append(mencion_data)

    INVESTIGACION_COLS = ['TIPO_REGISTRO', 'DOCUMENTO_IDENTIFICADOR', 'NOMBRE_IDENTIFICADOR', 'PATRÓN', 'Número Radicación', 'Descripción de los Hechos', 'Régimen', 'Conducta Sancionable', 'Impuesto / Infracción', 'Año de Investigación', 'Prioritaria']
    investigacion_rows = []

    for identificador, data in identificador_a_denuncia_principal.items():
        if data['Menciones_Hechos']:
            principal = data['Denuncia_Principal']
            investigacion_rows.append({
                'TIPO_REGISTRO': 'PATRÓN ENCONTRADO (Principal)',
                'DOCUMENTO_IDENTIFICADOR': principal['Documento Denunciado'],
                'NOMBRE_IDENTIFICADOR': principal['Nombre/Razon Social Denunciado'],
                'PATRÓN': principal['Documento Denunciado'], 
                'Número Radicación': principal['Número Radicación'],
                'Descripción de los Hechos': principal['Descripción de los Hechos'],
                'Régimen': principal['Régimen'],
                'Conducta Sancionable': principal['Conducta Sancionable'],
                'Impuesto / Infracción': principal['Impuesto / Infracción'],
                'Año de Investigación': principal['Año de Investigación'],
                'Prioritaria': principal['Prioritaria']
            })
            
            menciones_df = pd.DataFrame(data['Menciones_Hechos'])
            menciones_df['Prioritaria'] = pd.Categorical(menciones_df['Prioritaria'], categories=['Si', 'No'], ordered=True)
            menciones_df = menciones_df.sort_values(by='Prioritaria', ascending=True)
            
            for _, mencion in menciones_df.iterrows():
                investigacion_rows.append({
                    'TIPO_REGISTRO': 'MENCIONADO EN HECHOS (Relacionada)',
                    'DOCUMENTO_IDENTIFICADOR': mencion['Documento Denunciado'], 
                    'NOMBRE_IDENTIFICADOR': mencion['Nombre/Razon Social Denunciado'],
                    'PATRÓN': mencion['PATRÓN'], 
                    'Número Radicación': mencion['Número Radicación'],
                    'Descripción de los Hechos': mencion['Descripción de los Hechos'],
                    'Régimen': mencion['Régimen'],
                    'Conducta Sancionable': mencion['Conducta Sancionable'],
                    'Impuesto / Infracción': mencion['Impuesto / Infracción'],
                    'Año de Investigación': mencion['Año de Investigación'],
                    'Prioritaria': mencion['Prioritaria']
                })
            
            investigacion_rows.append({col: '' for col in INVESTIGACION_COLS}) 
    
    df_investigacion = pd.DataFrame(investigacion_rows, columns=INVESTIGACION_COLS)
    return df_investigacion


def procesar_denuncias(ruta_archivo_entrada, ruta_archivo_salida, ruta_archivo_beneficio):
    print("DEBUG: Iniciando bloque de selección de IA...")
    modelo_seleccionado = None
    usar_ia = False

    try:
        root_selector = tk.Tk()
        root_selector.withdraw() 
        root_selector.update()
        modelo_seleccionado = seleccionar_modelo_ia(root_selector)
        root_selector.quit()
        root_selector.destroy() 
        
        usar_ia = True if modelo_seleccionado else False
        if usar_ia: print(f"\n>>> MODO IA ACTIVADO: Modelo '{modelo_seleccionado}' <<<\n")
        else: print("\n>>> MODO ESTÁNDAR: Ejecución sin IA <<<\n")

    except Exception as e:
        print(f"Error CRÍTICO al abrir selector: {e}")
        usar_ia = False

    AUDITORES = {
        'Anyela Rodriguez': 'Tributario',
        'Ruth Peña': 'Tributario',
        'Lorena Bohorquez': 'Tributario',
        'Gloria Tamayo': 'Tributario',
        'Ana Castellanos': 'Tributario',
        'Rafael Ordoñez': 'Tributario',
        'Olga Medina': 'Aduanero',
        'Carlos Rubiano': 'Aduanero',
        'Jefferson Romero': 'Tributario',
        'Juan Turriago': 'Tributario',
        'Maria Franco': 'Tributario',
        'Juan Clavijo': 'Tributario',
        'Juan Franco': 'Tributario',
        'Lina Ceballos': 'Tributario',
        'Jose Uribe': 'Tributario',
        'Javier Chacon': 'Tributario',
        'Carlos Martinez': 'Tributario',
        'Auditor 1': 'Cambiario',
    }

    REGLAS_ANIDADAS = {
        'Reportado sin vinculo comercial en exogena por terceros': {
            'Regimen': 'Tributario',
            'Conducta': 'Obligaciones diferentes a declarar y pagar',
            'Conducta Sancionable': 'Incluye costos no procedentes',
            'Impuesto / Infracción': 'Renta y Complementarios',
            'Normatividad': 'Art. 631 E.T. / Art. 107 E.T.',
            'Puntos de Auditoria': 'Verificación de costos y deducciones por honorarios no causados.'
        }, 
        'No factura': {
            'Regimen': 'Tributario',
            'Conducta': 'Facturación',
            'Conducta Sancionable': 'Omite Ingresos',
            'Impuesto / Infracción': 'Renta y Complementarios',
            'Normatividad': 'Art. 657 E.T. / Art. 647 E.T.',
            'Puntos de Auditoria': 'Verificación de ingresos reportados vs. reportados por terceros.'
        }
    }

    beneficio_map = {}
    if ruta_archivo_beneficio:
        try:
            df_beneficio = pd.read_excel(ruta_archivo_beneficio, engine='openpyxl')
            col_nit = 'NIT'
            if 'NIT' not in df_beneficio.columns:
                for col in df_beneficio.columns:
                    if 'nit' in str(col).lower(): col_nit = col; break
            
            col_direccion = None
            for col in df_beneficio.columns:
                col_norm = normalizar_texto(str(col))
                if 'direccion' in col_norm and 'seccional' in col_norm: col_direccion = col; break
            
            for _, row_ben in df_beneficio.iterrows():
                nit_raw = row_ben.get(col_nit, '')
                nit_limpio = limpiar_identificacion(nit_raw)
                
                if nit_limpio:
                    anio_gravable = str(row_ben.get('Año gravable', '')).strip()
                    if anio_gravable.endswith('.0'): anio_gravable = anio_gravable[:-2]

                    raw_presentacion = str(row_ben.get('Fecha de presentación año actual', '')).strip()
                    if raw_presentacion.endswith('.0'): raw_presentacion = raw_presentacion[:-2]
                    
                    if len(raw_presentacion) == 8 and raw_presentacion.isdigit():
                        fecha_presentacion = f"{raw_presentacion[:4]}-{raw_presentacion[4:6]}-{raw_presentacion[6:]}"
                    else: fecha_presentacion = raw_presentacion.split(' ')[0]

                    fecha_firmeza = str(row_ben.get('Fecha de firmeza', '')).strip()
                    if fecha_firmeza.endswith('.0'): fecha_firmeza = fecha_firmeza[:-2]
                    fecha_firmeza = fecha_firmeza.split(' ')[0]

                    dir_seccional = str(row_ben.get(col_direccion, '')) if col_direccion else ''
                    texto_dato = f"{anio_gravable}\nPresentada: {fecha_presentacion}"
                    
                    if nit_limpio not in beneficio_map: beneficio_map[nit_limpio] = {}
                    beneficio_map[nit_limpio][anio_gravable] = {'texto': texto_dato, 'firmeza': fecha_firmeza, 'direccion': dir_seccional, 'existe': True}
                
        except Exception as e:
            print(f"Advertencia: No se pudo cargar Beneficio: {e}")

    try:
        df = pd.read_excel(ruta_archivo_entrada, engine='openpyxl', dtype={'Fecha Hechos': str})
        df.columns = df.columns.str.strip()
        if 'Documento Denunciado' not in df.columns:
            for col in df.columns:
                if 'documento' in str(col).lower() and 'denunciado' in str(col).lower():
                    df.rename(columns={col: 'Documento Denunciado'}, inplace=True); break
    except Exception as e:
        print(f"❌ ERROR CRÍTICO AL LEER EL ARCHIVO: {e}"); return

    # --- Optimización de reglas (Pre-procesamiento) ---
    reglas_optimizadas = []
    for reg_nom, data in reglas_conclusion.items():
        for key, rules in data['reglas'].items():
            key_procesada = lematizar_artesanal(normalizar_texto(key))
            determinantes_proc = [lematizar_artesanal(normalizar_texto(p)) for p in rules.get('palabras_determinantes', [])]
            contexto_proc = [lematizar_artesanal(normalizar_texto(p)) for p in rules.get('palabras_contexto', [])]
            legacy_proc = []
            
            raw_legacy = rules.get('palabras_clave', [])
            lista_legacy_temp = []
            if raw_legacy:
                for item in raw_legacy:
                    if isinstance(item, set): lista_legacy_temp.extend(list(item))
                    else: lista_legacy_temp.append(item)
            
            for item in lista_legacy_temp:
                legacy_proc.append(lematizar_artesanal(normalizar_texto(item)))

            reglas_optimizadas.append({
                'Regimen': reg_nom,
                'Key_Lema': key_procesada,
                'Determinantes': determinantes_proc,
                'Contexto': contexto_proc,
                'Legacy': legacy_proc,
                'Regex': [re.compile(p, re.IGNORECASE) for p in rules.get('patrones_regex', [])], 
                'Negativas': [normalizar_texto(n) for n in rules.get('palabras_negativas', [])],
                'Refuerzo': [normalizar_texto(r) for r in rules.get('palabras_refuerzo', [])],
                'DataOriginal': rules
            })

    columnas_nuevas = ['Año de Investigación', 'Conclusión', 'Auditor', 'Normatividad', 'Puntos de Auditoria', 'Lavado de Activos', 'Dirección Seccional', 'Beneficio Auditoria', 'Año Beneficio Auditoria', 'Fecha Firmeza','Lectura IA']
    for col in columnas_nuevas: df[col] = ''

    # --- TEMPORIZADOR: INICIO ---
    inicio_procesamiento = time.time()

    # --- CACHE IA ---
    cache_ia_respuestas = {}  # Diccionario para almacenar respuestas por texto de hechos

    for index, row in df.iterrows():
        print(f"--> Procesando Fila {index + 1}...", flush=True)
        descripcion_hechos = str(row.get('Descripción de los Hechos', ''))
        # Normalizamos un poco para evitar diferencias por espacios
        descripcion_clave = descripcion_hechos.strip() 

        contexto_ia = ""
        anios_ia = []
        forzar_no_clasificado = False # Bandera para controlar la decisión de la IA
        
        # --- A. CONSULTA A LA IA CON INYECCIÓN DE REGLAS ---
        if usar_ia:
            try:
                # Verificar si ya analizamos este texto exacto
                if descripcion_clave in cache_ia_respuestas:
                    print(f"    (Usando respuesta en caché para texto repetido)")
                    ctx, anios = cache_ia_respuestas[descripcion_clave]
                else:
                    # AQUÍ ESTÁ EL CAMBIO PRINCIPAL: Se pasan las reglas_conclusion
                    ctx, anios = consultar_contexto_ia(descripcion_hechos, modelo_seleccionado, reglas_conclusion)
                    # Guardamos en caché
                    cache_ia_respuestas[descripcion_clave] = (ctx, anios)

                contexto_ia = " " + ctx 
                anios_ia = anios
                df.at[index, 'Lectura IA'] = ctx

                # --- NUEVA LÓGICA DE VETO DE IA ---
                # Si la IA dice explícitamente "No Clasificado" o frases similares, activamos la bandera
                ctx_lower = ctx.lower()
                frases_veto = [
                    "no clasificado",
                    "no se identifica conducta",
                    "sin conducta sancionable",
                    "no se puede asegurar una coincidencia",
                    "no coincide con ninguna regla",
                    "falta de información",
                    "falta de detalles",
                    "no es posible determinar",
                    "no se observan hechos",
                    "no cumple con los requisitos"
                ]
                
                if any(frase in ctx_lower for frase in frases_veto):
                    forzar_no_clasificado = True

            except Exception as e:
                print(f"Advertencia fila {index}: Falló la IA. Error: {e}")

        # --- B. AÑO ---
        anho_valido = set()
        for a in anios_ia:
            if 2018 <= int(a) <= 2100: anho_valido.add(str(a))

        descripcion_normalizada_lower = descripcion_hechos.lower()
        fecha_radicacion_str = str(row.get('Fecha Radicación', ''))
        anho_radicacion = None
        if pd.notna(fecha_radicacion_str) and fecha_radicacion_str.strip():
            try:
                fr = pd.to_datetime(fecha_radicacion_str, dayfirst=True, errors='coerce')
                if pd.notna(fr): anho_radicacion = fr.year
            except: pass

        for anho in re.findall(r'\b(20\d{2})\b', descripcion_hechos):
            if 2018 <= int(anho) <= 2100: anho_valido.add(anho)

        if anho_radicacion:
            if "desde el año pasado" in descripcion_normalizada_lower: anho_valido.add(str(anho_radicacion - 1))
            numeros_txt = {'uno': 1, 'dos': 2, 'tres': 3, 'cuatro': 4, 'cinco': 5}
            for match_x in re.findall(r'(?:desde\s+)?hace\s+(\d+|[a-zA-Z]+)\s+años', descripcion_normalizada_lower):
                try: val = int(match_x)
                except: val = numeros_txt.get(match_x, 0)
                if val > 0:
                    start = anho_radicacion - val
                    limit = max(anho_radicacion - 5, 2018)
                    for y in range(start, anho_radicacion + 1):
                        if y >= limit: anho_valido.add(str(y))

        if not anho_valido:
            fh_str = str(row.get('Fecha Hechos', ''))
            if pd.notna(fh_str) and fh_str.strip():
                fh = pd.to_datetime(fh_str, dayfirst=True, errors='coerce')
                if pd.notna(fh): anho_valido.add(str(fh.year))

        anho_investigacion = ', '.join(sorted(list(anho_valido))) if anho_valido else 'No determinado'
        prioridad = 'Si' if anho_valido and any(int(a) <= datetime.now().year - 2 for a in anho_valido) else 'No'

        df.at[index, 'Año de Investigación'] = anho_investigacion
        df.at[index, 'Prioritaria'] = prioridad

        # --- C. CLASIFICACIÓN ---
        matches = []

        # Solo ejecutamos el buscador de palabras clave si la IA NO lo vetó
        if not forzar_no_clasificado:
            # CORRECCIÓN: Usamos el texto original MÁS lo que dijo la IA.
            # Antes solo usabas contexto_ia, borrando el hecho original.
            texto_completo = descripcion_hechos + " " + contexto_ia

            desc_norm = normalizar_texto(texto_completo)
            desc_lema = lematizar_artesanal(desc_norm)
            
            PESOS = {'patron_regex': 60, 'determinantes': 50, 'exacta': 40, 'contexto': 15, 'legacy': 10}

            for regla in reglas_optimizadas:
                puntos = 0
                if any(neg in desc_norm for neg in regla['Negativas']): continue
                if regla['Key_Lema'] in desc_lema and not detectar_negacion_cercana(desc_lema, regla['Key_Lema']): puntos += PESOS['exacta']
                for item in regla['Determinantes']:
                    if item in desc_lema and not detectar_negacion_cercana(desc_lema, item): puntos += PESOS['determinantes']
                for item in regla['Contexto']:
                    if item in desc_lema and not detectar_negacion_cercana(desc_lema, item): puntos += PESOS['contexto']
                for item in regla['Legacy']:
                    if item in desc_lema and not detectar_negacion_cercana(desc_lema, item): puntos += PESOS['legacy']
                for patron in regla['Regex']:
                    if patron.search(desc_lema): puntos += PESOS['patron_regex']
                
                bono = 50 if any(ref in desc_norm for ref in regla['Refuerzo']) else 0

                if puntos > 0:
                    datos_orig = regla['DataOriginal']
                    matches.append({
                        'Puntaje': puntos + bono,
                        'Regimen': regla['Regimen'],
                        'Conducta': datos_orig['Conducta'],
                        'Conducta Sancionable': datos_orig['Conducta Sancionable'],
                        'Impuesto / Infracción': datos_orig['Impuesto / Infracción'],
                        'Normatividad': datos_orig.get('Normatividad', 'N/A'),
                        'Puntos de Auditoria': datos_orig.get('Puntos de Auditoria', 'N/A')
                    })

            EXCLUSION = {
                'no declara regimen simple de tributacion': ['no declara renta', 'no declara iva', 'no declara impuesto al consumo'],
                'no esta inscrito en el rut': ['no declara renta', 'no declara iva'],
                'evade impuestos': ['inexactitud declaracion ingresos y patrimonio'],
                'contrabando abierto': ['no factura']
            }
            eliminar = set()
            for m in matches:
                if m['Puntaje'] >= 40 and m['Conducta Sancionable'] in EXCLUSION:
                    eliminar.update(EXCLUSION[m['Conducta Sancionable']])
            matches = [m for m in matches if m['Conducta Sancionable'] not in eliminar]

        finales = []
        if matches:
            max_p = max(m['Puntaje'] for m in matches)
            umbral = max_p * 0.10
            base = [m for m in matches if m['Puntaje'] >= umbral]
            seen = set()
            for m in base:
                k = (m['Regimen'], m['Conducta Sancionable'])
                if k not in seen: finales.append(m); seen.add(k)
        
        if finales and max_p >= 10:
            for princ, aux in REGLAS_ANIDADAS.items():
                if any(m['Conducta Sancionable'] == princ for m in finales) and not any(m['Conducta Sancionable'] == aux['Conducta Sancionable'] for m in finales):
                    finales.insert(1, aux) 
        
        conclusiones_encontradas = finales 

        cols_borrar = ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria']
        for c in cols_borrar: df.at[index, c] = 'No Clasificado' if 'Normatividad' not in c else 'N/A'

        if finales:
            df.at[index, 'Régimen'] = '\n'.join(pd.Series([m['Regimen'] for m in finales]).unique())
            df.at[index, 'Conducta'] = '\n'.join(pd.Series([m['Conducta'] for m in finales]).unique())
            df.at[index, 'Conducta Sancionable'] = '\n'.join(pd.Series([m['Conducta Sancionable'] for m in finales]).unique())
            df.at[index, 'Impuesto / Infracción'] = '\n'.join(pd.Series([m['Impuesto / Infracción'] for m in finales]).unique())
            df.at[index, 'Normatividad'] = '\n'.join(pd.Series([m['Normatividad'] for m in finales]).unique())
            df.at[index, 'Puntos de Auditoria'] = '\n'.join(pd.Series([m['Puntos de Auditoria'] for m in finales]).unique())
            
            txts = [f"régimen [{m['Regimen']}] conducta [{m['Conducta']}]" for m in finales]
            df.at[index, 'Conclusión'] = f"Se detectaron: {' | '.join(txts)}. Vigencias: [{anho_investigacion}]"
        else:
            df.at[index, 'Conclusión'] = "No se encontraron infracciones clasificables."

        es_lavado = any(x in desc_norm for x in ["lavado de activo", "lava activos", "lavado"])
        df.at[index, 'Lavado de Activos'] = 'SI' if es_lavado else 'NO'

        doc_raw = limpiar_identificacion(row.get('Documento Denunciado', ''))
        ben_info = {'ben': [], 'anio': [], 'firm': [], 'dir': []}
        if doc_raw in beneficio_map:
            for y in anho_investigacion.split(','):
                y = y.strip()
                if y in beneficio_map[doc_raw]:
                    d = beneficio_map[doc_raw][y]
                    ben_info['ben'].append('SI'); ben_info['anio'].append(d['texto'])
                    ben_info['firm'].append(d['firmeza']); ben_info['dir'].append(d['direccion'])
        
        if ben_info['ben']:
            df.at[index, 'Beneficio Auditoria'] = '\n'.join(ben_info['ben'])
            df.at[index, 'Año Beneficio Auditoria'] = '\n'.join(ben_info['anio'])
            df.at[index, 'Fecha Firmeza'] = '\n'.join(ben_info['firm'])
            df.at[index, 'Dirección Seccional'] = '\n'.join(list(set(filter(None, ben_info['dir']))))
        else:
            df.at[index, 'Beneficio Auditoria'] = 'NO' if ruta_archivo_beneficio else ''   

        if conclusiones_encontradas:
            conclusion_texto_list = []
            for match in conclusiones_encontradas:
                conclusion_texto_list.append(
                    f"régimen [{match['Regimen']}] por la conducta de [{match['Conducta']}] "
                    f"y conducta sancionable [{match['Conducta Sancionable']}] por el impuesto o infracción "
                    f"[{match['Impuesto / Infracción']}]"
                )

            conclusion_final = (
                f"Según radicado {row.get('Número Radicación', 'N/A')} de fecha {row.get('Fecha Radicación', 'N/A')}, "
                f"el contribuyente denunciado {row.get('Nombre/Razon Social Denunciado', 'N/A')} "
                f"identificado con tipo de documento {row.get('Tipo Documento Denunciado', 'N/A')} "
                f"número {row.get('Documento Denunciado', 'N/A')}, ubicado en la ciudad de {row.get('Ciudad', 'N/A')} "
                f"en el departamento de {row.get('Departamento', 'N/A')}, es denunciado por infringir el "
                f"{' y también por '.join(conclusion_texto_list)}, por la(s) vigencia(s) fiscal(es) [{anho_investigacion}]"
            )

            df.at[index, 'Conclusión'] = conclusion_final
        else:
            df.at[index, 'Conclusión'] = "No se encontraron infracciones clasificables."
    
    # --- TEMPORIZADOR: FIN ---
    fin_procesamiento = time.time()
    tiempo_total = fin_procesamiento - inicio_procesamiento
    print(f"\n========================================================")
    print(f" PROCESAMIENTO COMPLETADO")
    print(f" Tiempo total: {int(tiempo_total // 60)} min {int(tiempo_total % 60)} seg")
    print(f"========================================================\n")

    df_asignaciones, auditor_asignado_serie = repartir_denuncias(df.copy(), AUDITORES)
    df['Auditor'] = auditor_asignado_serie
    
    columnas_fijas = ['Prioritaria', 'Año de Investigación', 'Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria', 'Dirección Seccional', 'Beneficio Auditoria', 'Año Beneficio Auditoria','Fecha Firmeza', 'Lavado de Activos']
    columnas_ordenadas_final = [col for col in df.columns if col not in columnas_fijas and col not in ['Conclusión', 'Auditor', 'Normatividad', 'Puntos de Auditoria']]
    
    columnas_ordenadas_final_con_data = []
    for col in df.columns:
        if col not in ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria', 'Conclusión', 'Auditor', 'Lectura IA']:
            columnas_ordenadas_final_con_data.append(col)
        if col == 'Descripción de los Hechos': columnas_ordenadas_final_con_data.append('Lectura IA')    
        if col == 'Año de Investigación': columnas_ordenadas_final_con_data.extend(['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción'])
        if col == 'Conclusión':
            columnas_ordenadas_final_con_data.append('Conclusión')
            columnas_ordenadas_final_con_data.extend(['Normatividad', 'Puntos de Auditoria','Dirección Seccional', 'Beneficio Auditoria', 'Año Beneficio Auditoria', 'Fecha Firmeza', 'Lavado de Activos', 'Auditor'])
    
    final_order = list(dict.fromkeys(columnas_ordenadas_final_con_data))
    df = df[final_order]

    codigo_estadisticas = generar_codigo_estadisticas(df)
    
    df_prioridad = df['Prioritaria'].value_counts().rename_axis('Prioritaria').reset_index(name='Cantidad')
    df_regimen = df['Régimen'].apply(lambda x: x.split('\n')[0]).value_counts().rename_axis('Régimen').reset_index(name='Cantidad')
    df_conducta_top = df['Conducta Sancionable'].apply(lambda x: x.split('\n')[0]).value_counts().nlargest(10).rename_axis('Conducta Sancionable').reset_index(name='Cantidad')
    años = df['Año de Investigación'].astype(str).str.split(', ').explode()
    df_años = años[años != 'No determinado'].value_counts().rename_axis('Año Fiscal').reset_index(name='Cantidad').sort_values('Año Fiscal')

    filas_priorizacion = []
    cols_priorizacion = df.columns.tolist() 
    anho_actual_sistema = datetime.now().year

    for _, row in df.iterrows():
        val_anio = row['Año de Investigación']
        anios_investigacion_str = str(val_anio).strip() if pd.notna(val_anio) else ""
        doc_limpio = limpiar_identificacion(row.get('Documento Denunciado', ''))
        lista_anios = [a.strip() for a in anios_investigacion_str.split(',') if a.strip()] if anios_investigacion_str and anios_investigacion_str.lower() not in ['no determinado', 'nan', 'none', ''] else [anios_investigacion_str]

        for anio_inv in lista_anios:
            nueva_fila = row.to_dict()
            nueva_fila['Año de Investigación'] = anio_inv
            nueva_prioridad = 'No'
            if anio_inv.isdigit():
                if int(anio_inv) <= anho_actual_sistema - 2: nueva_prioridad = 'Si'
            nueva_fila['Prioritaria'] = nueva_prioridad

            ben_aud = 'NO'; anio_ben_aud = ''; firmeza = ''; dir_seccional = ''
            if doc_limpio and beneficio_map and doc_limpio in beneficio_map:
                clave_anio = str(anio_inv).strip()
                if clave_anio in beneficio_map[doc_limpio]:
                    data_anio = beneficio_map[doc_limpio][clave_anio]
                    ben_aud = 'SI'; anio_ben_aud = data_anio['texto']; firmeza = data_anio['firmeza']; dir_seccional = data_anio.get('direccion', '') 
            
            nueva_fila['Beneficio Auditoria'] = ben_aud
            nueva_fila['Año Beneficio Auditoria'] = anio_ben_aud
            nueva_fila['Fecha Firmeza'] = firmeza
            nueva_fila['Dirección Seccional'] = dir_seccional if ben_aud == 'SI' else ''
            filas_priorizacion.append(nueva_fila)
            
    df_priorizacion = pd.DataFrame(filas_priorizacion)
    if df_priorizacion.empty: df_priorizacion = pd.DataFrame(columns=cols_priorizacion)
    else: df_priorizacion = df_priorizacion[cols_priorizacion]
                
    try:    
        writer = pd.ExcelWriter(ruta_archivo_salida, engine='openpyxl')    
        df.to_excel(writer, sheet_name='Resultados', index=False)
        df_priorizacion.to_excel(writer, sheet_name='Priorización', index=False)
        
        fila_inicio = 0
        df_prioridad.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_prioridad) + 2
        pd.DataFrame({'TITULO': ['Distribución por Régimen']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_regimen.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_regimen) + 2
        pd.DataFrame({'TITULO': ['Top 10 Conductas Sancionables']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_conducta_top.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += len(df_conducta_top) + 2
        pd.DataFrame({'TITULO': ['Distribución por Año Fiscal']}).to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        fila_inicio += 1
        df_años.to_excel(writer, sheet_name='Estadísticas', startrow=fila_inicio, index=False)
        
        df_codigo = pd.DataFrame({'Código Python para Gráficas (Ejecutar localmente)': [codigo_estadisticas]})
        df_codigo.to_excel(writer, sheet_name='Estadísticas', startrow=0, startcol=4, index=False)

        df_investigacion = identificar_patrones_investigacion(df.copy())
        if not df_investigacion.empty: df_investigacion.to_excel(writer, sheet_name='Investigación', index=False)
        else: pd.DataFrame({'Mensaje': ['No se encontraron patrones de investigación ampliados.']}).to_excel(writer, sheet_name='Investigación', index=False)

        for auditor_nombre in sorted(df_asignaciones.keys()):
            df_auditor = df_asignaciones[auditor_nombre].drop(columns=['index'], errors='ignore')
            cols_clasificacion_auditor = ['Régimen', 'Conducta', 'Conducta Sancionable', 'Impuesto / Infracción', 'Normatividad', 'Puntos de Auditoria']
            current_cols = [col for col in df_auditor.columns if col not in cols_clasificacion_auditor]
            idx_impuesto = current_cols.index('Impuesto / Infracción') if 'Impuesto / Infracción' in current_cols else len(current_cols)
            final_cols_auditor = current_cols[:idx_impuesto + 1] + ['Normatividad', 'Puntos de Auditoria'] + current_cols[idx_impuesto + 1:]
            final_cols_auditor = list(dict.fromkeys(final_cols_auditor))
            df_auditor = df_auditor[final_cols_auditor]
            df_auditor.to_excel(writer, sheet_name=auditor_nombre, index=False)
            
        aplicar_formato_excel(writer)
        writer.close()
        print(f"El archivo se guardó en: {ruta_archivo_salida}")

    except FileNotFoundError: print(f"Error: El archivo '{ruta_archivo_entrada}' no se encontró.")
    except Exception as e: print(f"Ocurrió un error inesperado: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    root.withdraw() 
    root.attributes('-topmost', True) 

    print("Abriendo ventana para seleccionar el archivo de DENUNCIAS...")
    ruta_archivo_entrada = filedialog.askopenfilename(parent=root, title="Seleccione el archivo de DENUNCIAS", filetypes=[("Archivos de Excel", "*.xlsx *.xls")])

    if not ruta_archivo_entrada:
        print("Operación cancelada.")
        root.destroy()
    else:
        print(f"Archivo: {os.path.basename(ruta_archivo_entrada)}")
        realizar_cruce = messagebox.askyesno("Cruce de Información", "¿Desea realizar el cruce de información con Beneficio de Auditoría?", parent=root)
        
        ruta_archivo_beneficio = None
        if realizar_cruce:
            ruta_archivo_beneficio = filedialog.askopenfilename(parent=root, title="Seleccione el archivo de BENEFICIO DE AUDITORIA", filetypes=[("Archivos de Excel", "*.xlsx *.xls")])
        
        root.destroy()
        directorio_base = os.path.dirname(ruta_archivo_entrada)
        ruta_archivo_salida = os.path.join(directorio_base, "denuncias_procesadas.xlsx")
        procesar_denuncias(ruta_archivo_entrada, ruta_archivo_salida, ruta_archivo_beneficio)
